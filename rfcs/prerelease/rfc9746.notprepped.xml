<?xml version='1.0' encoding='UTF-8'?>

<!DOCTYPE rfc [
  <!ENTITY nbsp    "&#160;">
  <!ENTITY zwsp   "&#8203;">
  <!ENTITY nbhy   "&#8209;">
  <!ENTITY wj     "&#8288;">
]>


<rfc xmlns:xi="http://www.w3.org/2001/XInclude" category="std" docName="draft-ietf-bess-evpn-mh-split-horizon-11" number="9746" ipr="trust200902" consensus="true" submissionType="IETF" updates="7432, 8365" obsoletes="" xml:lang="en" tocInclude="true" tocDepth="3" symRefs="true" sortRefs="true" version="3">

  <front>
    <title abbrev="EVPN MH Split-Horizon Extensions">BGP EVPN Multihoming
    Extensions for Split-Horizon Filtering</title>
    <seriesInfo name="RFC" value="9746"/>
    <author fullname="Jorge Rabadan" initials="J." role="editor" surname="Rabadan">
      <organization>Nokia</organization>
      <address>
        <postal>
          <street>520 Almanor Avenue</street>
          <city>Sunnyvale</city>
          <region>CA</region>
          <code>94085</code>
          <country>United States of America</country>
        </postal>
        <email>jorge.rabadan@nokia.com</email>
      </address>
    </author>
    <author fullname="Kiran Nagaraj" initials="K." surname="Nagaraj">
      <organization>Nokia</organization>
      <address>
        <postal>
          <street>520 Almanor Avenue</street>
          <city>Sunnyvale</city>
          <region>CA</region>
          <code>94085</code>
          <country>United States of America</country>
        </postal>
        <email>kiran.nagaraj@nokia.com</email>
      </address>
    </author>
    <author fullname="Wen Lin" initials="W." surname="Lin">
      <organization abbrev="Juniper">Juniper Networks</organization>
      <address>
        <email>wlin@juniper.net</email>
      </address>
    </author>
    <author fullname="Ali Sajassi" initials="A." surname="Sajassi">
      <organization abbrev="Cisco">Cisco Systems, Inc.</organization>
      <address>
        <email>sajassi@cisco.com</email>
      </address>
    </author>
    <date month="March" year="2025"/>
    <area>RTG</area>
    <workgroup>bess</workgroup>


<keyword>EVPN Multihoming</keyword>
<keyword>split-horizon filtering</keyword>
<keyword>split horizon filtering</keyword>
<keyword>local bias</keyword>
<keyword>ESI</keyword>
<keyword>encapsulations</keyword>
<keyword>SHT</keyword>

    <abstract>
      <t>An Ethernet Virtual Private Network (EVPN) is commonly used with
      Network Virtualization Overlay (NVO) tunnels as well as with MPLS and
      Segment Routing (SR) tunnels. The multihoming procedures in EVPN may
      vary based on the type of tunnel used within the EVPN Broadcast
      Domain. Specifically, there are two multihoming split-horizon procedures
      designed to prevent looped frames on multihomed Customer Edge (CE)
      devices: the Ethernet Segment Identifier (ESI) Label-based procedure and
      the local-bias procedure. The ESI Label-based split-horizon procedure is
      applied to MPLS-based tunnels such as MPLS over UDP (MPLSoUDP), while
      the local-bias procedure is used for other tunnels such as Virtual
      eXtensible Local Area Network (VXLAN) tunnels.</t>

      <t>Current specifications do not allow operators to choose which split-horizon procedure to use for tunnel encapsulations that support both
      methods. Examples of tunnels that may support both procedures include
      MPLSoUDP, MPLS over GRE (MPLSoGRE), Generic Network Virtualization
      Encapsulation (Geneve), and Segment Routing over IPv6 (SRv6)
      tunnels. This document updates the EVPN multihoming procedures described
      in RFCs 7432 and 8365, enabling operators to select the split-horizon
      procedure that meets their specific requirements.</t>
    </abstract>
  </front>
  <middle>
    <section anchor="sect-1" numbered="true" toc="default">
      <name>Introduction</name>
      <t>Ethernet Virtual Private Networks (EVPNs) are commonly used with the
      following tunnel encapsulations:</t>
      <ul spacing="normal">
        <li>
          <t>Network Virtualization Overlay (NVO) tunnels, where the EVPN
          procedures are specified in <xref target="RFC8365"
          format="default"/>.  MPLSoGRE <xref target="RFC4023"
          format="default"/>, MPLSoUDP <xref target="RFC7510"
          format="default"/>, Geneve <xref target="RFC8926" format="default"/>,
          or VXLAN <xref target="RFC7348" format="default"/> tunnels are
          considered NVO tunnels.</t>
        </li>

        <li>
          <t>MPLS and Segment Routing over MPLS (SR-MPLS) tunnels, where the
          relevant EVPN procedures are specified in <xref target="RFC7432"
          format="default"/>. SR-MPLS tunneling is specified in <xref
          target="RFC8660" format="default"/>.</t>
        </li>
        <li>
          <t>Segment Routing over IPv6 (SRv6) tunnels, where the relevant EVPN
          procedures are specified in <xref target="RFC9252"
          format="default"/>. SRv6 is specified in <xref target="RFC8402"
          format="default"/> and <xref target="RFC8754"
          format="default"/>.</t>
        </li>
      </ul>
      <t>In this document, the term "split horizon" follows the definition in <xref
      target="RFC7432" format="default"/>. Split horizon refers to the EVPN
      multihoming procedure that prevents a Provider Edge (PE) from sending a
      frame back to a multihomed Customer Edge (CE) when that CE originated
      the frame in the first place.</t>

      <t>EVPN multihoming procedures may vary depending on the type of tunnel
      utilized within the EVPN Broadcast Domain. Specifically, there are two
      multihoming split-horizon procedures employed to prevent looped frames
      on multihomed CE devices: the ESI Label-based procedure and the local-bias procedure.</t>

      <t>The ESI Label-based split-horizon procedure is used for MPLS or
      MPLS over X (MPLSoX) tunnels, such as MPLSoUDP, and its procedures
      are detailed in <xref target="RFC7432" format="default"/>. Conversely, the local-bias
      procedure is used for IP-based tunnels, such as VXLAN tunnels, and it is
      described in <xref target="RFC8365" format="default"/>.</t>
      <section anchor="sect-1.1" numbered="true" toc="default">
        <name>Conventions and Terminology</name>
        <t>
    The key words "<bcp14>MUST</bcp14>", "<bcp14>MUST NOT</bcp14>",
    "<bcp14>REQUIRED</bcp14>", "<bcp14>SHALL</bcp14>", "<bcp14>SHALL NOT</bcp14>",
    "<bcp14>SHOULD</bcp14>", "<bcp14>SHOULD NOT</bcp14>",
    "<bcp14>RECOMMENDED</bcp14>", "<bcp14>NOT RECOMMENDED</bcp14>",
    "<bcp14>MAY</bcp14>", and "<bcp14>OPTIONAL</bcp14>" in this document are to be
    interpreted as described in BCP&nbsp;14 <xref target="RFC2119"/> <xref
    target="RFC8174"/> when, and only when, they appear in all capitals, as
    shown here.
        </t>

<dl spacing="normal">

            <dt>AC:</dt>
	    <dd>Attachment Circuit</dd>
    
            <dt>A-D per ES route:</dt>
	    <dd>Auto-Discovery per Ethernet Segment
            route (as defined in <xref target="RFC7432" format="default"/>).</dd>
 
            <dt>Arg.FE2:</dt>
	    <dd>Refers to the ESI filtering argument used for split horizon as
	    specified in <xref target="RFC9252" format="default"/>.</dd>

            <dt>BD:</dt>
	    <dd>Broadcast Domain. Refers to an emulated Ethernet, such that
	    two systems on the same BD will receive each other's BUM
	    traffic. In this document, BD also refers to the instantiation of
	    a BD on an EVPN PE. An EVPN PE can be attached to one or multiple
	    BDs of the same tenant.</dd>

            <dt>BUM:</dt>
	    <dd>Broadcast, Unknown Unicast, and Multicast</dd>

	    <dt>CE:</dt><dd>Customer Edge</dd>

            <dt>DF:</dt>
	    <dd>Designated Forwarder. As defined in <xref
            target="RFC7432" format="default"/>, an ES may be multihomed
            (attached to more than one PE). An ES may also contain multiple
            BDs of one or more EVIs.  For each such EVI, one of the PEs
            attached to the segment becomes that EVI's DF for that
            segment. Since a BD may belong to only one EVI, we can speak
            unambiguously of the BD's DF for a given segment.</dd>

            <dt>ES:</dt>
	    <dd>Ethernet Segment</dd>

	    <dt>ESI:</dt>
	    <dd>Ethernet Segment Identifier</dd>

            <dt>EVI:</dt>
	    <dd>EVPN Instance</dd>

            <dt>EVI-RT:</dt><dd>EVI Route Target. Refers to a group of NVEs attached to the same
            EVI that will share the same EVI-RT.</dd>

            <dt>Geneve:</dt><dd>Generic Network Virtualization Encapsulation
            <xref target="RFC8926" format="default"/> (see tunnel type 19 in <xref
            target="TUNNEL-ENCAP" format="default"/>).</dd>

            <dt>MPLS tunnels and non-MPLS NVO tunnels:</dt><dd>Refers to
            Multiprotocol Label Switching (or the absence of it) Network
            Virtualization Overlay tunnels. NVO tunnels use an IP
            encapsulation for overlay frames, where the source IP address
            identifies the ingress NVE and the destination IP address identifies the
            egress NVE.</dd>

            <dt>MPLSoUDP:</dt><dd>Multiprotocol Label Switching over User
            Datagram Protocol <xref target="RFC7510" format="default"/> (see
            tunnel type 13 in <xref target="TUNNEL-ENCAP"
            format="default"/>).</dd>

            <dt>MPLSoGRE:</dt><dd>Multiprotocol Label Switching over Generic
            Network Encapsulation <xref target="RFC4023" format="default"/>
            (see tunnel type 11 in <xref target="TUNNEL-ENCAP"
            format="default"/>).</dd>

            <dt>MPLSoX:</dt><dd>Refers to MPLS over any IP encapsulation, for
            example, MPLSoUDP or MPLSoGRE.</dd>
  
            <dt>NVE:</dt><dd>Network Virtualization Edge</dd>
	    
            <dt>NVGRE:</dt><dd>Network Virtualization Using Generic Routing
            Encapsulation <xref target="RFC7637" format="default"/> (see
            tunnel type 9 in <xref target="TUNNEL-ENCAP"
            format="default"/>).</dd>

	    <dt>PE:</dt><dd>Provider Edge</dd>

	    <dt>RTs:</dt><dd>Route Targets</dd>

            <dt>VXLAN:</dt><dd>Virtual eXtensible Local Area Network <xref
            target="RFC7348" format="default"/> (see tunnel type 8 in <xref
            target="TUNNEL-ENCAP" format="default"/>).</dd>

            <dt>VXLAN-GPE:</dt><dd>VXLAN Generic Protocol Extension <xref
            target="I-D.ietf-nvo3-vxlan-gpe" format="default"/> (see tunnel
            type 12 in <xref target="TUNNEL-ENCAP"
            format="default"/>).</dd>

            <dt>SHT:</dt><dd>Split-Horizon Type. Refers to the split-horizon method
            that a PE intends to use and advertises in an A-D per ES
            route.</dd>

            <dt>SRv6:</dt><dd>Segment Routing over IPv6 (see <xref target="RFC8402"
            format="default"/> and <xref target="RFC8754" format="default"/>).</dd>
	    <dt>TLV:</dt><dd>Type-Length-Value</dd>

        </dl>
	
        <t>This document also assumes familiarity with the terminology of
        <xref target="RFC7432" format="default"/> and <xref target="RFC8365"
        format="default"/>.</t>
      </section>
      <section numbered="true" toc="default">
        <name>Split-Horizon Filtering and Tunnel Encapsulations</name>

        <t>EVPN supports two split-horizon filtering mechanisms:</t>
        <ol type="1" spacing="normal">
          <li>
           <t>ESI Label-based split-horizon filtering <xref target="RFC7432"
           format="default"/>:</t>

	   <t>When EVPN is employed for MPLS transport tunnels, an MPLS label
	   facilitates split-horizon filtering to support All-Active
	   multihoming. The ingress NVE device appends a label corresponding to the source ESI
       (the ESI label) during packet encapsulation.  The egress NVE verifies
       the ESI label when attempting to forward a multi-destination frame
       through a local ES interface. If the ESI label matches the site
       identifier (the ESI) associated with that ES interface, then the packet is not forwarded. This mechanism effectively prevents forwarding loops for BUM traffic. </t>

            <t>ESI Label split-horizon filtering should also
            be utilized with Single-Active multihoming to prevent transient
            loops for in-flight packets when the egress NVE assumes the role
            of DF for an ES.</t>
          </li>
          <li>
            <t>Local-bias filtering <xref target="RFC8365" format="default"/>:</t>
            <t>Since IP tunnels such as VXLAN or NVGRE do not
            support the ESI label or any MPLS label, an alternative split-horizon filtering procedure must be implemented for All-Active
            multihoming. This mechanism, known as local bias, relies on the
            source IP address of the tunnel to determine whether to forward
            BUM traffic to a local ES interface at the
            egress NVE.</t>
            <t>In summary and as specified in <xref target="RFC8365"
            format="default"/>, each NVE tracks the IP address(es) of other
            NVEs with which it shares multihomed ESs. Upon receiving a BUM
            frame encapsulated in an IP tunnel, the egress NVE inspects the
            source IP address in the tunnel header, which identifies the
            ingress NVE. The egress NVE then filters out the frame on all
            local interfaces connected to ESs that are shared with the ingress
            NVE.</t>

            <t>Due to this behavior at the egress NVE, the ingress NVE is
            required to perform local replication to all directly attached
            ESs, regardless of the DF election state, for all BUM traffic
            ingressing from the access ACs. This local replication at the
            ingress NVE is the basis for the term "local bias".</t>

            <t>Local bias is not suitable for Single-Active multihoming, as
            the ingress NVE deactivates the ACs for which it is not the
            DF. Consequently, local replication to non-DF ACs cannot occur,
            leading to transient in-flight BUM packets being looped back to
            the originating site by newly elected DF egress NVEs.</t>
          </li>
        </ol>

        <t><xref target="RFC8365" format="default"/> specifies that local bias
        is exclusively utilized for IP tunnels, while ESI Label-based split horizon is employed for IP-based MPLS tunnels. However, IP-based MPLS
        tunnels such as MPLSoGRE or MPLSoUDP are also categorized as IP
        tunnels and have the potential to support both procedures. These
        tunnels are capable of carrying ESI labels and also utilize a tunnel
        IP header in which the source IP address identifies the ingress
        NVE.</t>

        <t>Similarly, certain IP tunnels (those that include an identifier for
        the source ES in the tunnel header) may also potentially support either
        procedure. Examples of such tunnels include Geneve and SRv6:</t>
        <ul spacing="normal">
          <li>
            <t>In a Geneve tunnel, the source IP address identifies the
            ingress NVE; therefore, local bias is possible. Also, Section 4.1
            of <xref target="I-D.ietf-bess-evpn-geneve" format="default"/>
            defines an Ethernet option Type-Length-Value (TLV) to encode an
            ESI label value.</t>
          </li>
          <li>
            <t>In an SRv6 tunnel, the source IP address identifies the ingress
            NVE. By default, and as outlined in <xref target="RFC9252"
            format="default"/>, the ingress PE adds specific information to
            the SRv6 packet to enable the egress PE to identify the source ES
            of the BUM packet. This information is the ESI filtering argument
            (Arg.FE2) (see <xref target="RFC9252" sectionFormat="of"
            section="6.1.1"/> and <xref target="RFC8986" sectionFormat="of"
            section="4.12"/>) of the service Segment Identifier (SID) received
            on an A-D per ES route from the egress PE.</t>
          </li>
        </ul>

        <t><xref target="Tunnel" format="default"/> presents various tunnel
        encapsulations along with their supported and default split-horizon
        methods. For Geneve, the default SHT is contingent upon the
        negotiation of the Ethernet Option with the Source ID TLV. In the case
        of SRv6, the default SHT is specified as ESI Label filtering in the
        table, as its behavior is analogous to that of ESI Label filtering. In
        this document, "ESI Label filtering" refers to the split-horizon
        filtering based on the presence of a source ES
        identifier in the tunnel header.</t>

        <t>This document classifies the tunnel encapsulations used by EVPN
        into:</t>

        <ol spacing="normal" type="1"><li>
            <t>IP-based MPLS tunnels</t>
          </li>
          <li>
            <t>MPLS and SR-MPLS tunnels</t>
          </li>
          <li>
            <t>IP tunnels</t>
          </li>
          <li>
            <t>SRv6 tunnels</t>
          </li>
        </ol>

        <t><xref target="Tunnel" format="default"/> lists the encapsulations
        supported by this document. Any tunnel encapsulation not listed in
        <xref target="Tunnel" format="default"/> is out of scope. Tunnel
        encapsulations used by EVPN can be categorized into one of the four
        encapsulation groups mentioned above and support split-horizon
        filtering based on the following rules:</t>

        <ul spacing="normal">
          <li>
            <t>IP-based MPLS tunnels and SRv6 tunnels are capable of
            supporting both split-horizon filtering methods.</t>
          </li>
          <li>
            <t>MPLS and SR-MPLS tunnels only support ESI Label-based split-horizon filtering.</t>
          </li>
          <li>
            <t>IP tunnels support local-bias split-horizon filtering and may
            also support ESI Label-based split-horizon filtering, provided
            they incorporate a mechanism to identify the source ESI in the
            header.</t>
          </li>

        </ul>
        <table align="left" anchor="Tunnel">
          <name>Tunnel Encapsulations and Split-Horizon Types</name>
          <thead>
            <tr>
              <th align="left">Tunnel Encapsulation</th>
              <th align="left">Default Split-Horizon Type (SHT)</th>
              <th align="left">Supports Local Bias</th>
              <th align="left">Supports ESI Label</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">MPLSoGRE (IP-based MPLS)</td>
              <td align="left">ESI Label filtering</td>
              <td align="left">Yes</td>
              <td align="left">Yes</td>
            </tr>
            <tr>
              <td align="left">MPLSoUDP (IP-based MPLS)</td>
              <td align="left">ESI Label filtering</td>
              <td align="left">Yes</td>
              <td align="left">Yes</td>
            </tr>
            <tr>
              <td align="left">MPLS and SR-MPLS</td>
              <td align="left">ESI Label filtering</td>
              <td align="left">No</td>
              <td align="left">Yes</td>
            </tr>
            <tr>
              <td align="left">VXLAN (IP tunnels)</td>
              <td align="left">Local Bias</td>
              <td align="left">Yes</td>
              <td align="left">No</td>
            </tr>
            <tr>
              <td align="left">NVGRE (IP tunnels)</td>
              <td align="left">Local Bias</td>
              <td align="left">Yes</td>
              <td align="left">No</td>
            </tr>
            <tr>
              <td align="left">VXLAN-GPE (IP tunnels)</td>
              <td align="left">Local Bias</td>
              <td align="left">Yes</td>
              <td align="left">No</td>
            </tr>
            <tr>
              <td align="left">Geneve (IP tunnels)</td>
              <td align="left">Local Bias (if no ESI Lb), ESI Label (if ESI lb)</td>
              <td align="left">Yes</td>
              <td align="left">Yes</td>
            </tr>
            <tr>
              <td align="left">SRv6</td>
              <td align="left">ESI Label filtering</td>
              <td align="left">Yes</td>
              <td align="left">Yes</td>
            </tr>
          </tbody>
        </table>
        <t>The ESI Label method is applicable for both All-Active and
        Single-Active configurations, whereas the local-bias method is
        suitable only for All-Active configurations. Moreover, the ESI Label
        method is effective across different network domains, while local bias
        is constrained to networks where there is no change in the next hop
        between the NVEs attached to the same ES. Nonetheless, some operators
        favor the local-bias method due to its simplification of the
        encapsulation process, reduced resource consumption on NVEs, and the
        fact that the ingress NVE always forwards traffic locally to other
        interfaces, thereby decreasing the delay in reaching multihomed
        hosts.</t>
        <t>This document extends the EVPN multihoming procedures to allow
        operators to select the preferred split-horizon method for a given NVO
        tunnel according to their specific requirements. The choice between
        local bias and ESI Label split horizon is now allowed (by
        configuration) for tunnel encapsulations that support both methods,
        and this selection is advertised along with the EVPN A-D per ES route.
        IP tunnels that do not support both methods, such as VXLAN or NVGRE,
        will continue to adhere to the procedures specified in <xref
        target="RFC8365" format="default"/>. Note that this document does not
        modify the local bias or the ESI Label split-horizon procedures
        themselves, just focuses on the signaling and selection of the split-horizon method to apply by the multihomed NVEs. </t>
      </section>
    </section>
    <section anchor="sect-2" numbered="true" toc="default">
      <name>BGP EVPN Extensions</name>
      <t>Extensions to EVPN are required to enable NVEs to advertise their
      preferred split-horizon method for a given ES. <xref
      target="esi-label-extended-community" format="default"/> illustrates the
      ESI Label extended community (<xref target="RFC7432" sectionFormat="of"
      section="7.5"/>), which is consistently advertised alongside the EVPN
      A-D per ES route. All NVEs connected to an ES advertise an A-D per ES
      route for that ES, including the extended community, which communicates
      information regarding the multihoming mode (either All-Active or
      Single-Active) and, if necessary, specifies the ESI Label to be
      utilized.</t>
      <figure anchor="esi-label-extended-community">
        <name>ESI Label Extended Community</name>
        <artwork name="" type="" align="left" alt=""><![CDATA[
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type=0x06     | Sub-Type=0x01 | Flags(1 octet)|  Reserved=0   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Reserved=0   |          ESI Label                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
      </figure>

      <t><xref target="RFC7432" format="default"/> defines the low-order bit
      of the Flags octet (bit 0) as the "Single-Active" bit:</t>
      <ul spacing="normal">
        <li>
          <t>A value of 0 means that the multihomed ES is operating in
          All-Active multihoming redundancy mode.</t>
        </li>
        <li>
          <t>A value of 1 means that the multihomed ES is operating in
          Single-Active multihoming redundancy mode.</t>
        </li>
      </ul>
      <t><xref target="sect-5" format="default"/> establishes a registry for the Flags
      octet, designating the "Single-Active" bit as the low-order bit of the
      newly defined Multihoming Redundancy Mode field.</t>
      <section anchor="sect-2.1" numbered="true" toc="default">
        <name>The Split-Horizon Type</name>
        <t><xref target="RFC8365" format="default"/> does not include any
        explicit indication regarding the split-horizon method in the A-D per
        ES route. In this document, the split-horizon procedure defined in
        <xref target="RFC8365" sectionFormat="of" section="8.3.1"/> is
        considered the default behavior, presuming that local bias is employed
        exclusively for IP tunnels, while ESI Label-based split horizon is
        used for IP-based MPLS tunnels. This document specifies that the two
        high-order bits in the Flags octet (bits 6 and 7) constitute the "Split-Horizon Type" or "SHT"
        field, where:</t>

        <artwork name="" type="" align="left" alt="">
<![CDATA[
 7 6 5 4 3 2 1 0
+-+-+-+-+-+-+-+-+
|SHT|       |RED|
+-+-+-+-+-+-+-+-+
RED = "Multihoming Redundancy Mode" field (see Table 2)

SHT bit 7 6
-----------
        0 0  --> Default SHT 
                 Backwards compatible with [RFC8365] and [RFC7432]
        0 1  --> Local Bias
        1 0  --> ESI Label-based filtering
        1 1  --> Unassigned
]]></artwork>
        <ul spacing="normal">
          <li>
            <t>SHT = 00 is backwards compatible with <xref target="RFC8365" format="default"/>
            and <xref target="RFC7432" format="default"/>, and indicates that the advertising
            NVE intends to use the default or built-in SHT. The default SHT is
            shown in <xref target="Tunnel" format="default"/> for each encapsulation. An egress
            NVE that follows the <xref target="RFC8365" format="default"/> behavior and does
            not support this specification will ignore the SHT bits (which is
            equivalent to processing them as a value of 00).</t>
          </li>
          <li>
            <t>SHT = 01 indicates that the advertising NVE intends to use
            local-bias procedures in the ES for which the AD per-ES route is
            advertised.</t>
          </li>
          <li>
            <t>SHT = 10 indicates that the advertising NVE intends to use the
            ESI Label-based split-horizon method procedures in the ES for
            which the AD per-ES route is advertised.</t>
          </li>
          <li>
            <t>SHT = 11 is Unassigned.</t>
          </li>
        </ul>
      </section>
      <section anchor="sect-2.2" numbered="true" toc="default">
        <name>Use of the Split-Horizon Type in A-D per ES Routes</name>
        <t>The following behavior is observed:</t>
        <ul spacing="normal">
          <li>
            <t>An SHT value of 01 or 10 <bcp14>MUST NOT</bcp14> be used with
            encapsulations that support only one SHT in <xref target="Tunnel"
            format="default"/>, and <bcp14>MAY</bcp14> be used by
            encapsulations that support the two SHTs in <xref target="Tunnel"
            format="default"/>.</t>
          </li>
          <li>
            <t>An SHT value different than 00 expresses the intent to use a
            specific split-horizon method, but does not reflect the actual
            operational SHT used by the advertising NVE, unless all the NVEs
            attached to the ES advertise the same SHT.</t>
          </li>
          <li>
            <t>In case of an inconsistency in the SHT value advertised by the
            NVEs attached to the same ES for a given EVI, all the NVEs <bcp14>MUST</bcp14>
            revert to the behavior in <xref target="RFC8365" format="default"/> and use the
            default SHT in <xref target="Tunnel" format="default"/>, irrespective of the
            advertised SHT.</t>
          </li>
          <li>
            <t>An SHT different than 00 <bcp14>MUST NOT</bcp14> be set if the "Single-Active"
            bit is set. A received A-D per ES route where the "Single-Active" and
            SHT bits are different than zero <bcp14>MUST</bcp14> follow the treat-as-withdraw
            behavior in <xref target="RFC7606" format="default"/>.</t>
          </li>
          <li>
            <t>The SHT <bcp14>MUST</bcp14> have the same value in each Ethernet A-D per ES
            route that an NVE advertises for a given ES and a given
            encapsulation (see <xref target="sect-3" format="default"/> for NVEs supporting
            multiple encapsulations).</t>
          </li>
        </ul>
        <t>As an example, egress NVEs that support IP-based MPLS tunnels, such
        as MPLSoGRE or MPLSoUDP, will advertise A-D per ES routes for the ES
        along with the BGP Encapsulation Extended Community, as defined in
        <xref target="RFC9012" format="default"/>. This extended community indicates the
        encapsulation type (MPLSoGRE or MPLSoUDP) and may use the SHT value of
        01 or 10 to signify the intent to use local bias or the ESI Label,
        respectively.</t>


        <t>An egress NVE <bcp14>MUST NOT</bcp14> use an SHT value other than 00 when
        advertising an A-D per ES route with the following tunnel encapsulation types from <xref target="RFC9012" format="default"/>: 
        VXLAN (type 8), NVGRE (type 9), MPLS (type 10),
        or no BGP Tunnel Encapsulation Extended Community at all. In all these
        cases, it is presumed that there is no choice for the split-horizon
        method; therefore, the SHT value <bcp14>MUST</bcp14> be set to 00. If a route with
        any of the mentioned encapsulation options is received and has an SHT
        value different than 00, it <bcp14>SHOULD</bcp14> apply the treat-as-withdraw
        behavior, per <xref target="RFC7606" format="default"/>.</t>

<t>An egress NVE advertising A-D per ES route(s) for an ES with Geneve
        encapsulation (tunnel encapsulation type 19 in  the BGP Tunnel Encapsulation attribute <xref target="RFC9012" format="default"/>) <bcp14>MAY</bcp14> use an SHT value of 01 or 10. A
        value of 01 indicates the intent to use local bias, regardless of the
        presence of an Ethernet option TLV with a non-zero Source-ID, as
        described in <xref target="I-D.ietf-bess-evpn-geneve"
        format="default"/>.  A value of 10 indicates the intent to use ESI
        Label-based split horizon, and it is only valid if an Ethernet option
        TLV with a non-zero Source-ID is present. A value of 00 indicates the
        default behavior outlined in <xref target="Tunnel" format="default"/>,
        which is to use local bias if:</t>

	<ol type="a">
	  <li>no ESI Label is present in the Ethernet option TLV, or </li>	  
	  <li>there is no Ethernet option TLV.</li>
	</ol>
	<t>Otherwise, the ESI Label split-horizon method is applied.</t>
        <t>These procedures assume a single encapsulation supported in the
        egress NVE. <xref target="sect-3" format="default"/> describes additional procedures
        for NVEs supporting multiple encapsulations.</t>
      </section>
      <section anchor="sect-2.3" numbered="true" toc="default">
        <name>The ESI Label Value in A-D per ES Routes</name>
        <t>This document also updates <xref target="RFC8365" format="default"/> regarding the
        value that is advertised in the ESI Label field of the ESI Label
        extended community, as follows:</t>
        <ul spacing="normal">
          <li>
            <t>The A-D per ES route(s) for an ES <bcp14>MAY</bcp14> have an ESI Label value
            of zero if the SHT value is 01. <xref target="sect-2.2" format="default"/>
            specifies the scenarios where the SHT can be 01. An ESI Label
            value of zero eliminates the need to allocate labels in cases
            where they are not utilized, such as in the local-bias method.</t>
          </li>
          <li>
            <t>The A-D per ES route(s) for an ES <bcp14>MAY</bcp14> have an ESI Label value
            of zero for VXLAN or NVGRE encapsulations.</t>
          </li>
        </ul>
      </section>

      <section anchor="sect-2.4" numbered="true" toc="default">
        <name>Backwards Compatibility with NVEs from RFC 8365</name>
        <t>As discussed in <xref target="sect-2.2" format="default"/>, this
        specification is backwards compatible with the split-horizon filtering
        behavior in <xref target="RFC8365" format="default"/> and a
        non-upgraded NVE can be attached to the same ES as other NVEs
        supporting this specification.</t>
        <t>An NVE maintains an administrative SHT value for an ES, which is
        advertised alongside the A-D per ES route, and an operational SHT
        value, which is the one actually used regardless of what the NVE has
        advertised. The administrative SHT matches the operational SHT if all
        the NVEs attached to the ES have the same administrative SHT.</t>
        <t>This document assumes that an implementation of <xref target="RFC7432" format="default"/> or <xref target="RFC8365" format="default"/> that does not support
        the specifications in this document will ignore the values of all the
        Flags in the ESI Label extended community, except for the
        "Single-Active" bit. Based on this assumption, a non-upgraded NVE will
        disregard any SHT value other than 00. If an upgraded NVE receives at
        least one A-D per ES route for the ES with an SHT value of 00, it <bcp14>MUST</bcp14>
        revert its operational SHT to the default split-horizon method, as
        described in <xref target="Tunnel" format="default"/>, irrespective of its
        administrative SHT.</t>

        <t>For instance, consider an NVE attached to ES N that receives two
        A-D per ES routes for N from different NVEs, NVE1 and NVE2. If the
        route from NVE1 has an SHT value of 00 and the one from NVE2 has an
        SHT value of 01, the NVE <bcp14>MUST</bcp14> use the default split-horizon method
        specified in <xref target="Tunnel" format="default"/> as its operational SHT,
        regardless of its administrative SHT.</t>
        <t>All NVEs attached to an ES with an operational SHT value of 10 <bcp14>MUST</bcp14>
        advertise a valid, non-zero ESI Label. If the operational SHT value is
        01, the ESI Label <bcp14>MAY</bcp14> be zero. If the operational SHT value is 00, the
        ESI Label may be zero only if the default encapsulation supports local
        bias exclusively, and the NVEs do not require the presence of a valid,
        non-zero ESI Label.</t>
        <t>If an NVE changes its operational SHT value from 01 (Local Bias) to
        00 (Default SHT) due to the presence of a new non-upgraded NVE in the
        ES, and it previously advertised a zero ESI Label, it <bcp14>MUST</bcp14> send an
        update with a valid, non-zero ESI Label, unless all the non-upgraded
        NVEs in the ES support only local bias. For example, consider NVE1 and
        NVE2 using MPLSoUDP as encapsulation, attached to the same Ethernet
        Segment ES1, and advertising an SHT value of 01 (Local Bias) with a
        zero ESI Label value. Suppose NVE3, which does not support this
        specification, joins ES1 and advertises an SHT value of 00 (default).
        Upon receiving NVE3's A-D per ES route, NVE1 and NVE2 <bcp14>MUST</bcp14> update
        their A-D per ES routes for ES1 to include a valid, non-zero ESI Label
        value. The assumption here is that NVE3 only supports the default ESI
        Label-based split-horizon filtering.</t>
      </section>
    </section>
    <section anchor="sect-3" numbered="true" toc="default">
      <name>Procedures for NVEs Supporting Multiple Encapsulations</name>
      <t>As specified in <xref target="RFC8365" format="default"/>, an NVE
      that supports multiple data plane encapsulations (e.g., VXLAN, NVGRE,
      MPLS, MPLSoUDP, Geneve) must indicate all supported encapsulations using
      BGP Encapsulation extended communities as defined in <xref
      target="RFC9012" format="default"/> for all EVPN routes. This section
      provides clarification on the multihoming split-horizon behavior for
      NVEs that advertise and receive multiple BGP Encapsulation extended
      communities along with the A-D per ES routes. This section uses the
      notation {x, y} (more than two encapsulations is possible too) to denote
      the encapsulations advertised in BGP Encapsulation extended communities
      (or the BGP Tunnel Encapsulation Attribute), where x and y represent
      different encapsulation values. When Geneve is one of the
      encapsulations, the tunnel type is indicated in either a BGP
      Encapsulation extended community or a BGP Tunnel Encapsulation
      Attribute.</t>

      <t>It is important to note that an NVE <bcp14>MAY</bcp14> advertise multiple A-D per ES
      routes for the same ES, rather than a single route, with each route
      conveying a set of Route Targets (RTs). The total set of RTs
      associated with a given ES is referred to as the RT-set for that ES.
      Each of the EVIs represented in the RT-set will have its RT included in
      one, and only one, A-D per ES route for the ES. When multiple A-D per ES
      routes are advertised for the same ES, each route must have a distinct
      Route Distinguisher.</t>

      <t>As per <xref target="RFC8365" format="default"/>, an NVE that advertises multiple
      encapsulations in the A-D per ES route(s) for an ES <bcp14>MUST</bcp14> advertise
      encapsulations that use the same split-horizon filtering method in the
      same route. For example:</t>
      <ul spacing="normal">
        <li>
          <t>An A-D per ES route for ES-x may be advertised with {VXLAN,
          NVGRE} encapsulations.</t>
        </li>
        <li>
          <t>An A-D per ES route for ES-y may be advertised with {MPLS,
          MPLSoUDP, MPLSoGRE} encapsulations (or a subset).</t>
        </li>
        <li>
          <t>However, an A-D per ES route for ES-z <bcp14>MUST NOT</bcp14> be advertised with
          {MPLS, VXLAN} encapsulations.</t>
        </li>
      </ul>
      <t>This document extends the described behavior as follows:</t>
      <ol spacing="normal" type="a"><li>
          <t>An A-D per ES route for ES-x may be advertised with multiple
          encapsulations, some of which support a single split-horizon method.
          In this case, the SHT value <bcp14>MUST</bcp14> be 00. For instance,
          encapsulations such as {VXLAN, NVGRE}, {VXLAN, Geneve}, or {MPLS,
          MPLSoGRE, MPLSoUDP} can be advertised in an A-D per ES route.  In
          all these cases, the SHT value <bcp14>MUST</bcp14> be 00 and the
          treat-as-withdraw behavior <xref target="RFC7606" format="default"/>
          is applied in case of any other value.</t>
        </li>
        <li>
          <t>An A-D per ES route for ES-y may be advertised with multiple
          encapsulations that all support both split-horizon methods. In this
          case, the SHT value <bcp14>MAY</bcp14> be 01 if the preferred method is local bias,
          or 10 if the ESI Label-based method is desired. For example,
          encapsulations such as {MPLSoGRE, MPLSoUDP, Geneve} (or a subset)
          <bcp14>MAY</bcp14> be advertised in an A-D per ES route with an SHT value of 01.
          The ESI Label value in this case <bcp14>MAY</bcp14> be zero.</t>
        </li>
        <li>
          <t>If ES-z with an RT-set composed of (RT1, RT2, RT3.. RTn) supports
          multiple encapsulations requiring different split-horizon methods, a
          distinct A-D per ES route (or group of routes) per split-horizon
          method <bcp14>MUST</bcp14> be advertised. For example, consider an ES-z with n RTs, where:</t>
          <ul spacing="normal">
            <li>
              <t>the EVIs corresponding to (RT1..RTi) support VXLAN,</t>
            </li>
            <li>
              <t>the ones for (RTi+1..RTm) (with i&lt;m) support MPLSoUDP with
              local bias, and</t>
            </li>
            <li>
              <t>the ones for (RTm+1..RTn) (with m&lt;n) support Geneve
              with ESI Label-based split horizon.</t>
            </li>
          </ul>
          <t>In this scenario, three groups of A-D per ES routes <bcp14>MUST</bcp14> be
          advertised for ES-z:</t>
          <ul spacing="normal">
            <li>
              <t>A-D per ES route group 1, including (RT1..RTi) with
              encapsulation {VXLAN} and an SHT value of 00. The ESI Label <bcp14>MAY</bcp14>
              be zero.</t>
            </li>
            <li>
              <t>A-D per ES route group 2, including (RTi+1..RTm) with
              encapsulation {MPLSoUDP} and an SHT value of 01. The ESI Label
              <bcp14>MAY</bcp14> be zero.</t>
            </li>
            <li>
              <t>A-D per ES route group 3, including (RTm+1..RTn) with
              encapsulation {Geneve} and an SHT value of 10. The ESI Label
              <bcp14>MUST</bcp14> have a valid, non-zero value, and the Ethernet option as
              defined in <xref target="RFC8926" format="default"/> <bcp14>MUST</bcp14> be advertised.</t>
            </li>
          </ul>
        </li>
      </ol>
      <t>As per <xref target="RFC8365" format="default"/>, it is the responsibility of the
      operator of a given EVI to ensure that all of the NVEs within that EVI
      support a common encapsulation. Failure to meet this condition may
      result in service disruption or failure.</t>
    </section>
    <section numbered="true" toc="default">
      <name>Security Considerations</name>
      <t>All the security considerations described in <xref target="RFC7432" format="default"/>
      are applicable to this document.</t>

      <t>Additionally, this document modifies the procedures for split-horizon
      filtering as outlined in <xref target="RFC8365" format="default"/>,
      offering operators a choice between local bias and ESI Label-based
      filtering for tunnels that support both methods. Misconfiguration of the
      desired SHT could lead to forwarding behaviors that differ from the
      intended configuration. Apart from this risk, this document describes
      procedures to ensure that all PE devices or NVEs connected to the same
      ES agree on a common SHT method, with a fallback to a default behavior
      in case of a mismatch in the SHT bits being advertised by any two PEs or
      NVEs in the ES. Consequently, unauthorized changes to the SHT
      configuration by an attacker on a single PE or NVE of the ES should not
      cause traffic disruption (as long as the SHT value is valid as per this
      document) but may result in alterations to forwarding behavior.</t>
    </section>
    <section anchor="sect-5" numbered="true" toc="default">
      <name>IANA Considerations</name>

      <t>Per this document, IANA has created the "EVPN ESI Label Extended Community Flags" registry for the 1-octet Flags field in the ESI Label Extended
      Community <xref target="RFC7432" format="default"/>, as follows:</t>
      <table align="center">
        <thead>
          <tr>
            <th align="left">Bit Position</th>
            <th align="left">Name</th>
            <th align="left">Reference</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td align="left">0-1</td>
            <td align="left">Multihoming Redundancy Mode</td>
            <td align="left">
              <xref target="RFC7432" format="default"/></td>
          </tr>
          <tr>
            <td align="left">2-5</td>
            <td align="left">Unassigned</td>
            <td align="left"/>
          </tr>
          <tr>
            <td align="left">6-7</td>
            <td align="left">Split-Horizon Type</td>
            <td align="left">RFC 9746</td>
          </tr>
        </tbody>
      </table>

      <t>IANA has also created the "Multihoming Redundancy
      Mode" registry for the related field of the "EVPN ESI Label Extended Community Flags". The registry has been populated with the following initial values: 
      </t>
      <table align="center">
        <thead>
          <tr>
            <th align="left">Value</th>
            <th align="left">Multihoming Redundancy Mode</th>
            <th align="left">Reference</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td align="left">00</td>
            <td align="left">All-Active</td>
            <td align="left">
              <xref target="RFC7432" format="default"/></td>
          </tr>
          <tr>
            <td align="left">01</td>
            <td align="left">Single-Active</td>
            <td align="left">
              <xref target="RFC7432" format="default"/></td>
          </tr>
          <tr>
            <td align="left">10</td>
            <td align="left">Unassigned</td>
            <td align="left"/>
          </tr>
          <tr>
            <td align="left">11</td>
            <td align="left">Unassigned</td>
            <td align="left"/>
          </tr>
        </tbody>
      </table>
      <t>Finally, IANA has created the "Split-Horizon Type" registry for the related field of the
      "EVPN ESI Label Extended Community Flags". The registry has been populated with the following initial values:</t>
      <table align="center">
        <thead>
          <tr>
            <th align="left">Value</th>
            <th align="left">Split-Horizon Type Value</th>
            <th align="left">Reference</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td align="left">00</td>
            <td align="left">Default SHT</td>
            <td align="left">RFC 9746</td>
          </tr>
          <tr>
            <td align="left">01</td>
            <td align="left">Local Bias</td>
            <td align="left">RFC 9746</td>
          </tr>
          <tr>
            <td align="left">10</td>
            <td align="left">ESI Label-based filtering</td>
            <td align="left">RFC 9746</td>
          </tr>
          <tr>
            <td align="left">11</td>
            <td align="left">Unassigned</td>
            <td align="left"/>
          </tr>
        </tbody>
      </table>
      <t>New registrations in the "EVPN ESI Label Extended Community Flags",
      "Multihoming Redundancy Mode", and "Split-Horizon Type" registries will
      be made through the "IETF Review" procedure defined in <xref
      target="RFC8126" format="default"/>. These registries are located in the
      "Border Gateway Protocol (BGP) Extended Communities" registry group.</t>
    </section>


  </middle>
  <back>
    <displayreference target="I-D.ietf-bess-evpn-geneve" to="EVPN-GENEVE"/>
    <displayreference target="I-D.ietf-nvo3-vxlan-gpe" to="VXLAN-GPE"/>
    <references>
      <name>References</name>
      <references>
        <name>Normative References</name>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8126.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7432.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8365.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9252.xml"/>
      </references>
      <references>
        <name>Informative References</name>

<!-- [I-D.ietf-bess-evpn-geneve] IESG state: I-D Exists as of 09/05/24-->
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-bess-evpn-geneve.xml"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7348.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.4023.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7637.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7510.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8926.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9012.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7606.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8660.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8986.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml"/>

<!-- [I-D.ietf-nvo3-vxlan-gpe] IESG state: Expired as of 09/05/24 -->
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/draft-ietf-nvo3-vxlan-gpe.xml"/>

        <reference anchor="TUNNEL-ENCAP" target="https://www.iana.org/assignments/bgp-tunnel-encapsulation">
          <front>
            <title>Border Gateway Protocol (BGP) Tunnel Encapsulation</title>
            <author>
              <organization>IANA</organization>
            </author>
            <date/>
          </front>
        </reference>
      </references>
    </references>
    <section anchor="Acknowledgments" numbered="false" toc="default">
      <name>Acknowledgments</name>
      <t>The authors would like to thank <contact fullname="Anoop Ghanwani"/>,
      <contact fullname="Gyan Mishra"/>, and <contact fullname="Jeffrey
      Zhang"/> for their review and useful comments. Thanks to <contact
      fullname="Gunter Van de Velde"/> and <contact fullname="Sue Hares"/> as
      well, for their thorough review.</t>
    </section>

  </back>
</rfc>
