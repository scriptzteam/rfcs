<?xml version='1.0' encoding='utf-8'?>

<!DOCTYPE rfc [
  <!ENTITY nbsp    "&#160;">
  <!ENTITY zwsp   "&#8203;">
  <!ENTITY nbhy   "&#8209;">
  <!ENTITY wj     "&#8288;">
]>

<rfc xmlns:xi="http://www.w3.org/2001/XInclude" ipr="trust200902" docName="draft-ietf-spring-srv6-srh-compression-23" number="9800" category="std" consensus="true" submissionType="IETF" updates="8754" obsoletes="" tocInclude="true" sortRefs="true" symRefs="true" version="3" xml:lang="en">

  <front>
    <title abbrev="Compressed SRv6 Segment List Encoding">Compressed
    SRv6 Segment List Encoding</title>
    <seriesInfo name="RFC" value="9800"/>
    <author initials="W." surname="Cheng" fullname="Weiqiang Cheng" role="editor">
      <organization>China Mobile</organization>
      <address>
        <postal>
          <country>China</country>
        </postal>
        <email>chengweiqiang@chinamobile.com</email>
      </address>
    </author>
    <author initials="C." surname="Filsfils" fullname="Clarence Filsfils">
      <organization>Cisco Systems, Inc.</organization>
      <address>
        <postal>
          <country>Belgium</country>
        </postal>
        <email>cf@cisco.com</email>
      </address>
    </author>
    <author initials="Z." surname="Li" fullname="Zhenbin Li">
      <organization>Huawei Technologies</organization>
      <address>
        <postal>
          <country>China</country>
        </postal>
        <email>lizhenbin@huawei.com</email>
      </address>
    </author>
    <author initials="B." surname="Decraene" fullname="Bruno Decraene">
      <organization>Orange</organization>
      <address>
        <postal>
          <country>France</country>
        </postal>
        <email>bruno.decraene@orange.com</email>
      </address>
    </author>
    <author initials="F." surname="Clad" fullname="Francois Clad" role="editor">
      <organization>Cisco Systems, Inc.</organization>
      <address>
        <postal>
          <country>France</country>
        </postal>
        <email>fclad.ietf@gmail.com</email>
      </address>
    </author>
    <date year="2025" month="June"/>

    <area>RTG</area>
    <workgroup>spring</workgroup>

<keyword>Segment Routing</keyword>
<keyword>IPv6 Segment Routing</keyword>
<keyword>Compressed SID</keyword>
<keyword>CSID</keyword>
<keyword>NEXT-CSID</keyword>
<keyword>REPLACE-SID</keyword>
<keyword>SRH Compression</keyword>

    <abstract>
<t>Segment Routing over IPv6 (SRv6) is the instantiation of Segment Routing (SR) on the IPv6 data plane. This document specifies new flavors for the SRv6 endpoint behaviors defined in RFC 8986, which enable the compression of an SRv6 segment list. Such compression significantly reduces the size of the SRv6 encapsulation needed to steer packets over long segment lists.</t>
      <t>This document updates RFC 8754 by allowing a Segment List entry in the Segment Routing Header (SRH) to be either an IPv6 address, as specified in RFC 8754, or a REPLACE-CSID container in packed format, as specified in this document.</t>
    </abstract>
  </front>
  <middle>
    <?line 250?>

<section anchor="introduction">
      <name>Introduction</name>
      <t>The Segment Routing (SR) architecture <xref target="RFC8402"/> describes two data plane instantiations of SR: SR over MPLS (SR-MPLS) and SR over IPv6 (SRv6).</t>
      <t>SRv6 Network Programming <xref target="RFC8986"/> builds upon the IPv6 Segment Routing Header (SRH) <xref target="RFC8754"/> to define a framework for constructing a network program with topological and service segments.</t>
      <t>Some SRv6 applications, such as strict path traffic engineering, may require long segment lists. Compressing the encoding of these long segment lists in the packet header can significantly reduce the header size. This document specifies new flavors to the SRv6 endpoint behaviors defined in <xref target="RFC8986"/> that enable a compressed encoding of the SRv6 segment list.
This document also specifies new SRv6 endpoint behaviors to preserve the compression efficiency in multi-domain environments.</t>
      <t>The SRv6 endpoint behaviors defined in this document leverage the SRv6 data plane defined in <xref target="RFC8754"/> and <xref target="RFC8986"/>; the behaviors are compatible with the SRv6 control plane extensions for IS-IS <xref target="RFC9352"/>, OSPF <xref target="RFC9513"/>, and BGP <xref target="RFC9252"/>.</t>
      <t>This document updates <xref target="RFC8754"/> by allowing a Segment List entry in the SRH to be either an IPv6 address, as specified in <xref target="RFC8754"/>, or a REPLACE-CSID container in packed format, as specified in <xref target="sec-replace"/>.</t>
    </section>
    <section anchor="terminology">
      <name>Terminology</name>
      <t>This document leverages the terms defined in <xref target="RFC8402"/>, <xref target="RFC8754"/>, and <xref target="RFC8986"/>, in particular segment, segment list, Segment Identifier (SID), SID list, SR policy, prefix segment, adjacency segment, SRH, SR domain, SR source node, SR segment endpoint node, transit node, SRv6 endpoint behavior, flavor, SID block, locator, function, and argument. The reader is assumed to be familiar with this terminology.</t>
      <t>This document introduces the following new terms:</t>

      <dl spacing="normal" newline="false">
        <dt>Locator-Block:</dt><dd>The most significant bits of a SID locator
        that represent the SRv6 SID block. The Locator-Block is referred to as
        "B" in <xref target="RFC8986" sectionFormat="of" section="3.1"/>.</dd>
        <dt>Locator-Node:</dt><dd>The least significant bits of a SID locator
        that identify the SR segment endpoint node instantiating the SID. The
        Locator-Node is referred to as "N" in <xref
        target="RFC8986" sectionFormat="of" section="3.1"/>.</dd>
        <dt>Compressed-SID (CSID):</dt><dd>A compressed encoding of a SID. The
        CSID includes the Locator-Node and Function bits of the SID being
        compressed. If either constituent of the SID is empty (zero length),
        then the same applies to its CSID encoding.</dd>
        <dt>CSID container:</dt><dd>A 128-bit IPv6 address that functions as a
        container holding a list of one or more CSIDs and the Argument (if
        any) of the last CSID.</dd>
        <dt>CSID sequence:</dt><dd>A group of one or more consecutive SID list
        entries encoding the common Locator-Block and at least one CSID
        container.</dd>
        <dt>Compressed SID list:</dt><dd>A segment list encoding that reduces
        the packet header length thanks to one or more CSID sequences. A
        compressed SID list also contains zero, one, or more uncompressed
        SIDs.</dd>
        <dt>Global Identifiers Block (GIB):</dt><dd>The pool of CSID values
        available for global allocation.</dd>
        <dt>Local Identifiers Block (LIB):</dt><dd>The pool of CSID values
        available for local allocation.</dd>
      </dl>

      <t>In this document, the length of each constituent part of a SID is referred to as follows:</t>
      <ul spacing="normal">
        <li>
          <t>LBL is the Locator-Block length of the SID.</t>
        </li>
        <li>
          <t>LNL is the Locator-Node length of the SID.</t>
        </li>
        <li>
          <t>FL is the Function length of the SID.</t>
        </li>
        <li>
          <t>AL is the Argument length of the SID.</t>
        </li>
      </ul>
      <t>In addition, the Locator-Node and Function length (LNFL) is the sum of the LNL and the FL of the SID. It is also referred to as the "CSID length".</t>
      <section anchor="requirements-language">
        <name>Requirements Language</name>
        <t>
    The key words "<bcp14>MUST</bcp14>", "<bcp14>MUST NOT</bcp14>", "<bcp14>REQUIRED</bcp14>", "<bcp14>SHALL</bcp14>", "<bcp14>SHALL
    NOT</bcp14>", "<bcp14>SHOULD</bcp14>", "<bcp14>SHOULD NOT</bcp14>", "<bcp14>RECOMMENDED</bcp14>", "<bcp14>NOT RECOMMENDED</bcp14>",
    "<bcp14>MAY</bcp14>", and "<bcp14>OPTIONAL</bcp14>" in this document are to be interpreted as
    described in BCP&nbsp;14 <xref target="RFC2119"/> <xref target="RFC8174"/> 
    when, and only when, they appear in all capitals, as shown here.
        </t>
      </section>
    </section>
    <section anchor="basic-concepts">
      <name>Basic Concepts</name>
      <t>In an SR domain, all SRv6 SIDs instantiated from the same Locator-Block share the same most significant bits. In addition, when the combined length of the SRv6 SID Locator, Function, and Argument is smaller than 128 bits, the least significant bits of the SID are padded with zeros.
The compressed segment list encoding seeks to decrease the packet header length by avoiding the repetition of the same Locator-Block and reducing the use of padding bits.</t>
      <t>Building upon, and fully compatible with the mechanisms specified in <xref target="RFC8754"/> and <xref target="RFC8986"/>, the compressed segment list encoding leverages a SID list compression logic at the SR source node (see <xref target="sec-source-node"/>) in combination with new flavors of the SRv6 endpoint behaviors that process the compressed SID list (see <xref target="sec-endpoint"/>).</t>
      <t>An SR source node constructs and compresses the SID list depending on the SIDs instantiated on each SR segment endpoint node that the packet is intended to traverse, as well as its own compression capabilities. The resulting compressed SID list is a combination of CSID sequences, for the SIDs that the SR source node was able to compress, and uncompressed SIDs, which could not be compressed. In case the SR source node is able to compress all the SIDs in the SID list, the compressed SID list comprises only CSID sequences (one or more) and no uncompressed SIDs. Conversely, the compressed SID list comprises only uncompressed SIDs when the SR source is unable to compress any of the constituent SIDs.</t>
    </section>
    <section anchor="sec-endpoint">
      <name>SR Segment Endpoint Flavors</name>
      <t>This section defines two SR segment endpoint flavors: NEXT-CSID and REPLACE-CSID, for the End, End.X, End.T, End.B6.Encaps, End.B6.Encaps.Red, and End.BM behaviors of <xref target="RFC8986"/>.</t>
      <t>This section also defines a REPLACE-CSID flavor for the End.DX6, End.DX4, End.DT6, End.DT4, End.DT46, End.DX2, End.DX2V, End.DT2U, and End.DT2M behaviors of <xref target="RFC8986"/>.
A counterpart NEXT-CSID flavor is not defined for these behaviors. Any SID can be the last element of a CSID sequence compressed using the NEXT-CSID flavor (see <xref target="sec-next"/>) and the aforementioned SRv6 endpoint behaviors are always in the last position in a SID list; thus, there is no need for any modification of the behaviors defined in <xref target="RFC8986"/>.</t>
      <t>Future documents may extend the applicability of the NEXT-CSID and REPLACE-CSID flavors to other SRv6 endpoint behaviors (see <xref target="sec-future"/>).</t>
      <t>The use of these flavors, either individually or in combination, enables the compressed segment list encoding.</t>
      <t>The NEXT-CSID flavor and the REPLACE-CSID flavor both leverage the SID Argument to determine the next SID to be processed, but employ different SID list compression schemes.
With the NEXT-CSID flavor, each CSID container is a fully formed SRv6 SID with the common Locator-Block for all the CSIDs in the CSID container, a Locator-Node and Function that are those of the first CSID, and an Argument carrying the subsequent CSIDs.
With the REPLACE-CSID flavor, only the first element in a CSID sequence is a fully formed SRv6 SID. It has the common Locator-Block for all the CSIDs in the CSID sequence, and a Locator-Node and Function that are those of the first CSID. The remaining elements in the CSID sequence are CSID containers carrying the subsequent CSIDs without the Locator-Block.</t>
      <t>Regardless of which flavor is used, the IPv6 address carried in the Destination Address field of the IPv6 header is a valid SRv6 SID conforming to <xref target="RFC9602"/>.</t>
      <t>In the remainder of this document, the term "a SID of this document" refers to any End, End.X, End.T, End.B6.Encaps, End.B6.Encaps.Red, or End.BM SID with the NEXT-CSID or the REPLACE-CSID flavor and with any combination of Penultimate Segment Pop (PSP), Ultimate Segment Pop (USP), and Ultimate Segment Decapsulation (USD) flavor, or any End.DX6, End.DX4, End.DT6, End.DT4, End.DT46, End.DX2, End.DX2V, End.DT2U, or End.DT2M with the REPLACE-CSID flavor. All the SRv6 endpoint behaviors introduced in this document are listed in <xref target="tbl-iana-endpoint-behaviors"/>.</t>
      <t>In the remainder of this document, the terms "NEXT-CSID flavor SID" and "REPLACE-CSID flavor SID" refer to any SID of this document with the NEXT-CSID flavor and with the REPLACE-CSID flavor, respectively.</t>
      <section anchor="sec-next">
        <name>NEXT-CSID Flavor</name>
        <t>A CSID sequence compressed using the mechanism of the NEXT-CSID flavor comprises one or more CSID containers. Each CSID container is a fully formed 128-bit SID structured as shown in <xref target="fig-next-struct"/>. It carries a Locator-Block followed by a series of CSIDs. The Locator-Node and Function of the CSID container are those of the first CSID, and its Argument is the contiguous series of subsequent CSIDs. The second CSID is encoded in the most significant bits of the CSID container Argument.  The third CSID is encoded in the bits of the Argument that immediately follow the second CSID, and so on. When all CSIDs have the same length, a CSID container can carry up to K CSIDs, where K is computed as floor((128-LBL)/LNFL) (floor(x) is the greatest integer less than or equal to x <xref target="GKP94"/>). Each CSID container for NEXT-CSID is independent, such that contiguous CSID containers in a CSID sequence can be considered to be separate CSID sequences.</t>
        <t>When a CSID sequence compressed using the NEXT-CSID flavor comprises at least two CSIDs, the last CSID in the sequence is not required to have the NEXT-CSID flavor. It can be bound to any SRv6 endpoint behavior, including <xref target="RFC8986"/> behaviors and REPLACE-CSID flavor, as long as the updated Destination Address resulting from the processing of the previous CSID in the sequence is a valid form for that last SID. Line S12 of the first pseudocode in <xref target="sec-source-compression"/> provides sufficient conditions to ensure this property.</t>
        <figure anchor="fig-next-struct">
          <name>Structure of a NEXT-CSID Flavor SID (Scaled for a 48-Bit Locator&nbhy;Block, 16-Bit Combined Locator-Node and Function, and 64-Bit Argument)</name>
          <artset>
            <artwork type="svg"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="128" width="552" viewBox="0 0 552 128" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,80" fill="none" stroke="black"/>
                <path d="M 208,40 L 208,72" fill="none" stroke="black"/>
                <path d="M 280,40 L 280,72" fill="none" stroke="black"/>
                <path d="M 544,32 L 544,80" fill="none" stroke="black"/>
                <path d="M 8,32 L 544,32" fill="none" stroke="black"/>
                <path d="M 8,80 L 544,80" fill="none" stroke="black"/>
                <path d="M 16,96 L 200,96" fill="none" stroke="black"/>
                <path d="M 216,96 L 272,96" fill="none" stroke="black"/>
                <path d="M 288,96 L 536,96" fill="none" stroke="black"/>
                <polygon class="arrowhead" points="544,96 532,90.4 532,101.6" fill="black" transform="rotate(0,536,96)"/>
                <polygon class="arrowhead" points="296,96 284,90.4 284,101.6" fill="black" transform="rotate(180,288,96)"/>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"/>
                <polygon class="arrowhead" points="224,96 212,90.4 212,101.6" fill="black" transform="rotate(180,216,96)"/>
                <polygon class="arrowhead" points="208,96 196,90.4 196,101.6" fill="black" transform="rotate(0,200,96)"/>
                <polygon class="arrowhead" points="24,96 12,90.4 12,101.6" fill="black" transform="rotate(180,16,96)"/>
                <g class="text">
                  <text x="104" y="52">Locator-Block</text>
                  <text x="244" y="52">Loc-Node</text>
                  <text x="412" y="52">Argument</text>
                  <text x="244" y="68">Function</text>
                  <text x="104" y="116">LBL</text>
                  <text x="244" y="116">LNFL</text>
                  <text x="412" y="116">AL</text>
                </g>
              </svg>
            </artwork>
            <artwork type="ascii-art"><![CDATA[
+------------------------------------------------------------------+
|     Locator-Block      |Loc-Node|            Argument            |
|                        |Function|                                |
+------------------------------------------------------------------+
 <----------------------> <------> <------------------------------>
           LBL              LNFL                  AL
]]></artwork>
          </artset>
        </figure>
        <t><xref target="fig-next-csid-list"/> illustrates a compressed SID list as could be produced by an SR source node steering a packet into an SR policy with a SID list of eight NEXT-CSID flavor SIDs. All SIDs in this example have a 48-bit Locator-Block, 16-bit combined Locator-Node and Function, and 64-bit Argument. The SR source node compresses the SR policy SID list as a compressed SID list of two CSID containers. The first CSID container carries a Locator-Block and the first five CSIDs. The second CSID container carries a Locator-Block and the sixth, seventh, and eighth CSIDs. Since the SR source node does not use the second CSID container at full capacity, it sets the 32 least significant bits to zero. The SR source node sets the IPv6 Destination Address (DA) with the value of the first CSID container and the first element of the SRH Segment List with the value of the second CSID container. Without reduced SRH (see <xref target="RFC8754" sectionFormat="of" section="4.1.1"/>), the SR source node also writes the first CSID container as the second element of the SRH Segment List.</t>
        <t>Note that the CSIDs within a given CSID container appear in forward order to leverage the longest-prefix match IP forwarding, while the entries in the SRH Segment List appear in reversed order of their processing, as specified in <xref target="RFC8754" sectionFormat="of" section="4.1"/>.</t>
        <figure anchor="fig-next-csid-list">
          <name>Compressed SID List of Eight NEXT-CSID Flavor SIDs with a 48-Bit Locator&nbhy;Block, 16-Bit Combined Locator-Node and Function, and 64-Bit Argument</name>
          <artset>
            <artwork type="svg"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="432" width="528" viewBox="0 0 528 432" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,64 L 8,192" fill="none" stroke="black"/>
                <path d="M 8,272 L 8,400" fill="none" stroke="black"/>
                <path d="M 264,96 L 264,192" fill="none" stroke="black"/>
                <path d="M 264,304 L 264,368" fill="none" stroke="black"/>
                <path d="M 520,64 L 520,192" fill="none" stroke="black"/>
                <path d="M 520,272 L 520,400" fill="none" stroke="black"/>
                <path d="M 8,64 L 520,64" fill="none" stroke="black"/>
                <path d="M 264,96 L 520,96" fill="none" stroke="black"/>
                <path d="M 8,128 L 520,128" fill="none" stroke="black"/>
                <path d="M 8,160 L 520,160" fill="none" stroke="black"/>
                <path d="M 8,192 L 520,192" fill="none" stroke="black"/>
                <path d="M 8,272 L 520,272" fill="none" stroke="black"/>
                <path d="M 264,304 L 520,304" fill="none" stroke="black"/>
                <path d="M 8,336 L 520,336" fill="none" stroke="black"/>
                <path d="M 8,368 L 520,368" fill="none" stroke="black"/>
                <path d="M 8,400 L 520,400" fill="none" stroke="black"/>
                <g class="text">
                  <text x="16" y="36">0</text>
                  <text x="176" y="36">1</text>
                  <text x="336" y="36">2</text>
                  <text x="496" y="36">3</text>
                  <text x="16" y="52">0</text>
                  <text x="32" y="52">1</text>
                  <text x="48" y="52">2</text>
                  <text x="64" y="52">3</text>
                  <text x="80" y="52">4</text>
                  <text x="96" y="52">5</text>
                  <text x="112" y="52">6</text>
                  <text x="128" y="52">7</text>
                  <text x="144" y="52">8</text>
                  <text x="160" y="52">9</text>
                  <text x="176" y="52">0</text>
                  <text x="192" y="52">1</text>
                  <text x="208" y="52">2</text>
                  <text x="224" y="52">3</text>
                  <text x="240" y="52">4</text>
                  <text x="256" y="52">5</text>
                  <text x="272" y="52">6</text>
                  <text x="288" y="52">7</text>
                  <text x="304" y="52">8</text>
                  <text x="320" y="52">9</text>
                  <text x="336" y="52">0</text>
                  <text x="352" y="52">1</text>
                  <text x="368" y="52">2</text>
                  <text x="384" y="52">3</text>
                  <text x="400" y="52">4</text>
                  <text x="416" y="52">5</text>
                  <text x="432" y="52">6</text>
                  <text x="448" y="52">7</text>
                  <text x="464" y="52">8</text>
                  <text x="480" y="52">9</text>
                  <text x="496" y="52">0</text>
                  <text x="512" y="52">1</text>
                  <text x="136" y="100">Locator-Block</text>
                  <text x="368" y="116">1st</text>
                  <text x="404" y="116">CSID</text>
                  <text x="112" y="148">2nd</text>
                  <text x="148" y="148">CSID</text>
                  <text x="368" y="148">3rd</text>
                  <text x="404" y="148">CSID</text>
                  <text x="112" y="180">4th</text>
                  <text x="148" y="180">CSID</text>
                  <text x="368" y="180">5th</text>
                  <text x="404" y="180">CSID</text>
                  <text x="200" y="212">First</text>
                  <text x="244" y="212">CSID</text>
                  <text x="304" y="212">container</text>
                  <text x="16" y="244">0</text>
                  <text x="176" y="244">1</text>
                  <text x="336" y="244">2</text>
                  <text x="496" y="244">3</text>
                  <text x="16" y="260">0</text>
                  <text x="32" y="260">1</text>
                  <text x="48" y="260">2</text>
                  <text x="64" y="260">3</text>
                  <text x="80" y="260">4</text>
                  <text x="96" y="260">5</text>
                  <text x="112" y="260">6</text>
                  <text x="128" y="260">7</text>
                  <text x="144" y="260">8</text>
                  <text x="160" y="260">9</text>
                  <text x="176" y="260">0</text>
                  <text x="192" y="260">1</text>
                  <text x="208" y="260">2</text>
                  <text x="224" y="260">3</text>
                  <text x="240" y="260">4</text>
                  <text x="256" y="260">5</text>
                  <text x="272" y="260">6</text>
                  <text x="288" y="260">7</text>
                  <text x="304" y="260">8</text>
                  <text x="320" y="260">9</text>
                  <text x="336" y="260">0</text>
                  <text x="352" y="260">1</text>
                  <text x="368" y="260">2</text>
                  <text x="384" y="260">3</text>
                  <text x="400" y="260">4</text>
                  <text x="416" y="260">5</text>
                  <text x="432" y="260">6</text>
                  <text x="448" y="260">7</text>
                  <text x="464" y="260">8</text>
                  <text x="480" y="260">9</text>
                  <text x="496" y="260">0</text>
                  <text x="512" y="260">1</text>
                  <text x="136" y="308">Locator-Block</text>
                  <text x="368" y="324">6th</text>
                  <text x="404" y="324">CSID</text>
                  <text x="112" y="356">7th</text>
                  <text x="148" y="356">CSID</text>
                  <text x="368" y="356">8th</text>
                  <text x="404" y="356">CSID</text>
                  <text x="264" y="388">0</text>
                  <text x="204" y="420">Second</text>
                  <text x="252" y="420">CSID</text>
                  <text x="312" y="420">container</text>
                </g>
              </svg>
            </artwork>
            <artwork type="ascii-art"><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+         Locator-Block         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |           1st CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           2nd CSID            |           3rd CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           4th CSID            |           5th CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      First CSID Container

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+         Locator-Block         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |           6th CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           7th CSID            |           8th CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               0                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      Second CSID Container
]]></artwork>
          </artset>
        </figure>
        <t>An implementation <bcp14>MUST</bcp14> support a 32-bit LBL and a 16-bit CSID length (LNFL) for NEXT-CSID flavor SIDs, and it <bcp14>MAY</bcp14> support any additional Locator-Block and CSID length.</t>
        <t>The AL for NEXT-CSID flavor SIDs is equal to 128-LBL-LNFL.</t>
        <t>When processing an IPv6 packet that matches a Forwarding Information Base (FIB) entry locally instantiated as a SID with the NEXT-CSID flavor, the SR segment endpoint node applies the procedure specified in the following subsection that corresponds to the SID behavior. If the SID also has the PSP, USP, or USD flavor, the procedure is modified as described in <xref target="sec-next-flavors"/>.</t>
        <t>An SR segment endpoint node instantiating a SID of this document with the NEXT-CSID flavor <bcp14>MUST</bcp14> accept any Argument value for that SID.</t>
        <t>At a high level, for any SID with the NEXT-CSID flavor, the SR segment endpoint node determines the next SID of the SID list as follows. If the Argument value of the active SID is non-zero, the SR segment endpoint node constructs the next SID from the active SID by copying the entire SID Argument value to the bits that immediately follow the Locator-Block, thus overwriting the active SID Locator-Node and Function with those of the next CSID, and filling the least significant LNFL bits of the Argument with zeros. Otherwise (if the Argument value is 0), the SR segment endpoint node copies the next 128-bit Segment List entry from the SRH to the Destination Address field of the IPv6 header.</t>
        <section anchor="sec-next-end">
          <name>End with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End SID with the NEXT-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.1"/> is executed with the following modifications.</t>

	  

          <t>The below pseudocode is inserted between lines S01 and S02 of the SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.1"/>.  In addition, this pseudocode is executed before processing the first
header in the IPv6 extension header chain that is not an SRH, a Hop-by-Hop header, or a Destination Options header.  If the IPv6
extension header chain does not include any header matching this
criterion, this pseudocode is executed before processing the upper-layer header.</t>
          <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.   Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
N09. }
]]></sourcecode>
          <aside>
            <t>Notes:</t>
            <ul spacing="normal">
              <li>
                <t><tt>DA.Argument</tt> identifies the value contained in the bits <tt>[(LBL+LNFL)..127]</tt> in the Destination Address of the IPv6 header.</t>
              </li>
	      
              <li>
                <t>The value in the Segments Left field of the SRH is not modified when <tt>DA.Argument</tt> in the received packet has a non-zero value.</t>
              </li>
            </ul>
          </aside>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-next-end-complete"/>.</t>
        </section>
        <section anchor="sec-next-endx">
          <name>End.X with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.X SID with the NEXT-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.2"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-next-end"/> of this document is modified by replacing line N08 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
N08.   Submit the packet to the IPv6 module for transmission to the
         new destination via a member of J.
]]></sourcecode>
          <aside>
            <t>Note: the variable J is defined in <xref target="RFC8986" sectionFormat="of" section="4.2"/>.</t>
          </aside>

	  

	  
          <t>The resulting pseudocode is inserted between lines S01 and S02 of the SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.1"/> after applying the modification described in <xref target="RFC8986" sectionFormat="of" section="4.2"/>. In addition, this pseudocode is executed before processing the first
header in the IPv6 extension header chain that is not an SRH, a Hop-by-Hop header, or a Destination Options header. If the IPv6
extension header chain does not include any header matching this
criterion, this pseudocode is executed before processing the upper-layer header.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-next-endx-complete"/>.</t>
        </section>
        <section anchor="sec-next-endt">
          <name>End.T with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.T SID with the NEXT-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.3"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-next-end"/> of this document is modified by replacing line N08 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
N08.1.   Set the packet's associated FIB table to T.
N08.2.   Submit the packet to the egress IPv6 FIB lookup for
           transmission to the new destination.
]]></sourcecode>
          <aside>
            <t>Note: the variable T is defined in <xref target="RFC8986" sectionFormat="of" section="4.3"/>.</t>
          </aside>
          <t>The resulting pseudocode is inserted between lines S01 and S02 of the SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.1"/> after applying the modification described in <xref target="RFC8986" sectionFormat="of" section="4.3"/>.  In addition, this pseudocode is executed before processing the first
header in the IPv6 extension header chain that is not an SRH, a Hop-by-Hop header, or a Destination Options header. If the IPv6
extension header chain does not include any header matching this
criterion, this pseudocode is executed before processing the upper-layer header.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-next-endt-complete"/>.</t>
        </section>
        <section anchor="sec-next-endb6">
          <name>End.B6.Encaps with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.B6.Encaps SID with the NEXT-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.13"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-next-end"/> of this document is modified by replacing line N08 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
N08.1.   Push a new IPv6 header with its own SRH containing B.
N08.2.   Set the outer IPv6 SA to A.
N08.3.   Set the outer IPv6 DA to the first SID of B.
N08.4.   Set the outer Payload Length, Traffic Class, Flow Label,
           Hop Limit, and Next Header fields.
N08.5.   Submit the packet to the egress IPv6 FIB lookup for
           transmission to the next destination.
]]></sourcecode>
          <aside>
            <t>Note: the variables A and B, as well as the values of the Payload Length, Traffic Class, Flow Label, Hop Limit, and Next Header are defined in <xref target="RFC8986" sectionFormat="of" section="4.13"/>.</t>
          </aside>
          <t>The resulting pseudocode is inserted between lines S01 and S02 of the SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.13"/>.  In addition, this pseudocode is executed before processing the first
header in the IPv6 extension header chain that is not an SRH, a Hop-by-Hop header, or a Destination Options header. If the IPv6
extension header chain does not include any header matching this
criterion, this pseudocode is executed before processing the upper-layer header.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-next-endb6-complete"/>.</t>
          <t>Similar to the base End.B6.Encaps SID defined in <xref target="RFC8986" sectionFormat="of" section="4.13"/>, the NEXT-CSID flavor variant updates the Destination Address field of the inner IPv6 header to the next SID in the original segment list before encapsulating the packet with the segment list of SR Policy B. At the endpoint of SR Policy B, the encapsulation is removed and the inner packet is forwarded towards the exposed Destination Address, which already contains the next SID in the original segment list.</t>
        </section>
        <section anchor="sec-next-endb6red">
          <name>End.B6.Encaps.Red with NEXT-CSID</name>
          <t>This is an optimization of the End.B6.Encaps with NEXT-CSID behavior.</t>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.B6.Encaps.Red SID with the NEXT-CSID flavor, the procedure described in <xref target="sec-next-endb6"/> of this document is executed with the modifications in <xref target="RFC8986" sectionFormat="of" section="4.14"/>.</t>
        </section>
        <section anchor="sec-next-endbm">
          <name>End.BM with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.BM SID with the NEXT-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.15"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-next-end"/> of this document is modified by replacing line N08 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
N08.1.   Push the MPLS label stack for B.
N08.2.   Submit the packet to the MPLS engine for transmission.
]]></sourcecode>
          <aside>
            <t>Note: the variable B is defined in <xref target="RFC8986" sectionFormat="of" section="4.15"/>.</t>
          </aside>
          <t>The resulting pseudocode is inserted between lines S01 and S02 of the SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.15"/>. In addition, this pseudocode is executed before processing the first
header in the IPv6 extension header chain that is not an SRH, a Hop-by-Hop header, or a Destination Options header. If the IPv6
extension header chain does not include any header matching this
criterion, this pseudocode is executed before processing the upper-layer header.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-next-endbm-complete"/>.</t>
        </section>
        <section anchor="sec-next-flavors">
          <name>Combination with PSP, USP, and USD Flavors</name>
	  
	  

	  <dl spacing="normal" newline="false">
            <dt>PSP:</dt><dd>The PSP flavor defined in <xref target="RFC8986"
            sectionFormat="of" section="4.16.1"/> is unchanged when combined
            with the NEXT-CSID flavor.</dd>
            <dt>USP:</dt><dd>The USP flavor defined in <xref target="RFC8986"
            sectionFormat="of" section="4.16.2"/> is unchanged when combined
            with the NEXT-CSID flavor.</dd>
            <dt>USD:</dt><dd>The USD flavor defined in <xref target="RFC8986"
            sectionFormat="of" section="4.16.3"/> is unchanged when combined
            with the NEXT-CSID flavor.</dd>
	  </dl>

        </section>
      </section>
      <section anchor="sec-replace">
        <name>REPLACE-CSID Flavor</name>
	
        <t>A CSID sequence compressed using the mechanism of the REPLACE-CSID flavor starts with a CSID container in fully formed 128-bit SID format. The Locator-Block of this SID is the common Locator-Block for all the CSIDs in the CSID sequence, its Locator-Node and Function are those of the first CSID, and its Argument carries the index of the current CSID in the current CSID container. The Argument value is initially 0. When more segments are present in the segment list, the CSID sequence continues with one or more CSID containers in packed format carrying the series of subsequent CSIDs. Each container in packed format is a 128-bit Segment List entry split into K "positions" of LNFL bits, where K is computed as floor(128/LNFL). If LNFL does not divide into 128 perfectly, a zero pad is added in the least significant bits of the CSID container to fill the bits left over. The second CSID in the CSID sequence is encoded in the least significant bit position of the first CSID container in packed format (position K-1), the third CSID is encoded in position K-2, and so on.</t>
        <t>The last CSID in the CSID sequence is not required to have the REPLACE-CSID flavor. It can be bound to any SRv6 endpoint behavior, including the behaviors described in <xref target="RFC8986"/> and NEXT-CSID flavor, as long as it meets the conditions defined in <xref target="sec-source-node"/>.</t>
        <t>The structure of a SID with the REPLACE-CSID flavor is shown in <xref target="fig-replace-struct"/>. The same structure is also that of the CSID container for REPLACE-CSID in fully formed 128-bit SID format.</t>
        <figure anchor="fig-replace-struct">
          <name>Structure of a REPLACE-CSID Flavor SID (Scaled for a 48-Bit Locator&nbhy;Block, 32-Bit Combined Locator-Node and Function, and 48-Bit Argument)</name>
          <artset>
            <artwork type="svg"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="128" width="560" viewBox="0 0 560 128" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,80" fill="none" stroke="black"/>
                <path d="M 208,40 L 208,72" fill="none" stroke="black"/>
                <path d="M 344,40 L 344,72" fill="none" stroke="black"/>
                <path d="M 552,32 L 552,80" fill="none" stroke="black"/>
                <path d="M 8,32 L 552,32" fill="none" stroke="black"/>
                <path d="M 8,80 L 552,80" fill="none" stroke="black"/>
                <path d="M 16,96 L 200,96" fill="none" stroke="black"/>
                <path d="M 216,96 L 336,96" fill="none" stroke="black"/>
                <path d="M 352,96 L 544,96" fill="none" stroke="black"/>
                <polygon class="arrowhead" points="552,96 540,90.4 540,101.6" fill="black" transform="rotate(0,544,96)"/>
                <polygon class="arrowhead" points="360,96 348,90.4 348,101.6" fill="black" transform="rotate(180,352,96)"/>
                <polygon class="arrowhead" points="344,96 332,90.4 332,101.6" fill="black" transform="rotate(0,336,96)"/>
                <polygon class="arrowhead" points="224,96 212,90.4 212,101.6" fill="black" transform="rotate(180,216,96)"/>
                <polygon class="arrowhead" points="208,96 196,90.4 196,101.6" fill="black" transform="rotate(0,200,96)"/>
                <polygon class="arrowhead" points="24,96 12,90.4 12,101.6" fill="black" transform="rotate(180,16,96)"/>
                <g class="text">
                  <text x="104" y="52">Locator-Block</text>
                  <text x="276" y="52">Locator-Node</text>
                  <text x="444" y="52">Argument</text>
                  <text x="240" y="68">+</text>
                  <text x="284" y="68">Function</text>
                  <text x="104" y="116">LBL</text>
                  <text x="276" y="116">LNFL</text>
                  <text x="444" y="116">AL</text>
                </g>
              </svg>
            </artwork>
            <artwork type="ascii-art"><![CDATA[
+-------------------------------------------------------------------+
|     Locator-Block      |  Locator-Node  |        Argument         |
|                        |   + Function   |                         |
+-------------------------------------------------------------------+
 <----------------------> <--------------> <----------------------->
           LBL                  LNFL                  AL
]]></artwork>
          </artset>
        </figure>
        <t>The structure of a CSID container for REPLACE-CSID in packed format is shown in <xref target="fig-replace-container"/>.</t>
        <figure anchor="fig-replace-container">
          <name>Structure of a CSID Container for REPLACE-CSID Using a 32-Bit CSID Length (K = 4)</name>
          <artset>
            <artwork type="svg"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="128" width="560" viewBox="0 0 560 128" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,80" fill="none" stroke="black"/>
                <path d="M 144,40 L 144,72" fill="none" stroke="black"/>
                <path d="M 280,40 L 280,72" fill="none" stroke="black"/>
                <path d="M 416,40 L 416,72" fill="none" stroke="black"/>
                <path d="M 552,32 L 552,80" fill="none" stroke="black"/>
                <path d="M 8,32 L 552,32" fill="none" stroke="black"/>
                <path d="M 8,80 L 552,80" fill="none" stroke="black"/>
                <path d="M 16,96 L 136,96" fill="none" stroke="black"/>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"/>
                <path d="M 288,96 L 408,96" fill="none" stroke="black"/>
                <path d="M 424,96 L 544,96" fill="none" stroke="black"/>
                <polygon class="arrowhead" points="552,96 540,90.4 540,101.6" fill="black" transform="rotate(0,544,96)"/>
                <polygon class="arrowhead" points="432,96 420,90.4 420,101.6" fill="black" transform="rotate(180,424,96)"/>
                <polygon class="arrowhead" points="416,96 404,90.4 404,101.6" fill="black" transform="rotate(0,408,96)"/>
                <polygon class="arrowhead" points="296,96 284,90.4 284,101.6" fill="black" transform="rotate(180,288,96)"/>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"/>
                <polygon class="arrowhead" points="160,96 148,90.4 148,101.6" fill="black" transform="rotate(180,152,96)"/>
                <polygon class="arrowhead" points="144,96 132,90.4 132,101.6" fill="black" transform="rotate(0,136,96)"/>
                <polygon class="arrowhead" points="24,96 12,90.4 12,101.6" fill="black" transform="rotate(180,16,96)"/>
                <g class="text">
                  <text x="52" y="52">Fourth</text>
                  <text x="100" y="52">CSID</text>
                  <text x="192" y="52">Third</text>
                  <text x="236" y="52">CSID</text>
                  <text x="324" y="52">Second</text>
                  <text x="372" y="52">CSID</text>
                  <text x="464" y="52">First</text>
                  <text x="508" y="52">CSID</text>
                  <text x="64" y="68">(position</text>
                  <text x="116" y="68">0)</text>
                  <text x="200" y="68">(position</text>
                  <text x="252" y="68">1)</text>
                  <text x="336" y="68">(position</text>
                  <text x="388" y="68">2)</text>
                  <text x="472" y="68">(position</text>
                  <text x="524" y="68">3)</text>
                  <text x="76" y="116">LNFL</text>
                  <text x="212" y="116">LNFL</text>
                  <text x="348" y="116">LNFL</text>
                  <text x="484" y="116">LNFL</text>
                </g>
              </svg>
            </artwork>
            <artwork type="ascii-art"><![CDATA[
+-------------------------------------------------------------------+
|  Fourth CSID   |   Third CSID   |  Second CSID   |   First CSID   |
|  (position 0)  |  (position 1)  |  (position 2)  |  (position 3)  |
+-------------------------------------------------------------------+
 <--------------> <--------------> <--------------> <-------------->
       LNFL             LNFL             LNFL             LNFL
]]></artwork>
          </artset>
        </figure>
        <t><xref target="fig-replace-csid-list"/> illustrates a compressed SID list as could be produced by an SR source node steering a packet into an SR policy SID list of seven REPLACE-CSID flavor SIDs. All SIDs in this example have a 48-bit Locator-Block, 32-bit combined Locator-Node and Function, and 48-bit Argument. The SR source node compresses the SR policy SID list as a compressed SID list of three CSID containers. The first CSID container is in fully formed 128-bit SID format. It carries a Locator-Block, the first CSID, and the argument value zero. The second and third CSID containers are in packed format. The second CSID container carries the second, third, fourth, and fifth CSIDs. The third CSID container carries the sixth and seventh CSIDs. Since the SR source node does not use the third CSID container at full capacity, it sets the 64 least significant bits to zero. The SR source node sets the IPv6 DA with the value of the first CSID container, sets the first element in the SRH Segment List with the value of the third CSID container, and sets the second element of the SRH Segment List with the value of the second CSID container (the elements in the SRH Segment List appear in reversed order of their processing, as specified in <xref target="RFC8754" sectionFormat="of" section="4.1"/>). Without reduced SRH, the SR source node also writes the first CSID container as the third element of the SRH Segment List.</t>
        <figure anchor="fig-replace-csid-list">
          <name>Compressed SID List of Seven REPLACE-CSID Flavor SIDs with a 48-Bit Locator&nbhy;Block, 32-Bit Combined Locator-Node and Function, and 48-Bit Argument</name>
          <artset>
            <artwork type="svg"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="640" width="528" viewBox="0 0 528 640" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,64 L 8,192" fill="none" stroke="black"/>
                <path d="M 8,272 L 8,400" fill="none" stroke="black"/>
                <path d="M 8,480 L 8,608" fill="none" stroke="black"/>
                <path d="M 264,96 L 264,160" fill="none" stroke="black"/>
                <path d="M 520,64 L 520,192" fill="none" stroke="black"/>
                <path d="M 520,272 L 520,400" fill="none" stroke="black"/>
                <path d="M 520,480 L 520,608" fill="none" stroke="black"/>
                <path d="M 8,64 L 520,64" fill="none" stroke="black"/>
                <path d="M 264,96 L 520,96" fill="none" stroke="black"/>
                <path d="M 8,128 L 520,128" fill="none" stroke="black"/>
                <path d="M 8,160 L 264,160" fill="none" stroke="black"/>
                <path d="M 8,192 L 520,192" fill="none" stroke="black"/>
                <path d="M 8,272 L 520,272" fill="none" stroke="black"/>
                <path d="M 8,304 L 520,304" fill="none" stroke="black"/>
                <path d="M 8,336 L 520,336" fill="none" stroke="black"/>
                <path d="M 8,368 L 520,368" fill="none" stroke="black"/>
                <path d="M 8,400 L 520,400" fill="none" stroke="black"/>
                <path d="M 8,480 L 520,480" fill="none" stroke="black"/>
                <path d="M 8,544 L 520,544" fill="none" stroke="black"/>
                <path d="M 8,576 L 520,576" fill="none" stroke="black"/>
                <path d="M 8,608 L 520,608" fill="none" stroke="black"/>
                <g class="text">
                  <text x="16" y="36">0</text>
                  <text x="176" y="36">1</text>
                  <text x="336" y="36">2</text>
                  <text x="496" y="36">3</text>
                  <text x="16" y="52">0</text>
                  <text x="32" y="52">1</text>
                  <text x="48" y="52">2</text>
                  <text x="64" y="52">3</text>
                  <text x="80" y="52">4</text>
                  <text x="96" y="52">5</text>
                  <text x="112" y="52">6</text>
                  <text x="128" y="52">7</text>
                  <text x="144" y="52">8</text>
                  <text x="160" y="52">9</text>
                  <text x="176" y="52">0</text>
                  <text x="192" y="52">1</text>
                  <text x="208" y="52">2</text>
                  <text x="224" y="52">3</text>
                  <text x="240" y="52">4</text>
                  <text x="256" y="52">5</text>
                  <text x="272" y="52">6</text>
                  <text x="288" y="52">7</text>
                  <text x="304" y="52">8</text>
                  <text x="320" y="52">9</text>
                  <text x="336" y="52">0</text>
                  <text x="352" y="52">1</text>
                  <text x="368" y="52">2</text>
                  <text x="384" y="52">3</text>
                  <text x="400" y="52">4</text>
                  <text x="416" y="52">5</text>
                  <text x="432" y="52">6</text>
                  <text x="448" y="52">7</text>
                  <text x="464" y="52">8</text>
                  <text x="480" y="52">9</text>
                  <text x="496" y="52">0</text>
                  <text x="512" y="52">1</text>
                  <text x="136" y="100">Locator-Block</text>
                  <text x="368" y="116">1st</text>
                  <text x="404" y="116">CSID</text>
                  <text x="72" y="148">1st</text>
                  <text x="108" y="148">CSID</text>
                  <text x="168" y="148">continued</text>
                  <text x="392" y="164">0</text>
                  <text x="200" y="212">First</text>
                  <text x="244" y="212">CSID</text>
                  <text x="304" y="212">container</text>
                  <text x="16" y="244">0</text>
                  <text x="176" y="244">1</text>
                  <text x="336" y="244">2</text>
                  <text x="496" y="244">3</text>
                  <text x="16" y="260">0</text>
                  <text x="32" y="260">1</text>
                  <text x="48" y="260">2</text>
                  <text x="64" y="260">3</text>
                  <text x="80" y="260">4</text>
                  <text x="96" y="260">5</text>
                  <text x="112" y="260">6</text>
                  <text x="128" y="260">7</text>
                  <text x="144" y="260">8</text>
                  <text x="160" y="260">9</text>
                  <text x="176" y="260">0</text>
                  <text x="192" y="260">1</text>
                  <text x="208" y="260">2</text>
                  <text x="224" y="260">3</text>
                  <text x="240" y="260">4</text>
                  <text x="256" y="260">5</text>
                  <text x="272" y="260">6</text>
                  <text x="288" y="260">7</text>
                  <text x="304" y="260">8</text>
                  <text x="320" y="260">9</text>
                  <text x="336" y="260">0</text>
                  <text x="352" y="260">1</text>
                  <text x="368" y="260">2</text>
                  <text x="384" y="260">3</text>
                  <text x="400" y="260">4</text>
                  <text x="416" y="260">5</text>
                  <text x="432" y="260">6</text>
                  <text x="448" y="260">7</text>
                  <text x="464" y="260">8</text>
                  <text x="480" y="260">9</text>
                  <text x="496" y="260">0</text>
                  <text x="512" y="260">1</text>
                  <text x="240" y="292">5th</text>
                  <text x="276" y="292">CSID</text>
                  <text x="240" y="324">4th</text>
                  <text x="276" y="324">CSID</text>
                  <text x="240" y="356">3rd</text>
                  <text x="276" y="356">CSID</text>
                  <text x="240" y="388">2nd</text>
                  <text x="276" y="388">CSID</text>
                  <text x="204" y="420">Second</text>
                  <text x="252" y="420">CSID</text>
                  <text x="312" y="420">container</text>
                  <text x="16" y="452">0</text>
                  <text x="176" y="452">1</text>
                  <text x="336" y="452">2</text>
                  <text x="496" y="452">3</text>
                  <text x="16" y="468">0</text>
                  <text x="32" y="468">1</text>
                  <text x="48" y="468">2</text>
                  <text x="64" y="468">3</text>
                  <text x="80" y="468">4</text>
                  <text x="96" y="468">5</text>
                  <text x="112" y="468">6</text>
                  <text x="128" y="468">7</text>
                  <text x="144" y="468">8</text>
                  <text x="160" y="468">9</text>
                  <text x="176" y="468">0</text>
                  <text x="192" y="468">1</text>
                  <text x="208" y="468">2</text>
                  <text x="224" y="468">3</text>
                  <text x="240" y="468">4</text>
                  <text x="256" y="468">5</text>
                  <text x="272" y="468">6</text>
                  <text x="288" y="468">7</text>
                  <text x="304" y="468">8</text>
                  <text x="320" y="468">9</text>
                  <text x="336" y="468">0</text>
                  <text x="352" y="468">1</text>
                  <text x="368" y="468">2</text>
                  <text x="384" y="468">3</text>
                  <text x="400" y="468">4</text>
                  <text x="416" y="468">5</text>
                  <text x="432" y="468">6</text>
                  <text x="448" y="468">7</text>
                  <text x="464" y="468">8</text>
                  <text x="480" y="468">9</text>
                  <text x="496" y="468">0</text>
                  <text x="512" y="468">1</text>
                  <text x="264" y="516">0</text>
                  <text x="240" y="564">7th</text>
                  <text x="276" y="564">CSID</text>
                  <text x="240" y="596">6th</text>
                  <text x="276" y="596">CSID</text>
                  <text x="200" y="628">Third</text>
                  <text x="244" y="628">CSID</text>
                  <text x="304" y="628">container</text>
                </g>
              </svg>
            </artwork>
            <artwork type="ascii-art"><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+         Locator-Block         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |           1st CSID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      1st CSID continued       |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               0               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      First CSID Container

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           5th CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           4th CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           3rd CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           2nd CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      Second CSID Container

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                               0                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           7th CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           6th CSID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      Third CSID Container
]]></artwork>
          </artset>
        </figure>
        <t>This document updates <xref target="RFC8754"/> by allowing each entry in the SRH Segment List to be either an IPv6 address or a REPLACE-CSID container in packed format. The SRv6 endpoint behaviors specified herein ensure that this entry is never copied as is to the IPv6 header and that the Destination Address field of the IPv6 header is always a valid SRv6 SID conforming to <xref target="RFC9602"/>.</t>
        <t>The REPLACE-CSID flavor SIDs support any LBL, depending on the needs of the operator, as long as it does not exceed 128-LNFL-ceiling(log_2(128/LNFL)) (ceiling(x) is the least integer greater than or equal to x <xref target="GKP94"/>), so that enough bits remain available for the CSID and Argument. An LBL of 48, 56, 64, 72, or 80 bits is recommended for easier reading in operation.</t>
        <t>This document defines the REPLACE-CSID flavor for 16-bit and 32-bit CSID lengths (LNFL). An implementation <bcp14>MUST</bcp14> support a 32-bit CSID length for REPLACE-CSID flavor SIDs.</t>
        <t>The AL for REPLACE-CSID flavor SIDs is equal to 128-LBL-LNFL. The index value is encoded in the least significant X bits of the Argument, where X is computed as ceiling(log_2(128/LNFL)).</t>
        <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as a SID with the REPLACE-CSID flavor, the SR segment endpoint node applies the procedure specified in the following subsection that corresponds to the SID behavior. If the SID also has the PSP, USP, or USD flavor, the procedure is modified as described in <xref target="sec-replace-flavors"/>.</t>
        <t>At a high level, at the start of a CSID sequence using the REPLACE-CSID flavor, the first CSID container in fully formed 128-bit SID format is copied to the Destination Address of the IPv6 header. Then, for any SID with the REPLACE-CSID flavor, the SR segment endpoint node determines the next SID of the SID list as follows. When an SRH is present, the SR segment endpoint node decrements the index value in the Argument of the active SID if the index value is not 0 or, if it is 0, decrements the Segments Left value in the SRH and sets the index value in the Argument of the active SID to K-1. The updated index value indicates the position of the next CSID within the CSID container in packed format at the "Segment List" index "Segments Left" in the SRH. The SR segment endpoint node then constructs the next SID by copying this next CSID to the bits that immediately follow the Locator-Block in the Destination Address field of the IPv6 header, thus overwriting the active SID Locator-Node and Function with those of the next CSID. If no SRH is present, the SR segment endpoint node ignores the index value in the SID Argument (except End.DT2M, see <xref target="sec-replace-enddx"/>) and processes the upper-layer header as per <xref target="RFC8986"/>. The CSID sequence ends with a last CSID in the last CSID container that does not have the REPLACE-CSID flavor, or with the special CSID value 0, or when reaching the end of the segment list, whichever comes first.</t>
        <section anchor="sec-replace-end">
          <name>End with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End SID with the REPLACE-CSID flavor, the SRH processing described in <xref target="RFC8986" sectionFormat="of" section="4.1"/> is executed with the following modifications.</t>
          <t>Line S02 of SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.1"/> is replaced as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
]]></sourcecode>
          <t>Lines S09 to S15 are replaced by the following pseudocode.</t>
          <sourcecode type="pseudocode"><![CDATA[
R01. If (DA.Arg.Index != 0) {
R02.   If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.     Send an ICMP Parameter Problem to the Source Address,
           Code 0 (Erroneous header field encountered),
           Pointer set to the Segments Left field,
           interrupt packet processing and discard the packet.
R04.   }
R05.   Decrement DA.Arg.Index by 1.
R06.   If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.     Decrement Segments Left by 1.
R08.     Decrement IPv6 Hop Limit by 1.
R09.     Update IPv6 DA with Segment List[Segments Left]
R10.     Submit the packet to the egress IPv6 FIB lookup for
          transmission to the new destination.
R11.   }
R12. } Else {
R13.   If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.     Send an ICMP Parameter Problem to the Source Address,
           Code 0 (Erroneous header field encountered),
           Pointer set to the Segments Left field,
           interrupt packet processing and discard the packet.
R15.   }
R16.   Decrement Segments Left by 1.
R17.   Set DA.Arg.Index to (floor(128/LNFL) - 1).
R18. }
R19. Decrement IPv6 Hop Limit by 1.
R20. Write Segment List[Segments Left][DA.Arg.Index] into the bits
       [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
       header.
R21. Submit the packet to the egress IPv6 FIB lookup for
       transmission to the new destination.
]]></sourcecode>
          <aside>
            <t>Notes:</t>
            <ul spacing="normal">
              <li>
                <t><tt>DA.Arg.Index</tt> identifies the value contained in the bits <tt>[(128-ceiling(log_2(128/LNFL)))..127]</tt> in the Destination Address of the IPv6 header.</t>
              </li>
              <li>
                <t><tt>Segment List[Segments Left][DA.Arg.Index]</tt> identifies the value contained in the bits <tt>[DA.Arg.Index*LNFL..(DA.Arg.Index+1)*LNFL-1]</tt> in the SRH Segment List entry at index Segments Left.</t>
              </li>
            </ul>
          </aside>
          <t>The upper-layer header processing described in <xref target="RFC8986" sectionFormat="of" section="4.1.1"/> is unchanged.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-replace-end-complete"/>.</t>
        </section>
        <section anchor="sec-replace-endx">
          <name>End.X with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.X SID with the REPLACE-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.2"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-replace-end"/> of this document is modified by replacing lines R10 and R21 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
R10. Submit the packet to the IPv6 module for transmission to the
       new destination via a member of J.
]]></sourcecode>
          <sourcecode type="pseudocode"><![CDATA[
R21. Submit the packet to the IPv6 module for transmission to the
       new destination via a member of J.
]]></sourcecode>
          <aside>
            <t>Note: the variable J is defined in <xref target="RFC8986" sectionFormat="of" section="4.2"/>.</t>
          </aside>
          <t>The SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.2"/> is replaced with the resulting pseudocode. The upper-layer header processing is unchanged.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-replace-endx-complete"/>.</t>
        </section>
        <section anchor="sec-replace-endt">
          <name>End.T with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.T SID with the REPLACE-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.3"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-replace-end"/> of this document is modified by replacing lines R10 and R21 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
R10.1. Set the packet's associated FIB table to T.
R10.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
]]></sourcecode>
          <sourcecode type="pseudocode"><![CDATA[
R21.1. Set the packet's associated FIB table to T.
R21.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
]]></sourcecode>
          <aside>
            <t>Note: the variable T is defined in <xref target="RFC8986" sectionFormat="of" section="4.3"/>.</t>
          </aside>
          <t>The SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.3"/> is replaced with the resulting pseudocode. The upper-layer header processing is unchanged.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-replace-endt-complete"/>.</t>
        </section>
        <section anchor="sec-replace-endb6">
          <name>End.B6.Encaps with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.B6.Encaps SID with the REPLACE-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.13"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-replace-end"/> of this document is modified by replacing lines R10 and R21 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
R10.1. Push a new IPv6 header with its own SRH containing B.
R10.2. Set the outer IPv6 SA to A.
R10.3. Set the outer IPv6 DA to the first SID of B.
R10.4. Set the outer Payload Length, Traffic Class, Flow Label,
         Hop Limit, and Next Header fields.
R10.5. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
]]></sourcecode>
          <sourcecode type="pseudocode"><![CDATA[
R21.1. Push a new IPv6 header with its own SRH containing B.
R21.2. Set the outer IPv6 SA to A.
R21.3. Set the outer IPv6 DA to the first SID of B.
R21.4. Set the outer Payload Length, Traffic Class, Flow Label,
         Hop Limit, and Next Header fields.
R21.5. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
]]></sourcecode>
          <aside>
            <t>Note: the variables A and B, as well as the values of the Payload Length, Traffic Class, Flow Label, Hop Limit, and Next Header are defined in <xref target="RFC8986" sectionFormat="of" section="4.13"/>.</t>
          </aside>
          <t>The SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.13"/> is replaced with the resulting pseudocode. The upper-layer header processing is unchanged.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-replace-endb6-complete"/>.</t>
        </section>
        <section anchor="sec-replace-endb6red">
          <name>End.B6.Encaps.Red with REPLACE-CSID</name>
          <t>This is an optimization of the End.B6.Encaps with REPLACE-CSID behavior.</t>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.B6.Encaps.Red SID with the REPLACE-CSID flavor, the procedure described in <xref target="sec-replace-endb6"/> of this document is executed with the modifications in <xref target="RFC8986" sectionFormat="of" section="4.14"/>.</t>
        </section>
        <section anchor="sec-replace-endbm">
          <name>End.BM with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.BM SID with the REPLACE-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.15"/> is executed with the following modifications.</t>
          <t>The pseudocode in <xref target="sec-replace-end"/> of this document is modified by replacing lines R10 and R21 as shown below.</t>
          <sourcecode type="pseudocode"><![CDATA[
R10.1. Push the MPLS label stack for B.
R10.2. Submit the packet to the MPLS engine for transmission.
]]></sourcecode>
          <sourcecode type="pseudocode"><![CDATA[
R21.1. Push the MPLS label stack for B.
R21.2. Submit the packet to the MPLS engine for transmission.
]]></sourcecode>
          <aside>
            <t>Note: the variable B is defined in <xref target="RFC8986" sectionFormat="of" section="4.15"/>.</t>
          </aside>
          <t>The SRH processing in <xref target="RFC8986" sectionFormat="of" section="4.15"/> is replaced with the resulting pseudocode. The upper-layer header processing is unchanged.</t>
          <t>A rendering of the complete pseudocode is provided in <xref target="sec-replace-endbm-complete"/>.</t>
        </section>
        <section anchor="sec-replace-enddx">
          <name>End.DX and End.DT with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.DX6, End.DX4, End.DT6, End.DT4, End.DT46, End.DX2, End.DX2V, or End.DT2U SID with the REPLACE-CSID flavor, the corresponding procedure described in Sections <xref target="RFC8986" sectionFormat="bare" section="4.4"/> through <xref target="RFC8986" sectionFormat="bare" section="4.11"/> of <xref target="RFC8986"/> is executed.</t>
          <t>These SIDs differ from those defined in <xref target="RFC8986"/> by the presence of an Argument as part of the SID structure. The Argument value is ignored by the SR segment endpoint node.</t>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.DT2M SID with the REPLACE-CSID flavor, the procedure described in <xref target="RFC8986" sectionFormat="of" section="4.12"/> is executed with the following modification.</t>
          <t>For any End.DT2M SID with the REPLACE-CSID flavor, the value of <tt>Arg.FE2</tt> is 16 bits long. The SR segment endpoint node obtains the value <tt>Arg.FE2</tt> from the 16 most significant bits of <tt>DA.Argument</tt> if <tt>DA.Arg.Index</tt> is zero or from the 16 least significant bits of the next position in the current CSID container (<tt>Segment List[Segments Left][DA.Arg.Index-1]</tt>) otherwise (<tt>DA.Arg.Index</tt> is non-zero).</t>
        </section>
        <section anchor="sec-replace-flavors">
          <name>Combination with PSP, USP, and USD Flavors</name>
          <t>PSP:
When combined with the REPLACE-CSID flavor, the additional PSP flavor instructions defined in <xref target="RFC8986" sectionFormat="of" section="4.16.1.2"/> are inserted after lines R09 and R20 of the pseudocode in <xref target="sec-replace-end"/>, and the first line of the inserted instructions after R20 is modified as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
R20.1.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
             Segment List[0][DA.Arg.Index-1] == 0)) {
]]></sourcecode>
          <aside>
            <t>Note: <tt>Segment List[Segments Left][DA.Arg.Index-1]</tt> identifies the value contained in the bits <tt>[(DA.Arg.Index-1)*LNFL..DA.Arg.Index*LNFL-1]</tt> in the SRH Segment List entry at index Segments Left.</t>
          </aside>

	  <dl spacing="normal" newline="false">
            <dt>USP:</dt><dd>When combined with the REPLACE-CSID flavor, the
            line S03 of the pseudocode in <xref target="sec-replace-end"/> are
            substituted by the USP flavor instructions S03.1 to S03.4 defined
            in <xref target="RFC8986" sectionFormat="of"
            section="4.16.2"/>. Note that S03 is shown in the complete
            pseudocode in <xref target="sec-replace-end-complete"/>.</dd>
            <dt>USD:</dt><dd>The USD flavor defined in <xref target="RFC8986"
            sectionFormat="of" section="4.16.3"/> is unchanged when combined
            with the REPLACE-CSID flavor.</dd>
	  </dl>

        </section>
      </section>
    </section>
    <section anchor="csid-allocation">
      <name>CSID Allocation</name>
      <t>The CSID value of 0 is reserved. It is used to indicate the end of a CSID container.</t>
      <t>In order to efficiently manage the CSID numbering space, a deployment may divide it into two non-overlapping sub-spaces: a GIB and a LIB.</t>
      <t>The CSID values that are allocated from the GIB have a global semantic within the Locator-Block, while those that are allocated from the LIB have a local semantic on an SR segment endpoint node and within the scope of the Locator-Block.</t>
      <t>The concept of LIB is applicable to SRv6 and specifically to its NEXT-CSID and REPLACE-CSID flavors. The shorter the CSID, the more benefit the LIB brings.</t>
      <t>The opportunity to use these sub-spaces, their size, and their CSID allocation policy depends on the CSID length relative to the size of the network (e.g., number of nodes, links, service routes). Some guidelines for a typical deployment scenario are provided in the below subsections.</t>
      <section anchor="global-csid">
        <name>Global CSID</name>
        <t>A global CSID is a CSID allocated from the GIB.</t>
        <t>A global CSID identifies a segment defined at the Locator-Block level. The tuple (Locator-Block, CSID) identifies the same segment across all nodes of the SR domain. A typical example is a prefix segment bound to the End behavior.</t>
        <t>A node can have multiple global CSIDs under the same Locator-Block (e.g., one per IGP flexible algorithm (<xref target="RFC9350"/>)). Multiple nodes may share the same global CSID (e.g., anycast <xref target="RFC4786"/>).</t>
      </section>
      <section anchor="local-csid">
        <name>Local CSID</name>
        <t>A local CSID is a CSID allocated from the LIB.</t>
        <t>A local CSID identifies a segment defined at the node level and within the scope of a particular Locator-Block. The tuple (Locator-Block, CSID) identifies a different segment on each node of the SR domain. A typical example is a non-routed Adjacency segment bound to the End.X behavior.</t>
        <t>Let N1 and N2 be two different physical nodes of the SR domain and I a local CSID value: N1 may allocate value I to SID S1 and N2 may allocate the same value I to SID S2.</t>
      </section>
      <section anchor="sec-csid-installation">
        <name>Recommended Installation of CSIDs in FIB</name>
        <t><xref target="RFC8754" sectionFormat="of" section="4.3"/> defines how an SR segment endpoint node identifies a locally instantiated SRv6 SID. To ensure that any valid argument value is accepted, an SR segment endpoint node instantiating a NEXT-CSID or REPLACE-CSID flavor SID should install a corresponding FIB entry that matches only the Locator and Function parts of the SID (i.e., with a prefix length of LBL + LNL + FL).</t>
        <t>In addition, an SR segment endpoint node instantiating NEXT-CSID flavor SIDs from both the GIB and LIB may install combined "Global + Local" FIB entries to match a sequence of global and local CSIDs in a single longest-prefix match (LPM) lookup.</t>
        <t>For example, let us consider an SR segment endpoint node 10 instantiating the following two NEXT-CSID flavor SIDs according to the CSID length, LBL, and GIB/LIB recommendations in this section.</t>
        <ul spacing="normal">
          <li>
            <t>The SID <tt>2001:db8:b1:10::</tt> bound to the End behavior with the NEXT-CSID flavor is instantiated from a GIB with:
            </t>
            <ul spacing="normal">
              <li>
                <t>LBL = 48 (Locator-Block value <tt>0x20010db800b1</tt>),</t>
              </li>
              <li>
                <t>LNL = 16 (Locator-Node value <tt>0x0010</tt>),</t>
              </li>
              <li>
                <t>FL = 0, and</t>
              </li>
              <li>
                <t>AL = 64.</t>
              </li>
            </ul>
          </li>
          <li>
            <t>The SID <tt>2001:db8:b1:f123::</tt> bound to the End.X behavior for its local IGP adjacency <tt>123</tt> with the NEXT-CSID flavor is instantiated from a LIB with:
            </t>
            <ul spacing="normal">
              <li>
                <t>LBL = 48 (Locator-Block value <tt>0x20010db800b1</tt>),</t>
              </li>
              <li>
                <t>LNL = 0,</t>
              </li>
              <li>
                <t>FL = 16 (Function value <tt>0xf123</tt>), and</t>
              </li>
              <li>
                <t>AL = 64.</t>
              </li>
            </ul>
          </li>
        </ul>

	
        <t>For SID <tt>2001:db8:b1:10::</tt>, Node 10 would install the FIB entry <tt>2001:db8:b1:10::/64</tt> bound to the End SID with the NEXT-CSID flavor.</t>
        <t>For SID <tt>2001:db8:b1:f123::</tt>, Node 10 would install the FIB entry <tt>2001:db8:b1:f123::/64</tt> bound to the End.X SID for adjacency <tt>123</tt> with the NEXT-CSID flavor.</t>
        <t>In addition, Node 10 may also install the combined FIB entry <tt>2001:db8:b1:10:f123::/80</tt> bound to the End.X SID for adjacency <tt>123</tt> with the NEXT-CSID flavor.</t>
        <t>As another example, let us consider an SR segment endpoint node 20 instantiating the following two REPLACE-CSID flavor SIDs according to the CSID length, LBL, and GIB/LIB recommendations in this section.</t>
        <ul spacing="normal">
          <li>
            <t><tt>2001:db8:b2:20:1::</tt> from a GIB with LBL = 48, LNL = 16, FL = 16, AL = 48, and bound to the End behavior with the REPLACE-CSID flavor.</t>
          </li>
          <li>
            <t><tt>2001:db8:b2:20:123::</tt> from a GIB with LBL = 48, LNL = 16, FL = 16, AL = 48, and bound to the End.X behavior for its local IGP adjacency <tt>123</tt> with the REPLACE-CSID flavor.</t>
          </li>
        </ul>
        <t>For SID <tt>2001:db8:b2:20:1::</tt>, Node 20 would install the FIB entry <tt>2001:db8:b2:20:1::/80</tt> bound to the End SID with the REPLACE-CSID flavor.</t>
        <t>For SID <tt>2001:db8:b2:20:123::</tt>, Node 20 would install the FIB entry <tt>2001:db8:b2:20:123::/80</tt> bound to the End.X SID for adjacency <tt>123</tt> with the REPLACE-CSID flavor.</t>
      </section>
    </section>
    <section anchor="sec-source-node">
      <name>SR Source Node</name>
      <t>An SR source node may learn from a control plane protocol (see <xref target="sec-control-plane"/>) or local configuration the SIDs that it can use in a segment list, along with their respective SRv6 endpoint behavior, structure, and any other relevant attribute (e.g., the set of L3 adjacencies associated with an End.X SID).</t>
      <section anchor="sid-validation-for-compression">
        <name>SID Validation for Compression</name>
        <t>As part of the compression process or as a preliminary step, the SR source node <bcp14>MUST</bcp14> validate the SID structure of each SID of this document in the segment list. The SR source node does so regardless of whether the segment list is explicitly configured, locally computed, or advertised by a controller (e.g., via BGP <xref target="I-D.ietf-idr-sr-policy-safi"/> or PCEP <xref target="RFC9603"/>).</t>
        <t>A SID structure is valid for compression if it meets all the following conditions:</t>
        <ul spacing="normal">
          <li>
            <t>The LBL is not 0.</t>
          </li>
          <li>
            <t>The LNFL is not 0.</t>
          </li>
          <li>
            <t>The AL is equal to 128-LBL-LNL-FL.</t>
          </li>
        </ul>
        <t>When compressing a SID list, the SR source node <bcp14>MUST</bcp14> treat an invalid SID structure as unknown. A SID with an unknown SID structure is  not compressible.</t>
        <t><xref target="sec-control-plane"/> discusses how the SIDs of this document and their structure can be advertised to the SR source node through various control plane protocols. The SID structure may also be learned through configuration or
other management protocols. The details of such mechanisms are outside the scope of this document.</t>
      </section>
      <section anchor="sec-source-compression">
        <name>Segment List Compression</name>
        <t>An SR source node <bcp14>MAY</bcp14> compress a SID list when it includes NEXT-CSID and/or REPLACE-CSID flavor SIDs to reduce the packet header length.</t>
        <t>It is out of the scope of this document to describe the mechanism through which an uncompressed SID list is derived, since such a mechanism may include a wide range of considerations independent of compression (e.g., minimizing a specific metric, excluding certain links, or providing a loop-free fast-reroute path). As general guidance for implementation or future specification, such a mechanism should aim to select the combination of SIDs that would result in the shortest compressed SID list. For example, by selecting a CSID flavor SID over an equivalent non-CSID flavor SID or by consistently selecting SIDs of the same CSID flavor within each routing domain.</t>
        <t>The SID list that the SR source node pushes onto the packet <bcp14>MUST</bcp14> comply with the rules in Sections <xref target="sec-source-next" format="counter"/> and <xref target="sec-source-replace" format="counter"/> and express the same list of segments as the original SID list. If these rules are not followed, the packet may get dropped or misrouted.</t>
        <t>If an SR source node chooses to compress the SID list, one method is described below for illustrative purposes. Any other method producing a compressed SID list of equal or shorter length than the uncompressed SID list <bcp14>MAY</bcp14> be used.</t>
        <t>This method walks the uncompressed SID list and compresses each series of consecutive NEXT-CSID flavor SIDs and each series of consecutive REPLACE-CSID flavor SIDs.</t>
        <ul spacing="normal">
          <li><t>When the compression method encounters a series of one or
          more consecutive compressible NEXT-CSID flavor SIDs, it compresses
          the series as follows. A SID with the NEXT-CSID flavor is
          compressible if its structure is known to the SR source node and its
          Argument value is 0.</t>

        <sourcecode type="pseudocode"><![CDATA[
S01. Initialize a NEXT-CSID container equal to the first SID in
       the series and initialize the remaining capacity of the
       CSID container to the AL of that SID
S02. For each subsequent SID in the series {
S03.   If the current SID Locator-Block matches that of the CSID
         container and the current SID LNFL is lower than or equal
         to the remaining capacity of the NEXT-CSID container {
S04.     Copy the current SID Locator-Node and Function to the
           most significant remaining Argument bits of the
           NEXT-CSID container and decrement the remaining
           capacity by LNFL
S05.   } Else {
S06.     Push the NEXT-CSID container onto the compressed SID list
S07.     Initialize a new NEXT-CSID container equal to the current
           SID in the series and initialize the remaining capacity
           of the NEXT-CSID container to the AL of that SID
S08.   } // End If
S09. } // End For
S10. If at least one SID remains in the uncompressed SID list
       (following the series of compressible NEXT-CSID flavor
       SIDs) {
S11.   Set S to the next SID in the uncompressed SID list
S12.   If S is advertised with a SID structure, and the
         Locator-Block of S matches that of the NEXT-CSID
         container, and the sum of the Locator-Node, Function, and
         Argument length of S is lower than or equal to the
         remaining capacity of the CSID container {
S13.     Copy the Locator-Node, Function, and Argument of S to the
           most significant remaining Argument bits of the CSID
           container
S14.   } // End If
S15. } // End If
S16. Push the NEXT-CSID container onto the compressed SID list
]]></sourcecode>
	  </li>

          <li><t>When the compression method encounters a series of
          REPLACE-CSID flavor SIDs of the same CSID length in the uncompressed
          SID list, it compresses the series as per the following high-level
          pseudocode. A compression checking function ComCheck(F, S) is
          defined to check if two SIDs F and S share the same SID structure
          and Locator-Block value, and if S has either no Argument or an
          Argument with value 0. If the check passes, then ComCheck(F,S)
          returns true.</t>

        <sourcecode type="pseudocode"><![CDATA[
S01. Initialize a REPLACE-CSID container in full SID format equal
       to the first SID in the series
S02. Push the REPLACE-CSID container onto the compressed SID list
S03. Initialize a new REPLACE-CSID container in packed format if
       there are more than one SIDs and initialize the remaining
       capacity of the REPLACE-CSID container to 128 bits
S04. For each subsequent SID in the uncompressed SID list {
S05.   Set S to the current SID in the uncompressed SID list
S06.   If ComCheck(First SID, S) {
S07.     If the LNFL of S is lower than or equal to
           the remaining capacity of the REPLACE-CSID container {
S08.       Copy the Locator-Node and Function of S to the least
             significant remaining bits of the REPLACE-CSID
             container and decrement the remaining capacity by
             LNFL  // Note
S09.     } Else {
S10.       Push the REPLACE-CSID container onto the compressed SID
             list
S11.       Initialize a new REPLACE-CSID container in packed
             format with all bits set to 0
S12.       Copy the Locator-Node and Function of S to the least
             significant remaining bits of the REPLACE-CSID
             container and decrement the remaining capacity by
             LNFL  // Note
S13.     }
S14.     If S is not a REPLACE-CSID flavor SID, then break
S15.   } Else {
S16.     Break
S17.   } // End If
S18. } // End For
S19. Push the REPLACE-CSID container (if it is not empty) onto the
       compressed SID list
]]></sourcecode>
	</li>
      </ul>
        <aside>
          <t>Note: When the last CSID is an End.DT2M SID with the REPLACE-CSID flavor, if there are 0 or at least two CSID positions left in the current REPLACE-CSID container, the CSID is encoded as described above and the value of the <tt>Arg.FE2</tt> argument is placed in the 16 least significant bits of the next CSID position. Otherwise (if there is only one CSID position left in the current REPLACE-CSID container), the current REPLACE-CSID container is pushed onto the SID list (the value of the CSID position 0 remains zero) and the End.DT2M SID with the REPLACE-CSID flavor is encoded in full SID format with the value of the <tt>Arg.FE2</tt> argument in the 16 most significant bits of the SID Argument.</t>
        </aside>

        <t>In all remaining cases (i.e., when the compression method encounters a SID in the uncompressed SID list that is not handled by any of the previous subroutines), it pushes this SID as is onto the compressed SID list.</t>
        <t>Regardless of how a compressed SID list is produced, the SR source node writes it in the IPv6 packet as described in Sections <xref target="RFC8754" sectionFormat="bare" section="4.1"/> and <xref target="RFC8754" sectionFormat="bare" section="4.1.1"/> of <xref target="RFC8754"/>. The text is reproduced below for reference.</t>

        <blockquote>
          <t>A source node steers a packet into an SR Policy. If the SR Policy
results in a Segment List containing a single segment, and there is
no need to add information to the SRH flag or add TLV; the DA is set
to the single Segment List entry, and the SRH <bcp14>MAY</bcp14> be omitted.</t>
          <t>When needed, the SRH is created as follows:</t>
          <t>The Next Header and Hdr Ext Len fields are set as specified in
  <xref target="RFC8200"/>.</t>
          <t>The Routing Type field is set to 4.</t>
          <t>The DA of the packet is set with the value of the first segment.</t>
          <t>The first element of the SRH Segment List is the ultimate segment.
  The second element is the penultimate segment, and so on.</t>
          <t>The Segments Left field is set to n-1, where n is the number of
  elements in the SR Policy.</t>
          <t>The Last Entry field is set to n-1, where n is the number of
  elements in the SR Policy.</t>
          <t>TLVs (including HMAC) may be set according to their specification.</t>
          <t>The packet is forwarded toward the packet's Destination Address
  (the first segment).</t>
          <t>When a source does not require the entire SID list to be preserved
in the SRH, a reduced SRH may be used.</t>
          <t>A reduced SRH does not contain the first segment of the related SR
Policy (the first segment is the one already in the DA of the IPv6
header), and the Last Entry field is set to n-2, where n is the
number of elements in the SR Policy.</t>
        </blockquote>
      </section>
      <section anchor="sec-source-next">
	
        <name>Rules for Segment Lists Containing NEXT-CSID Flavor SIDs</name>
        <ol spacing="normal" type="1"><li>
            <t>If a Destination Options header would follow an SRH with a segment list of more than one segment compressed as a single NEXT-CSID container, the SR source node <bcp14>MUST NOT</bcp14> omit the SRH.</t>
          </li>
          <li>
            <t>When the last Segment List entry (index 0) in the SRH is a NEXT-CSID container representing more than one segment and the segment S preceding the first segment of this NEXT-CSID container in the segment list has the PSP flavor, then the PSP operation is performed at the SR segment endpoint node of S. If the PSP behavior should instead be performed at the penultimate segment along the path, then the SR source node <bcp14>MUST NOT</bcp14> compress the ultimate SID of the SID list into a NEXT-CSID container.</t>
          </li>
          <li>
            <t>If a Destination Options header would follow an SRH with a last Segment List entry being a NEXT-CSID container representing more than one segment, the SR source node <bcp14>MUST</bcp14> ensure that the PSP operation is not performed before the penultimate SR segment endpoint node along the path.</t>
          </li>
          <li>
            <t>When the Argument of a NEXT-CSID container is not used to full capacity, the remaining least significant bits of that Argument <bcp14>MUST</bcp14> be set to 0.</t>
          </li>
        </ol>
      </section>
      <section anchor="sec-source-replace">
        <name>Rules for Segment Lists Containing REPLACE-CSID Flavor SIDs</name>
        <ol spacing="normal" type="1"><li>
            <t>All SIDs compressed in a REPLACE-CSID sequence <bcp14>MUST</bcp14> share the same Locator-Block and the same compression scheme.</t>
          </li>
          <li>
            <t>All SIDs except the last one in a CSID sequence for REPLACE-CSID <bcp14>MUST</bcp14> have the REPLACE-CSID flavor. If the last REPLACE-CSID container is fully filled (i.e., the last CSID is at position 0 in the REPLACE-CSID container) and the last SID in the CSID sequence is not the last segment in the segment list, the last SID in the CSID sequence <bcp14>MUST NOT</bcp14> have the REPLACE-CSID flavor.</t>
          </li>
          <li>
            <t>When a REPLACE-CSID flavor CSID is present as the last SID in a container that is not the last Segment List entry (index 0) in the SRH, the next element in the SID list <bcp14>MUST</bcp14> be a REPLACE-CSID container in packed format carrying at least one CSID.</t>
          </li>
        </ol>
        <t>The SR source node determines the compression scheme of REPLACE-CSID flavor SIDs as follows.</t>

	
        <t>When receiving a SID advertisement for a REPLACE-CSID flavor SID with LNL = 16, FL = 0, AL = 128-LBL-LNFL, and all zeros as the value of the Argument, the SR source node marks both the SID and its locator as using 16-bit compression. All other SIDs allocated from this locator with LNL = 16, FL = 16, AL = 128-LBL-LNFL, and all zeros as the value of the Argument are also marked as using 16-bit compression. When receiving a SID advertisement for a REPLACE-CSID flavor SID with LNFL = 32, AL = 128-LBL-LNFL, and all zeros as the value of the Argument, the SR source node marks both the SID and its locator as using 32-bit compression.</t>
      </section>
      <section anchor="sec-source-checksum">
        <name>Upper-Layer Checksums</name>
        <t>The Destination Address used in the IPv6 pseudo-header (<xref target="RFC8200" sectionFormat="of" section="8.1"/>) is that of the ultimate destination.</t>
	
        <t>At the SR source node, that address will be the Destination Address as it is expected to be received by the ultimate destination. When the last element in the compressed SID list is a CSID container, this address can be obtained from the last element in the uncompressed SID list or by repeatedly applying the segment behavior as described in <xref target="sec-operations-icmp-error"/>. This applies regardless of whether an SRH is present in the IPv6 packet or is omitted.</t>
        <t>At the ultimate destination(s), that address will be in the Destination Address field of the IPv6 header.</t>
      </section>
    </section>
    <section anchor="sec-inter-domain">
      <name>Inter-Domain Compression</name>
      <t>Some SRv6 traffic may need to cross multiple routing domains, such as different Autonomous Systems (ASes) or different routing areas within an SR domain. Different routing domains may use different addressing schema and Locator-Blocks.</t>
      <t>A property of a CSID sequence is that all CSIDs in the sequence share the same Locator-Block. Therefore, a segment list that spans multiple routing domains using different Locator-Blocks may need a separate CSID sequence for each domain.</t>
      <t>This section defines a solution to improve the efficiency of CSID compression in multi-domain environments by enabling a CSID sequence to combine CSIDs having different Locator-Blocks.</t>
      <t>The solution leverages two new SRv6 endpoint behaviors, "Endpoint with SRv6 Locator-Block Swap" ("End.LBS" for short) and "Endpoint with L3 cross-connect and SRv6 Locator-Block Swap" ("End.XLBS" for short), that enable modifying the Locator-Block for the next CSID in the CSID sequence at the routing domain boundary.</t>
      <section anchor="endlbs-locator-block-swap">
        <name>End.LBS: Locator-Block Swap</name>
        <t>The End.LBS behavior is a variant of the End behavior that modifies the Locator-Block of the active CSID sequence. This document defines the End.LBS behavior with the NEXT-CSID flavor and the End.LBS behavior with the REPLACE-CSID flavor.</t>
        <t>An End.LBS SID is used to transition to a new Locator-Block when the routing domain boundary is on the SR segment endpoint node.</t>
        <t>Each instance of an End.LBS SID is associated with a target Locator-Block B2/m, where B2 is an IPv6 address prefix and m is the associated prefix length.
The original and target Locator-Blocks can have different prefix lengths as long as the new Destination Address formed by combining the target Locator-Block with the Locator-Node, Function, and Argument as described in the pseudocode of Sections <xref target="sec-next-endlbs" format="counter"/> and <xref target="sec-replace-endlbs" format="counter"/> is a valid IPv6 address.
The target Locator-Block is a local property of the End.LBS SID on the SR segment endpoint node.</t>

        <aside>
          <t>Note: a local SID property is an attribute associated with the SID when it is instantiated on the SR segment endpoint node. When the SR segment endpoint node identifies the Destination Address of a received packet as a locally instantiated SID, it also retrieves any local property associated with this SID. Other examples of local SID properties include the set of L3 adjacencies of an End.X SID (<xref target="RFC8986" sectionFormat="of" section="4.2"/>) and the lookup table of an End.DT6 SID (<xref target="RFC8986" sectionFormat="of" section="4.6"/>).</t>
        </aside>
        <t>The means by which an SR source node learns the target Locator-Block associated with an End.LBS SID are outside the scope of this document. As examples, it could be learned via configuration or signaled by a controller.</t>
        <section anchor="sec-next-endlbs">
          <name>End.LBS with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.LBS SID with the NEXT-CSID flavor and associated with the target Locator-Block B2/m, the SR segment endpoint node applies the procedure specified in <xref target="sec-next-end"/> with the lines N05 to N06 replaced as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
N05.1. Initialize an IPv6 address A equal to B2.
N05.2. Copy DA.Argument into the bits [m..(m+AL-1)] of A.
N06.   Copy A to the Destination Address of the IPv6 header.
]]></sourcecode>
        </section>
        <section anchor="sec-replace-endlbs">
          <name>End.LBS with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.LBS SID with the REPLACE-CSID flavor and associated with the target Locator-Block B2/m, the SR segment endpoint node applies the procedure specified in <xref target="sec-replace-end"/> with the line R20 replaced as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
R20.1. Initialize an IPv6 address A equal to B2.
R20.2. Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [m..m+LNFL-1] of A.
R20.3. Write DA.Arg.Index into the bits
         [(128-ceiling(log_2(128/LNFL)))..127] of A.
R20.4. Copy A to the Destination Address of the IPv6 header.
]]></sourcecode>
        </section>
      </section>
      <section anchor="endxlbs-l3-cross-connect-and-locator-block-swap">
        <name>End.XLBS: L3 Cross-Connect and Locator-Block Swap</name>
        <t>The End.XLBS behavior is a variant of the End.X behavior that modifies the Locator-Block of the active CSID sequence. This document defines the End.XLBS behavior with the NEXT-CSID flavor and the End.XLBS behavior with the REPLACE-CSID flavor.</t>
        <t>An End.XLBS SID is used to transition to a new Locator-Block when the routing domain boundary is on a link adjacent to the SR segment endpoint node.</t>
        <t>Each instance of an End.XLBS SID is associated with a target Locator-Block B2/m and a set, J, of one or more L3 adjacencies.
The original and target Locator-Blocks can have different prefix lengths as long as the new Destination Address formed by combining the target Locator-Block with the Locator-Node, Function, and Argument as described in the pseudocode of Sections <xref target="sec-next-endxlbs" format="counter"/> and <xref target="sec-replace-endxlbs" format="counter" /> is a valid IPv6 address.
The target Locator-Block and set of adjacencies are local properties of the End.XLBS SID on the SR segment endpoint node.</t>
        <t>The means by which an SR source node learns the target Locator-Block associated with an End.XLBS SID are outside the scope of this document. As examples, it could be learned via configuration or signaled by a controller.</t>
        <section anchor="sec-next-endxlbs">
          <name>End.XLBS with NEXT-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.XLBS SID with the NEXT-CSID flavor and associated with the target Locator-Block B2/m, the SR segment endpoint node applies the procedure specified in <xref target="sec-next-endx"/> with the lines N05 to N06 (of the pseudocode in <xref target="sec-next-end"/>) replaced as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
N05.1. Initialize an IPv6 address A equal to B2.
N05.2. Copy DA.Argument into the bits [m..(m+AL-1)] of A.
N06.   Copy A to the Destination Address of the IPv6 header.
]]></sourcecode>
        </section>
        <section anchor="sec-replace-endxlbs">
          <name>End.XLBS with REPLACE-CSID</name>
          <t>When processing an IPv6 packet that matches a FIB entry locally instantiated as an End.XLBS SID with the REPLACE-CSID flavor and associated with the target Locator-Block B2/m, the SR segment endpoint node applies the procedure specified in <xref target="sec-replace-endx"/> with the line R20 (of the pseudocode in <xref target="sec-replace-end"/>) replaced as follows.</t>
          <sourcecode type="pseudocode"><![CDATA[
R20.1. Initialize an IPv6 address A equal to B2.
R20.2. Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [m..m+LNFL-1] of A.
R20.3. Write DA.Arg.Index into the bits
         [(128-ceiling(log_2(128/LNFL)))..127] of A.
R20.4. Copy A to the Destination Address of the IPv6 header.
]]></sourcecode>
        </section>
      </section>
    </section>
    <section anchor="sec-control-plane">
      <name>Control Plane</name>
      <t><xref target="RFC8986" sectionFormat="of" section="8"/> provides an overview of the control plane protocols used for signaling of the SRv6 endpoint behaviors introduced by that document, including the base SRv6 endpoint behaviors that are extended in the present document.</t>
      <t>The CSID-flavored behaviors introduced by this document are advertised in the same manner as their base SRv6 endpoint behaviors using the SRv6 extensions for various routing protocols, such as:</t>
      <ul spacing="normal">
        <li>
          <t>IS-IS <xref target="RFC9352"/></t>
        </li>
        <li>
          <t>OSPFv3 <xref target="RFC9513"/></t>
        </li>
        <li>
          <t>BGP <xref target="RFC9252"/>, <xref target="RFC9514"/>, <xref target="I-D.ietf-idr-sr-policy-safi"/></t>
        </li>
        <li>
          <t>BGP-LS <xref target="I-D.ietf-idr-bgp-ls-sr-policy"/></t>
        </li>
        <li>
          <t>PCEP <xref target="RFC9603"/></t>
        </li>
      </ul>
      
      <t>The SR segment endpoint node <bcp14>MUST</bcp14> set the SID Argument bits to 0 when advertising a locally instantiated SID of this document in the routing protocol (e.g., IS-IS <xref target="RFC9352"/>, OSPF <xref target="RFC9513"/>, or BGP-LS <xref target="RFC9514"/>).</t>
      <t>Signaling the SRv6 SID Structure is <bcp14>REQUIRED</bcp14> for all the SIDs introduced in this document. It is used by an SR source node to compress a SID list as described in <xref target="sec-source-node"/>.
The node initiating the SID advertisement <bcp14>MUST</bcp14> set the length values in the SRv6 SID Structure to match the format of the SID on the SR segment endpoint node. For example, for a SID of this document instantiated from a /48 SRv6 SID block and a /64 Locator, and having a 16-bit Function, the SRv6 SID Structure advertisement carries the following values.</t>
      <ul spacing="normal">
        <li>
          <t>LBL: 48</t>
        </li>
        <li>
          <t>LNL: 16</t>
        </li>
        <li>
          <t>FL: 16</t>
        </li>
        <li>
          <t>AL: 48 (= 128-48-16-16)</t>
        </li>
      </ul>
      <t>A local CSID may be advertised in the control plane individually and/or in combination with a global CSID instantiated on the same SR segment endpoint node, with the End behavior, and the same Locator-Block and flavor as the local CSID. A combined global and local CSID is advertised as follows:</t>
      <ul spacing="normal">
        <li>
          <t>The SID Locator-Block is that shared by the global and local CSIDs</t>
        </li>
        <li>
          <t>The SID Locator-Node is that of the global CSID</t>
        </li>
        <li>
          <t>The SID Function is that of the local CSID</t>
        </li>
        <li>
          <t>The SID AL is equal to 128-LBL-LNL-FL and the SID Argument value is 0</t>
        </li>
        <li>
          <t>All other attributes of the SID (e.g., SRv6 endpoint behavior or algorithm) are those of the local CSID</t>
        </li>
      </ul>
      <t>The combined advertisement of local CSIDs with a global CSID is needed in particular for control plane protocols mandating that the SID is a subnet of a locator advertised in the same protocol (e.g., <xref target="RFC9352" sectionFormat="of" section="8"/> and <xref target="RFC9513" sectionFormat="of" section="9"/> for advertising Adjacency SIDs in IS-IS and OSPFv3, respectively).</t>
      <t>For a segment list computed by a controller and signaled to an SR source node (e.g., via BGP <xref target="I-D.ietf-idr-sr-policy-safi"/> or PCEP <xref target="RFC9603"/>), the controller provides the ordered segment list comprising the uncompressed SIDs, with their respective behavior and structure, to the SR source node. The SR source node may then compress the SID list as described in <xref target="sec-source-node"/>.</t>
      
      <t>When a node receives an advertisement of a SID of this document that it does not support, it handles the advertisement as described in the corresponding control plane specification (e.g., Sections <xref target="RFC9352" sectionFormat="bare" section="7.2"/>, <xref target="RFC9352" sectionFormat="bare" section="8.1"/>, and <xref target="RFC9352" sectionFormat="bare" section="8.2"/> of <xref target="RFC9352"/>, Sections <xref target="RFC9513" sectionFormat="bare" section="8"/>, <xref target="RFC9513" sectionFormat="bare" section="9.1"/>, and <xref target="RFC9513" sectionFormat="bare" section="9.2"/> of <xref target="RFC9513"/>, and <xref target="RFC9252" sectionFormat="of" section="3.1"/>).</t>
    </section>
    <section anchor="operational-considerations">
      <name>Operational Considerations</name>
      <section anchor="flavor-block-and-csid-length">
        <name>Flavor, Block, and CSID Length</name>
        <t>SRv6 is intended for use in a variety of networks that require different prefix lengths and SID numbering spaces. Each of the two flavors introduced in this document comes with its own recommendations for Locator-Block and CSID length, as specified in Sections <xref target="sec-next" format="counter"/> and <xref target="sec-replace" format="counter"/>. These flavors are best suited for different environments, depending on the requirements of the network. For instance, larger CSID lengths may be more suitable for networks requiring ample SID numbering space, while smaller CSID lengths are better for compression efficiency. The two compression flavors allow the compressed segment list encoding to adapt to a range of requirements, with support for multiple compression levels. Network operators can choose the flavor that best suits their use case, deployment design, and network scale.</t>
        <t>Both CSID flavors can coexist in the same SR domain, on the same SR segment endpoint node, and even in the same segment list. However, operators should generally avoid instantiating SIDs of different CSID flavors within the same routing domain or Locator-Block since these SIDs have different length and allocation recommendations (see Sections <xref target="sec-next" format="counter"/>, <xref target="sec-replace" format="counter"/>, and <xref target="sec-csid-lib-recommendation" format="counter"/>). In a multi-domain deployment, different flavors may be used in different routing domains of the SR domain.</t>
        <t>A deployment should use consistent LBLs and CSID lengths for all SIDs within a routing domain. Heterogeneous lengths, while possible, may impact the compression efficiency.</t>
        <t>The compressed segment list encoding works with various Locator-Block allocations. For example, each routing domain within the SR domain can be allocated a /48 Locator-Block from a global IPv6 block available to the operator or from a prefix allocated to SRv6 SIDs as discussed in <xref target="RFC9602" sectionFormat="of" section="5"/>.</t>
      </section>
      <section anchor="sec-csid-lib-recommendation">
        <name>GIB/LIB Usage</name>
        <t>GIB and LIB usage is a local implementation and/or configuration decision; however, some guidelines for determining usage for specific SRv6 endpoint behaviors and recommendations are provided.</t>
        <t>The GIB number space is shared among all SR segment endpoint nodes using SRv6 locators under a Locator-Block space.  The more SIDs assigned from this space, per node, the faster it is exhausted.  Therefore, its use is prioritized for global segments, such as SIDs that identify a node.</t>
        <t>The LIB number space is unique per node. Each node can fully utilize the entire LIB number space without consideration for assignments at other nodes.  Therefore, its use is prioritized for local segments, such as SIDs that identify services (of which there may be many) at nodes, cross-connects, or adjacencies.</t>
        <t>While a longer CSID length permits more flexibility in which SRv6 endpoint behaviors may be assigned from the GIB, it also reduces the compression efficiency.</t>
        <t>Given the previous Locator-Block and CSID length recommendations, the following GIB/LIB usage is recommended:</t>
        <ul spacing="normal">
          <li>
            <t>NEXT-CSID:
            </t>
            <ul spacing="normal">
              <li>
                <t>GIB: End</t>
              </li>
              <li>
                <t>LIB: End.X, End.T, End.DT4/6/46/2U/2M, End.DX4/6/2/2V (including large-scale pseudowire), End.B6.Encaps, End.B6.Encaps.Red, End.BM, End.LBS, and End.XLBS</t>
              </li>
            </ul>
          </li>
          <li>
            <t>REPLACE-CSID:
            </t>
            <ul spacing="normal">
              <li>
                <t>GIB: End, End.X, End.T, End.DT4/6/46/2U/2M, End.DX4/6/2/2V, End.B6.Encaps, End.B6.Encaps.Red, End.BM, End.LBS, and End.XLBS</t>
              </li>
              <li>
                <t>LIB: End.DX2/2V for large-scale pseudowire</t>
              </li>
            </ul>
          </li>
        </ul>
        <t>Any other allocation is possible but may lead to a suboptimal use of the CSID numbering space.</t>
      </section>
      <section anchor="pinging-a-sid">
        <name>Pinging a SID</name>
        <t>An SR source node may ping an SRv6 SID by sending an ICMPv6 echo request packet destined to the SRv6 SID. The SR source node may ping the target SID with a SID list comprising only that target SID or with a longer one that comprises two or more SIDs. In that case, the target SID is the last element in the SID list. This operation is illustrated in <xref section="A.1.2" target="RFC9259"/>.</t>
        <t>When pinging a SID of this document, the SR source node <bcp14>MUST</bcp14> construct the IPv6 packet as described in <xref target="sec-source-node"/>, including computing the ICMPv6 checksum as described in <xref target="sec-source-checksum"/>.</t>
        <t>In particular, when pinging a SID of this document with a SID list comprising only the target SID, the SR source node places the SID with Argument value 0 in the Destination Address of the ICMPv6 echo request and computes the ICMPv6 checksum using this SID as the Destination Address in the IPv6 pseudo-header. The Argument value 0 allows the SID SR segment endpoint node (<xref target="sec-endpoint"/>) to identify itself as the ultimate destination of the packet and process the ICMPv6 payload.
Therefore, any existing IPv6 ping implementation can originate ICMP echo requests to a NEXT-CSID or REPLACE-CSID flavor SID with a SID list comprising only the target SID, provided that the user ensures that the SID Argument is 0.</t>
      </section>
      <section anchor="sec-operations-icmp-error">
        <name>ICMP Error Processing</name>
        <t>When an IPv6 node encounters an error while processing a packet, it may report that error by sending an IPv6 error message to the packet source with an enclosed copy of the invoking packet. For the source of an invoking packet to process the ICMP error message, the ultimate Destination Address of the IPv6 header may be required.</t>
        <t><xref target="RFC8754" sectionFormat="of" section="5.4"/> defines the logic that an SR source node follows to determine the ultimate destination of an invoking packet containing an SRH.</t>
        <t>For an SR source node that supports the compressed segment list encoding defined in this document, the logic to determine the ultimate destination is generalized as follows.</t>
        <ul spacing="normal">
          <li>
            <t>If the Destination Address of the invoking IPv6 packet matches a known SRv6 SID, modify the invoking IPv6 packet by applying the SRv6 endpoint behavior associated with the matched SRv6 SID;</t>
          </li>
          <li>
            <t>Repeat until the application of the SRv6 endpoint behavior would result in the processing of the upper-layer header.</t>
          </li>
        </ul>
        <t>The Destination Address of the resulting IPv6 packet may be used as the ultimate destination of the invoking IPv6 packet.</t>
        <t>Since the SR source node that needs to determine the ultimate destination is the same node that originally built the SID list in the invoking packet, it can perform this operation for all the SIDs in the packet.</t>
      </section>
    </section>

    <section anchor="sec-future">
      <name>Applicability to Other SRv6 Endpoint Behaviors</name>
      <t>Future documents may extend the applicability of the NEXT-CSID and REPLACE-CSID flavors to other SRv6 endpoint behaviors.</t>
      <t>For an SRv6 endpoint behavior that can be used before the last position of a segment list, a CSID flavor is defined by reproducing the same logic as described in Sections <xref target="sec-next" format="counter"/> and <xref target="sec-replace" format="counter"/> to determine the next SID in the SID list.</t>
    </section>
    <section anchor="security-considerations">
      <name>Security Considerations</name>
      <t><xref target="RFC8402" sectionFormat="of" section="8"/> discusses the security considerations for Segment Routing.</t>
      <t><xref target="RFC8754" sectionFormat="of" section="5"/> describes the intra-SR-domain deployment model and how to secure it. <xref target="RFC8754" sectionFormat="of" section="7"/> describes the threats applicable to SRv6 and how to mitigate them.</t>
      <t><xref target="RFC8986" sectionFormat="of" section="9"/> discusses the security considerations applicable to the SRv6 network programming framework, as well as the SR source node and SR segment endpoint node behaviors that it defines.</t>

      <t>This document introduces two new flavors, NEXT-CSID and REPLACE-CSID, for some of the SRv6 endpoint behaviors defined in <xref target="RFC8986"/> and a method by which an SR source node may leverage the SIDs of these flavors to produce a compressed segment list encoding.</t>
      <t>This document also introduces two new SRv6 endpoint behaviors, End.LBS and End.XLBS, to preserve the efficiency of CSID compression in multi-domain environments.</t>
      <t>An SR source node constructs an IPv6 packet with a compressed segment list encoding as defined in Sections <xref target="RFC8754" sectionFormat="bare" section="3.1"/> and <xref target="RFC8754" sectionFormat="bare" section="4.1"/> of <xref target="RFC8754"/> and <xref target="RFC8986" sectionFormat="of" section="5"/>. The paths that an SR source node may enforce using a compressed segment list encoding are the same, from a topology and service perspective, as those that an SR source node could enforce using the SIDs of <xref target="RFC8986"/>.</t>
      <t>An SR segment endpoint node processes an IPv6 packet matching a locally instantiated SID as defined in <xref target="RFC8986"/>, with the pseudocode modifications in <xref target="sec-endpoint"/> of this document. These modifications change how the SR segment endpoint node determines the next SID in the packet but not the semantic of either the active or the next SID. For example, an adjacency segment instantiated with the End.X behavior remains an adjacency segment regardless of whether it uses the base End.X behavior defined in <xref target="RFC8986" sectionFormat="of" section="4.2"/> or a CSID flavor of that behavior. This document does not introduce any new SID semantic.</t>
      <t>Any other transit node processes the packet as described in <xref target="RFC8754" sectionFormat="of" section="4.2"/>.</t>
      <t>This document defines a new method of encoding the SIDs inside a SID list at the SR source node (<xref target="sec-source-node"/>) and decoding them at the SR segment endpoint node (see Sections <xref target="sec-endpoint" format="counter"/> and <xref target="sec-inter-domain" format="counter"/>), but it does not change how the SID list itself is encoded in the IPv6 packet nor the semantic of any segment that it comprises. Therefore, this document is subject to the same security considerations that are discussed in <xref target="RFC8402"/>, <xref target="RFC8754"/>, and <xref target="RFC8986"/>.</t>
    </section>
    <section anchor="iana-considerations">
      <name>IANA Considerations</name>
      <section anchor="srv6-endpoint-behaviors">
        <name>SRv6 Endpoint Behaviors</name>
        <t>IANA has updated the reference of the following registrations from the "SRv6 Endpoint Behaviors" registry under the "Segment Routing" registry group (<eref brackets="angle" target="https://www.iana.org/assignments/segment-routing/"/>) to point to this document and transfer change control to the IETF.</t>
        <table anchor="tbl-iana-endpoint-behaviors">
          <name>SRv6 Endpoint Behaviors Registration List</name>
          <thead>
            <tr>
              <th align="left">Value</th>
              <th align="left">Description</th>
              <th align="left">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">43</td>
              <td align="left">End with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">44</td>
              <td align="left">End with NEXT-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">45</td>
              <td align="left">End with NEXT-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">46</td>
              <td align="left">End with NEXT-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">47</td>
              <td align="left">End with NEXT-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">48</td>
              <td align="left">End with NEXT-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">49</td>
              <td align="left">End with NEXT-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">50</td>
              <td align="left">End with NEXT-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">52</td>
              <td align="left">End.X with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">53</td>
              <td align="left">End.X with NEXT-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">54</td>
              <td align="left">End.X with NEXT-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">55</td>
              <td align="left">End.X with NEXT-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">56</td>
              <td align="left">End.X with NEXT-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">57</td>
              <td align="left">End.X with NEXT-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">58</td>
              <td align="left">End.X with NEXT-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">59</td>
              <td align="left">End.X with NEXT-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">85</td>
              <td align="left">End.T with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">86</td>
              <td align="left">End.T with NEXT-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">87</td>
              <td align="left">End.T with NEXT-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">88</td>
              <td align="left">End.T with NEXT-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">89</td>
              <td align="left">End.T with NEXT-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">90</td>
              <td align="left">End.T with NEXT-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">91</td>
              <td align="left">End.T with NEXT-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">92</td>
              <td align="left">End.T with NEXT-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">93</td>
              <td align="left">End.B6.Encaps with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">94</td>
              <td align="left">End.B6.Encaps.Red with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">95</td>
              <td align="left">End.BM with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">96</td>
              <td align="left">End.LBS with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">97</td>
              <td align="left">End.XLBS with NEXT-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">101</td>
              <td align="left">End with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">102</td>
              <td align="left">End with REPLACE-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">103</td>
              <td align="left">End with REPLACE-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">104</td>
              <td align="left">End with REPLACE-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">105</td>
              <td align="left">End.X with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">106</td>
              <td align="left">End.X with REPLACE-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">107</td>
              <td align="left">End.X with REPLACE-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">108</td>
              <td align="left">End.X with REPLACE-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">109</td>
              <td align="left">End.T with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">110</td>
              <td align="left">End.T with REPLACE-CSID &amp; PSP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">111</td>
              <td align="left">End.T with REPLACE-CSID &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">112</td>
              <td align="left">End.T with REPLACE-CSID, PSP &amp; USP</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">114</td>
              <td align="left">End.B6.Encaps with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">115</td>
              <td align="left">End.BM with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">116</td>
              <td align="left">End.DX6 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">117</td>
              <td align="left">End.DX4 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">118</td>
              <td align="left">End.DT6 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">119</td>
              <td align="left">End.DT4 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">120</td>
              <td align="left">End.DT46 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">121</td>
              <td align="left">End.DX2 with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">122</td>
              <td align="left">End.DX2V with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">123</td>
              <td align="left">End.DT2U with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">124</td>
              <td align="left">End.DT2M with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">127</td>
              <td align="left">End.B6.Encaps.Red with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">128</td>
              <td align="left">End with REPLACE-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">129</td>
              <td align="left">End with REPLACE-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">130</td>
              <td align="left">End with REPLACE-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">131</td>
              <td align="left">End with REPLACE-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">132</td>
              <td align="left">End.X with REPLACE-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">133</td>
              <td align="left">End.X with REPLACE-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">134</td>
              <td align="left">End.X with REPLACE-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">135</td>
              <td align="left">End.X with REPLACE-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">136</td>
              <td align="left">End.T with REPLACE-CSID &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">137</td>
              <td align="left">End.T with REPLACE-CSID, PSP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">138</td>
              <td align="left">End.T with REPLACE-CSID, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">139</td>
              <td align="left">End.T with REPLACE-CSID, PSP, USP &amp; USD</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">140</td>
              <td align="left">End.LBS with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
            <tr>
              <td align="left">141</td>
              <td align="left">End.XLBS with REPLACE-CSID</td>
              <td align="left">RFC 9800</td>
            </tr>
          </tbody>
        </table>
      </section>
    </section>
  </middle>
  <back>
    <displayreference target="I-D.ietf-idr-bgp-ls-sr-policy" to="BGP-LS-SR-Policy"/>
     <displayreference target="I-D.ietf-idr-sr-policy-safi" to="BGP-SR-Policy"/>
    <references anchor="sec-combined-references">
      <name>References</name>
      <references anchor="sec-normative-references">
        <name>Normative References</name>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8200.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8986.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml"/>
      </references>
      <references anchor="sec-informative-references">
        <name>Informative References</name>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9252.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9259.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9350.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9352.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9513.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9514.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9602.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9603.xml"/>

<reference anchor="I-D.ietf-idr-bgp-ls-sr-policy" target="https://datatracker.ietf.org/doc/html/draft-ietf-idr-bgp-ls-sr-policy-17">
   <front>
      <title>Advertisement of Segment Routing Policies using BGP Link-State</title>
      <author initials="S." surname="Previdi" fullname="Stefano Previdi">
         <organization>Individual</organization>
      </author>
      <author initials="K." surname="Talaulikar" fullname="Ketan Talaulikar" role="editor">
         <organization>Cisco Systems</organization>
      </author>
      <author initials="J." surname="Dong" fullname="Jie Dong">
         <organization>Huawei Technologies</organization>
      </author>
      <author initials="H." surname="Gredler" fullname="Hannes Gredler">
         <organization>RtBrick Inc.</organization>
      </author>
      <author initials="J." surname="Tantsura" fullname="Jeff Tantsura">
         <organization>Nvidia</organization>
      </author>
      <date month="March" day="6" year="2025" />
   </front>
   <seriesInfo name="Internet-Draft" value="draft-ietf-idr-bgp-ls-sr-policy-17" />
   
</reference>


<reference anchor="I-D.ietf-idr-sr-policy-safi" target="https://datatracker.ietf.org/doc/html/draft-ietf-idr-sr-policy-safi-13">
   <front>
      <title>Advertising Segment Routing Policies in BGP</title>
      <author initials="S." surname="Previdi" fullname="Stefano Previdi">
         <organization>Huawei Technologies</organization>
      </author>
      <author initials="C." surname="Filsfils" fullname="Clarence Filsfils">
         <organization>Cisco Systems</organization>
      </author>
      <author initials="K." surname="Talaulikar" fullname="Ketan Talaulikar" role="editor">
         <organization>Cisco Systems</organization>
      </author>
      <author initials="P." surname="Mattes" fullname="Paul Mattes">
         <organization>Microsoft</organization>
      </author>
      <author initials="D." surname="Jain" fullname="Dhanendra Jain">
         <organization>Google</organization>
      </author>
      <date month="February" day="6" year="2025" />
   </front>
   <seriesInfo name="Internet-Draft" value="draft-ietf-idr-sr-policy-safi-13" />   
</reference>


        <reference anchor="GKP94">
          <front>
            <title>Concrete Mathematics: A Foundation for Computer Science</title>
            <author initials="R." surname="Graham" fullname="Ronald Graham">
              <organization/>
            </author>
            <author initials="D." surname="Knuth" fullname="Donald Knuth">
              <organization/>
            </author>
            <author initials="O." surname="Patashnik" fullname="Oren Patashnik">
              <organization/>
            </author>
            <date year="1994"/>
          </front>
          <seriesInfo name="ISBN" value="9780201558029"/>
        </reference>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.4786.xml"/>
      </references>
    </references>
    <?line 1555?>
   
<section anchor="complete-pseudocodes">
      <name>Complete Pseudocodes</name>
      <t>The content of this section is purely informative rendering of the pseudocodes of <xref target="RFC8986"/> with the modifications in this document. This rendering may not be used as a reference.</t>
      <section anchor="sec-next-end-complete">
        <name>End with NEXT-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address
           with Code 0 (Hop limit exceeded in transit),
           interrupt packet processing, and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.   Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
N09. }
S02. If (Segments Left == 0) {
S03.   Stop processing the SRH and proceed to process the next
         header in the packet, whose type is identified by
         the Next Header field in the routing header.
S04. }
S05. If (IPv6 Hop Limit <= 1) {
S06.   Send an ICMP Time Exceeded message to the Source Address
         with Code 0 (Hop limit exceeded in transit),
         interrupt packet processing, and discard the packet.
S07. }
S08. max_LE = (Hdr Ext Len / 2) - 1
S09. If ((Last Entry > max_LE) or (Segments Left > Last Entry+1)) {
S10.   Send an ICMP Parameter Problem to the Source Address
         with Code 0 (Erroneous header field encountered)
         and Pointer set to the Segments Left field,
         interrupt packet processing, and discard the packet.
S11. }
S12. Decrement IPv6 Hop Limit by 1.
S13. Decrement Segments Left by 1.
S14. Update IPv6 DA with Segment List[Segments Left].
S15. Submit the packet to the egress IPv6 FIB lookup for
       transmission to the new destination.
]]></sourcecode>
        <t>Before processing the upper-layer header or any IPv6 extension header other than Hop-by-Hop or Destination Options of a packet matching a FIB entry locally instantiated as an End SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.   Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
N09. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
         with Code 4 (SR Upper-layer Header Error)
         and Pointer set to the offset of the upper-layer header,
         interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-next-endx-complete">
        <name>End.X with NEXT-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.X SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address
           with Code 0 (Hop limit exceeded in transit),
           interrupt packet processing, and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.   Submit the packet to the IPv6 module for transmission to the
         new destination via a member of J.
N09. }
S02. If (Segments Left == 0) {
S03.   Stop processing the SRH and proceed to process the next
         header in the packet, whose type is identified by
         the Next Header field in the routing header.
S04. }
S05. If (IPv6 Hop Limit <= 1) {
S06.   Send an ICMP Time Exceeded message to the Source Address
         with Code 0 (Hop limit exceeded in transit),
         interrupt packet processing, and discard the packet.
S07. }
S08. max_LE = (Hdr Ext Len / 2) - 1
S09. If ((Last Entry > max_LE) or (Segments Left > Last Entry+1)) {
S10.   Send an ICMP Parameter Problem to the Source Address
         with Code 0 (Erroneous header field encountered)
         and Pointer set to the Segments Left field,
         interrupt packet processing, and discard the packet.
S11. }
S12. Decrement IPv6 Hop Limit by 1.
S13. Decrement Segments Left by 1.
S14. Update IPv6 DA with Segment List[Segments Left].
S15. Submit the packet to the IPv6 module for transmission
       to the new destination via a member of J.
]]></sourcecode>
        <t>Before processing the upper-layer header or any IPv6 extension header other than Hop-by-Hop or Destination Options of a packet matching a FIB entry locally instantiated as an End.X SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.   Submit the packet to the IPv6 module for transmission to the
         new destination via a member of J.
N09. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.X SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
         with Code 4 (SR Upper-layer Header Error)
         and Pointer set to the offset of the upper-layer header,
         interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-next-endt-complete">
        <name>End.T with NEXT-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.T SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address
           with Code 0 (Hop limit exceeded in transit),
           interrupt packet processing, and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Set the packet's associated FIB table to T.
N08.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
N09. }
S02. If (Segments Left == 0) {
S03.   Stop processing the SRH and proceed to process the next
         header in the packet, whose type is identified by
         the Next Header field in the routing header.
S04. }
S05. If (IPv6 Hop Limit <= 1) {
S06.   Send an ICMP Time Exceeded message to the Source Address
         with Code 0 (Hop limit exceeded in transit),
         interrupt packet processing, and discard the packet.
S07. }
S08. max_LE = (Hdr Ext Len / 2) - 1
S09. If ((Last Entry > max_LE) or (Segments Left > Last Entry+1)) {
S10.   Send an ICMP Parameter Problem to the Source Address
         with Code 0 (Erroneous header field encountered)
         and Pointer set to the Segments Left field,
         interrupt packet processing, and discard the packet.
S11. }
S12. Decrement IPv6 Hop Limit by 1.
S13. Decrement Segments Left by 1.
S14. Update IPv6 DA with Segment List[Segments Left].
S15.1. Set the packet's associated FIB table to T.
S15.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
]]></sourcecode>
        <t>Before processing the upper-layer header or any IPv6 extension header other than Hop-by-Hop or Destination Options of a packet matching a FIB entry locally instantiated as an End.T SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Set the packet's associated FIB table to T.
N08.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
N09. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.T SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
         with Code 4 (SR Upper-layer Header Error)
         and Pointer set to the offset of the upper-layer header,
         interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-next-endb6-complete">
        <name>End.B6.Encaps with NEXT-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.B6.Encaps SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Push a new IPv6 header with its own SRH containing B.
N08.2. Set the outer IPv6 SA to A.
N08.3. Set the outer IPv6 DA to the first SID of B.
N08.4. Set the outer Payload Length, Traffic Class, Flow Label,
         Hop Limit, and Next Header fields.
N08.5. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
N09. }
S02. If (Segments Left == 0) {
S03.   Stop processing the SRH and proceed to process the next
         header in the packet, whose type is identified by
         the Next Header field in the routing header.
S04. }
S05. If (IPv6 Hop Limit <= 1) {
S06.   Send an ICMP Time Exceeded message to the Source Address
         with Code 0 (Hop limit exceeded in transit),
         interrupt packet processing, and discard the packet.
S07. }
S08. max_LE = (Hdr Ext Len / 2) - 1
S09. If ((Last Entry > max_LE) or (Segments Left > Last Entry+1)) {
S10.   Send an ICMP Parameter Problem to the Source Address
         with Code 0 (Erroneous header field encountered)
         and Pointer set to the Segments Left field,
         interrupt packet processing, and discard the packet.
S11. }
S12. Decrement IPv6 Hop Limit by 1.
S13. Decrement Segments Left by 1.
S14. Update IPv6 DA with Segment List[Segments Left].
S15. Push a new IPv6 header with its own SRH containing B.
S16. Set the outer IPv6 SA to A.
S17. Set the outer IPv6 DA to the first SID of B.
S18. Set the outer Payload Length, Traffic Class, Flow Label,
       Hop Limit, and Next Header fields.
S19. Submit the packet to the egress IPv6 FIB lookup for
       transmission to the new destination.
]]></sourcecode>
        <t>Before processing the upper-layer header or any IPv6 extension header other than Hop-by-Hop or Destination Options of a packet matching a FIB entry locally instantiated as an End.B6.Encaps SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Push a new IPv6 header with its own SRH containing B.
N08.2. Set the outer IPv6 SA to A.
N08.3. Set the outer IPv6 DA to the first SID of B.
N08.4. Set the outer Payload Length, Traffic Class, Flow Label,
         Hop Limit, and Next Header fields.
N08.5. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
N09. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.B6.Encaps SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
         with Code 4 (SR Upper-layer Header Error)
         and Pointer set to the offset of the upper-layer header,
         interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-next-endbm-complete">
        <name>End.BM with NEXT-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.BM SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Push the MPLS label stack for B.
N08.2. Submit the packet to the MPLS engine for transmission.
N09. }
S02. If (Segments Left == 0) {
S03.   Stop processing the SRH and proceed to process the next
         header in the packet, whose type is identified by
         the Next Header field in the routing header.
S04. }
S05. If (IPv6 Hop Limit <= 1) {
S06.   Send an ICMP Time Exceeded message to the Source Address
         with Code 0 (Hop limit exceeded in transit),
         interrupt packet processing, and discard the packet.
S07. }
S08. max_LE = (Hdr Ext Len / 2) - 1
S09. If ((Last Entry > max_LE) or (Segments Left > Last Entry+1)) {
S10.   Send an ICMP Parameter Problem to the Source Address
         with Code 0 (Erroneous header field encountered)
         and Pointer set to the Segments Left field,
         interrupt packet processing, and discard the packet.
S11. }
S12. Decrement IPv6 Hop Limit by 1.
S13. Decrement Segments Left by 1.
S14. Update IPv6 DA with Segment List[Segments Left].
S15. Push the MPLS label stack for B.
S16. Submit the packet to the MPLS engine for transmission.
]]></sourcecode>
        <t>Before processing the upper-layer header or any IPv6 extension header other than Hop-by-Hop or Destination Options of a packet matching a FIB entry locally instantiated as an End.BM SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
N01. If (DA.Argument != 0) {
N02.   If (IPv6 Hop Limit <= 1) {
N03.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
N04.   }
N05.   Copy DA.Argument into the bits [LBL..(LBL+AL-1)] of the
         Destination Address.
N06.   Set the bits [(LBL+AL)..127] of the Destination Address to
         zero.
N07.   Decrement IPv6 Hop Limit by 1.
N08.1. Push the MPLS label stack for B.
N08.2. Submit the packet to the MPLS engine for transmission.
N09. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.BM SID with the NEXT-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
         with Code 4 (SR Upper-layer Header Error)
         and Pointer set to the offset of the upper-layer header,
         interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-replace-end-complete">
        <name>End with REPLACE-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. When an SRH is processed {
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
S03.     Stop processing the SRH and proceed to process the next
           header in the packet, whose type is identified by
           the Next Header field in the routing header.
S04.   }
S05.   If (IPv6 Hop Limit <= 1) {
S06.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
S07.   }
S08.   max_LE = (Hdr Ext Len / 2) - 1
R01.   If (DA.Arg.Index != 0) {
R02.     If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R04.     }
R05.     Decrement DA.Arg.Index by 1.
R06.     If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.       Decrement Segments Left by 1.
R08.       Decrement IPv6 Hop Limit by 1.
R09.       Update IPv6 DA with Segment List[Segments Left]
R10.       Submit the packet to the egress IPv6 FIB lookup for
            transmission to the new destination.
R11.     }
R12.   } Else {
R13.     If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R15.     }
R16.     Decrement Segments Left by 1.
R17.     Set DA.Arg.Index to (128/LNFL - 1).
R18.   }
R19.   Decrement IPv6 Hop Limit by 1.
R20.   Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
         header.
R21.   Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
S16. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
          with Code 4 (SR Upper-layer Header Error)
          and Pointer set to the offset of the upper-layer header,
          interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-replace-endx-complete">
        <name>End.X with REPLACE-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.X SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. When an SRH is processed {
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
S03.     Stop processing the SRH and proceed to process the next
           header in the packet, whose type is identified by
           the Next Header field in the routing header.
S04.   }
S05.   If (IPv6 Hop Limit <= 1) {
S06.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
S07.   }
S08.   max_LE = (Hdr Ext Len / 2) - 1
R01.   If (DA.Arg.Index != 0) {
R02.     If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R04.     }
R05.     Decrement DA.Arg.Index by 1.
R06.     If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.       Decrement Segments Left by 1.
R08.       Decrement IPv6 Hop Limit by 1.
R09.       Update IPv6 DA with Segment List[Segments Left]
R10.       Submit the packet to the IPv6 module for transmission to
             the new destination via a member of J.
R11.     }
R12.   } Else {
R13.     If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R15.     }
R16.     Decrement Segments Left by 1.
R17.     Set DA.Arg.Index to (128/LNFL - 1).
R18.   }
R19.   Decrement IPv6 Hop Limit by 1.
R20.   Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
         header.
R21.   Submit the packet to the IPv6 module for transmission to the
         new destination via a member of J.
S16. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.X SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
          with Code 4 (SR Upper-layer Header Error)
          and Pointer set to the offset of the upper-layer header,
          interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-replace-endt-complete">
        <name>End.T with REPLACE-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.T SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. When an SRH is processed {
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
S03.     Stop processing the SRH and proceed to process the next
           header in the packet, whose type is identified by
           the Next Header field in the routing header.
S04.   }
S05.   If (IPv6 Hop Limit <= 1) {
S06.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
S07.   }
S08.   max_LE = (Hdr Ext Len / 2) - 1
R01.   If (DA.Arg.Index != 0) {
R02.     If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R04.     }
R05.     Decrement DA.Arg.Index by 1.
R06.     If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.       Decrement Segments Left by 1.
R08.       Decrement IPv6 Hop Limit by 1.
R09.       Update IPv6 DA with Segment List[Segments Left]
R10.1.     Set the packet's associated FIB table to T.
R10.2.     Submit the packet to the egress IPv6 FIB lookup for
             transmission to the new destination.
R11.     }
R12.   } Else {
R13.     If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R15.     }
R16.     Decrement Segments Left by 1.
R17.     Set DA.Arg.Index to (128/LNFL - 1).
R18.   }
R19.   Decrement IPv6 Hop Limit by 1.
R20.   Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
         header.
R21.1. Set the packet's associated FIB table to T.
R21.2. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the new destination.
S16. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.T SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
          with Code 4 (SR Upper-layer Header Error)
          and Pointer set to the offset of the upper-layer header,
          interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-replace-endb6-complete">
        <name>End.B6.Encaps with REPLACE-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.B6.Encaps SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. When an SRH is processed {
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
S03.     Stop processing the SRH and proceed to process the next
           header in the packet, whose type is identified by
           the Next Header field in the routing header.
S04.   }
S05.   If (IPv6 Hop Limit <= 1) {
S06.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
S07.   }
S08.   max_LE = (Hdr Ext Len / 2) - 1
R01.   If (DA.Arg.Index != 0) {
R02.     If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R04.     }
R05.     Decrement DA.Arg.Index by 1.
R06.     If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.       Decrement Segments Left by 1.
R08.       Decrement IPv6 Hop Limit by 1.
R09.       Update IPv6 DA with Segment List[Segments Left]
R10.1.     Push a new IPv6 header with its own SRH containing B.
R10.2.     Set the outer IPv6 SA to A.
R10.3.     Set the outer IPv6 DA to the first SID of B.
R10.4.     Set the outer Payload Length, Traffic Class, Flow Label,
             Hop Limit, and Next Header fields.
R10.5.     Submit the packet to the egress IPv6 FIB lookup for
             transmission to the next destination.
R11.     }
R12.   } Else {
R13.     If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R15.     }
R16.     Decrement Segments Left by 1.
R17.     Set DA.Arg.Index to (128/LNFL - 1).
R18.   }
R19.   Decrement IPv6 Hop Limit by 1.
R20.   Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
         header.
R21.1. Push a new IPv6 header with its own SRH containing B.
R21.2. Set the outer IPv6 SA to A.
R21.3. Set the outer IPv6 DA to the first SID of B.
R21.4. Set the outer Payload Length, Traffic Class, Flow Label,
         Hop Limit, and Next Header fields.
R21.5. Submit the packet to the egress IPv6 FIB lookup for
         transmission to the next destination.
S16. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.B6.Encaps SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
          with Code 4 (SR Upper-layer Header Error)
          and Pointer set to the offset of the upper-layer header,
          interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
      <section anchor="sec-replace-endbm-complete">
        <name>End.BM with REPLACE-CSID</name>
        <t>When processing the SRH of a packet matching a FIB entry locally instantiated as an End.BM SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. When an SRH is processed {
S02.   If (Segments Left == 0 and (DA.Arg.Index == 0 or
           Segment List[0][DA.Arg.Index-1] == 0)) {
S03.     Stop processing the SRH and proceed to process the next
           header in the packet, whose type is identified by
           the Next Header field in the routing header.
S04.   }
S05.   If (IPv6 Hop Limit <= 1) {
S06.     Send an ICMP Time Exceeded message to the Source Address,
           Code 0 (Hop limit exceeded in transit),
           interrupt packet processing and discard the packet.
S07.   }
S08.   max_LE = (Hdr Ext Len / 2) - 1
R01.   If (DA.Arg.Index != 0) {
R02.     If ((Last Entry > max_LE) or (Segments Left > Last Entry)) {
R03.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R04.     }
R05.     Decrement DA.Arg.Index by 1.
R06.     If (Segment List[Segments Left][DA.Arg.Index] == 0) {
R07.       Decrement Segments Left by 1.
R08.       Decrement IPv6 Hop Limit by 1.
R09.       Update IPv6 DA with Segment List[Segments Left]
R10.1.     Push the MPLS label stack for B.
R10.2.     Submit the packet to the MPLS engine for transmission.
R11.     }
R12.   } Else {
R13.     If((Last Entry > max_LE) or (Segments Left > Last Entry+1)){
R14.       Send an ICMP Parameter Problem to the Source Address,
             Code 0 (Erroneous header field encountered),
             Pointer set to the Segments Left field,
             interrupt packet processing and discard the packet.
R15.     }
R16.     Decrement Segments Left by 1.
R17.     Set DA.Arg.Index to (128/LNFL - 1).
R18.   }
R19.   Decrement IPv6 Hop Limit by 1.
R20.   Write Segment List[Segments Left][DA.Arg.Index] into the bits
         [LBL..LBL+LNFL-1] of the Destination Address of the IPv6
         header.
R21.1. Push the MPLS label stack for B.
R21.2. Submit the packet to the MPLS engine for transmission.
S16. }
]]></sourcecode>
        <t>When processing the upper-layer header of a packet matching a FIB entry locally instantiated as an End.BM SID with the REPLACE-CSID flavor:</t>
        <sourcecode type="pseudocode"><![CDATA[
S01. If (upper-layer header type is allowed by local configuration) {
S02.   Proceed to process the upper-layer header
S03. } Else {
S04.   Send an ICMP Parameter Problem to the Source Address
          with Code 4 (SR Upper-layer Header Error)
          and Pointer set to the offset of the upper-layer header,
          interrupt packet processing, and discard the packet.
S05. }
]]></sourcecode>
      </section>
    </section>

  <section anchor="acknowledgements" numbered="false" toc="include">
      <name>Acknowledgements</name>
      <t>The authors would like to thank <contact fullname="Kamran Raza"/>, <contact fullname="Xing Jiang"/>, <contact fullname="YuanChao Su"/>, <contact fullname="Han Li"/>, <contact fullname="Yisong Liu"/>, <contact fullname="Martin Vigoureux"/>, <contact fullname="Joel Halpern"/>, and <contact fullname="Tal Mizrahi"/> for their insightful feedback and suggestions.</t>
      <t>The authors would also like to thank <contact fullname="Andrew Alston"/>, <contact fullname="Linda Dunbar"/>, <contact fullname="Adrian Farrel"/>, <contact fullname="Boris Hassanov"/>, <contact fullname="Alvaro Retana"/>, and <contact fullname="Gunter Van de Velde"/> for their thorough review of this document.</t>
    </section>
    
    <section anchor="contributors" numbered="false" toc="include" removeInRFC="false">
      <name>Contributors</name>
      <contact initials="L." surname="Aihua" fullname="Liu Aihua">
        <organization>ZTE Corporation</organization>
        <address>
          <postal>
            <country>China</country>
          </postal>
          <email>liu.aihua@zte.com.cn</email>
        </address>
      </contact>
      <contact initials="D." surname="Cai" fullname="Dennis Cai">
        <organization>Alibaba</organization>
        <address>
          <postal>
            <country>USA</country>
          </postal>
          <email>d.cai@alibaba-inc.com</email>
        </address>
      </contact>
      <contact initials="D." surname="Dukes" fullname="Darren Dukes">
        <organization>Cisco Systems, Inc.</organization>
        <address>
          <postal>
            <country>Canada</country>
          </postal>
          <email>ddukes@cisco.com</email>
        </address>
      </contact>
      <contact initials="J." surname="Guichard" fullname="James N Guichard">
        <organization>Futurewei Technologies Ltd.</organization>
        <address>
          <postal>
            <country>USA</country>
          </postal>
          <email>james.n.guichard@futurewei.com</email>
        </address>
      </contact>
      <contact initials="C." surname="Li" fullname="Cheng Li">
        <organization>Huawei Technologies</organization>
        <address>
          <postal>
            <country>China</country>
          </postal>
          <email>c.l@huawei.com</email>
        </address>
      </contact>
      <contact initials="R." surname="Raszuk" fullname="Robert Raszuk">
        <organization>NTT Network Innovations</organization>
        <address>
          <postal>
            <country>USA</country>
          </postal>
          <email>robert@raszuk.net</email>
        </address>
      </contact>
      <contact initials="K." surname="Talaulikar" fullname="Ketan Talaulikar">
        <organization>Cisco Systems, Inc.</organization>
        <address>
          <postal>
            <country>India</country>
          </postal>
          <email>ketant.ietf@gmail.com</email>
        </address>
      </contact>
      <contact initials="D." surname="Voyer" fullname="Daniel Voyer">
        <organization>Bell Canada</organization>
        <address>
          <postal>
            <country>Canada</country>
          </postal>
          <email>daniel.voyer@bell.ca</email>
        </address>
      </contact>
      <contact initials="S." surname="Zadok" fullname="Shay Zadok">
        <organization>Broadcom</organization>
        <address>
          <postal>
            <country>Israel</country>
          </postal>
          <email>shay.zadok@broadcom.com</email>
        </address>
      </contact>
    </section>
  </back>
</rfc>
