<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE rfc [
  <!ENTITY nbsp    "&#160;">
  <!ENTITY zwsp   "&#8203;">
  <!ENTITY nbhy   "&#8209;">
  <!ENTITY wj     "&#8288;">
]>

<rfc xmlns:xi="http://www.w3.org/2001/XInclude" ipr="trust200902" submissionType="IETF" category="std" version="3" docName="draft-ietf-acme-onion-07" number="9799" consensus="true" updates="" obsoletes="" xml:lang="en" tocInclude="true" symRefs="true" sortRefs="false" >

  <front>

    <title abbrev="ACME for &quot;.onion&quot;">Automated Certificate Management Environment (ACME) Extensions for ".onion"
      Special-Use Domain Names</title>
    <seriesInfo name="RFC" value="9799"/>
    <author fullname="Q Misell" role="editor" surname="Misell">
      <organization abbrev="AS207960">AS207960 Cyfyngedig</organization>
      <address>
        <postal>
          <street>13 Pen-y-lan Terrace</street>
          <city>Caerdydd</city>
          <code>CF23 9EU</code>
          <country>United Kingdom</country>
        </postal>
        <email>q@as207960.net</email>
        <email>q@magicalcodewit.ch</email>
        <uri>https://magicalcodewit.ch</uri>
      </address>
    </author>
    <date month="June" year="2025"/>


    <area>SEC</area>
    <workgroup>acme</workgroup>

    <keyword>tor</keyword>
    <keyword>hidden service</keyword>
    <keyword>onion service</keyword>
    <keyword>caa</keyword>
    <keyword>dns</keyword>

    <abstract>
      <t>This document defines extensions to the Automated Certificate Management Environment (ACME) to allow for the
        automatic issuance of certificates to Tor Hidden Services (".onion" Special-Use Domain Names).</t>
    </abstract>

    <note removeInRFC="true">
      <name>Discussion</name>
      <t>Source for this draft and an issue tracker can be found at
        <eref target="https://github.com/AS207960/acme-onion"/>.</t>
      <t>The project website and a reference implementation can be found at
        <eref target="https://acmeforonions.org"/>.</t>
    </note>
  </front>

  <middle>
    <section>
      <name>Introduction</name>
      <t>The Tor network has the ability to host "Onion Services" <xref target="tor-spec"/> only accessible via the
        Tor network. These services use the ".onion"
        Special-Use Domain Name <xref target="RFC7686"/> to identify these services. These can be used as any other domain
        name could, but they do not form part of the DNS infrastructure.</t>
      <t>The Automated Certificate Management Environment (ACME) <xref target="RFC8555"/> defines challenges for
        validating control of DNS identifiers, and whilst a ".onion" Special-Use Domain Name may appear as a DNS name,
        it requires special consideration to validate control of one such that ACME could be used on ".onion"
        Special-Use Domain Names.</t>
      <t>In order to allow ACME to be utilized to issue certificates to ".onion" Special-Use Domain Names, this document
        specifies challenges suitable to validate control of these Special-Use Domain Names. Additionally, this document
        defines an alternative to the DNS Certification Authority Authorization (CAA) Resource Record
        <xref target="RFC8659"/> that can be used with ".onion" Special-Use Domain Names.</t>

      <section>
        <name>Requirements Language</name>
        <t>
    The key words "<bcp14>MUST</bcp14>", "<bcp14>MUST NOT</bcp14>", "<bcp14>REQUIRED</bcp14>", "<bcp14>SHALL</bcp14>", "<bcp14>SHALL
    NOT</bcp14>", "<bcp14>SHOULD</bcp14>", "<bcp14>SHOULD NOT</bcp14>", "<bcp14>RECOMMENDED</bcp14>", "<bcp14>NOT RECOMMENDED</bcp14>",
    "<bcp14>MAY</bcp14>", and "<bcp14>OPTIONAL</bcp14>" in this document are to be interpreted as
    described in BCP&nbsp;14 <xref target="RFC2119"/> <xref target="RFC8174"/>
    when, and only when, they appear in all capitals, as shown here.
        </t>
      </section>
    </section>

    <section>
      <name>Identifier</name>
      <t><xref target="RFC8555"/> defines the "dns" identifier type. This identifier type <bcp14>MUST</bcp14> be used
        when requesting a certificate for a ".onion" Special-Use Domain Name. The value of the identifier
        <bcp14>MUST</bcp14> be the textual representation as defined in the "Special Hostnames in Tor - .onion" section of <xref target="tor-spec"/>.
        The value <bcp14>MAY</bcp14> include subdomain labels. Version 2 addresses <xref target="tor-rend-spec-v2"/>
        <bcp14>MUST NOT</bcp14> be used as these are now considered insecure.</t>
      <t>Example identifiers (line breaks have been added for readability only):</t>
      <sourcecode type="json"><![CDATA[
{
  "type": "dns",
  "value": "bbcweb3hytmzhn5d532owbu6oqadra5z3ar726v
        q5kgwwn6aucdccrad.onion"
}
]]></sourcecode>

      <sourcecode type="json"><![CDATA[
{
  "type": "dns",
  "value": "www.bbcweb3hytmzhn5d532owbu6oqadra5z3ar726v
        q5kgwwn6aucdccrad.onion"
}
]]></sourcecode>

    </section>

    <section>
      <name>Identifier Validation Challenges</name>
      <t>The CA/Browser Forum Baseline Requirements define methods accepted by the CA industry for validation of ".onion" Special-Use Domain Names (see <xref target="cabf-br" section="B.2" relative="#page=124"/>).
        This document incorporates these methods into ACME challenges.</t>
      <section>
        <name>Existing Challenges</name>
        <section>
          <name>Existing: "dns-01" Challenge</name>
          <t>The existing "dns-01" challenge <bcp14>MUST NOT</bcp14> be used to validate ".onion" Special-Use Domain
            Names as these domains are not part of the DNS.</t>
        </section>
        <section anchor="http01">
          <name>Existing: <tt>http-01</tt> Challenge</name>
          <t>The <tt>http-01</tt> challenge, as defined in <xref target="RFC8555" section="8.3"/>, <bcp14>MAY</bcp14>
            be used to validate a ".onion" Special-Use Domain Name with the modifications defined in this document,
            namely those described in Sections
          <xref target="client-auth" format="counter"/> and <xref target="caa" format="counter"/>.</t>
          <t>The ACME server <bcp14>SHOULD</bcp14> follow redirects. Note that these <bcp14>MAY</bcp14> be redirects to services that are not ".onion" and that the server <bcp14>SHOULD</bcp14> honor these. For example, clients might use redirects so that the response can be provided by a centralized certificate management server. See
            <xref target="RFC8555" section="10.2"/> for security considerations on why a server might not want to
            follow redirects.</t>
        </section>
        <section anchor="tlsalpn">
          <name>Existing <tt>tls-alpn-01</tt> Challenge</name>
          <t>The <tt>tls-alpn-01</tt> challenge, as defined in <xref target="RFC8737"/>, <bcp14>MAY</bcp14> be used to
            validate a ".onion" Special-Use Domain Name with the modifications defined in this document, namely those
            described in Sections <xref target="client-auth" format="counter"/> and <xref target="caa" format="counter"/>.</t>
        </section>
      </section>
      <section>
        <name>New <tt>onion-csr-01</tt> Challenge</name>
        <t>The two ACME-defined methods allowed by CA/BF described in Sections <xref target="http01" format="counter"/> and <xref target="tlsalpn" format="counter"/>
          (<tt>http-01</tt> and <tt>tls-alpn-01</tt>) do not allow issuance of wildcard certificates.
          A ".onion" Special-Use Domain Name can have subdomains (just like any other domain in the DNS), and a site
          operator may find it useful to have one certificate for all virtual hosts on their site. This new validation
          method incorporates the specially signed Certificate Signing Request (CSR) (as defined by
          <xref target="cabf-br" section="B.2.b" relative="#page=124"/>) into ACME to allow for the issuance of
          wildcard certificates.</t>
        <t>To this end, a new challenge called <tt>onion-csr-01</tt> is defined, with the following fields:</t>
        <dl>
          <dt>type (required, string):</dt>
          <dd>The string <tt>onion-csr-01</tt>.</dd>
          <dt>nonce (required, string):</dt>
          <dd>A Base64-encoded nonce <xref target="RFC4648"/> including padding characters.
            It <bcp14>MUST</bcp14> contain at least 64 bits of entropy. A response generated  using this nonce
            <bcp14>MUST NOT</bcp14> be accepted by the ACME server if the nonce used was generated by the server more
            than 30 days prior (as per <xref target="cabf-br" section="B.2.b" relative="#page=124"/>).</dd>
          <dt>authKey (optional, object):</dt>
          <dd>The ACME server's Ed25519 public key encoded as per <xref target="RFC8037"/>. This is further defined in
            <xref target="client-auth"/>.</dd>
        </dl>
        <sourcecode type="json"><![CDATA[
{
  "type": "onion-csr-01",
  "url": "https://acme-server.example.onion/acme/chall/bbc625c5",
  "status": "pending",
  "nonce": "bI6/MRqV4gw=",
  "authKey": { ... }
}
]]></sourcecode>
        <t>An <tt>onion-csr-01</tt> challenge <bcp14>MUST NOT</bcp14> be used to issue certificates for
          Special-Use Domain Names that are not ".onion".</t>
        <t>Clients prove control over the key associated with the ".onion" service by generating a
          Certificate Request (CSR) <xref target="RFC2986"/> with the following additional extension attributes and
          signing it with the private key of the ".onion" Special-Use Domain Name:</t>
        <ul>
          <li>A <tt>caSigningNonce</tt> attribute containing the nonce provided in the challenge. This
            <bcp14>MUST</bcp14> be raw bytes and not the base64 encoded value provided in the challenge object.</li>
          <li>An <tt>applicantSigningNonce</tt> attribute containing a nonce generated by the client. This <bcp14>MUST</bcp14>
            have at least 64 bits of entropy. This <bcp14>MUST</bcp14> be raw bytes.</li>
        </ul>
        <t>These additional attributes have the following format</t>
        <sourcecode type="asn.1"><![CDATA[
cabf OBJECT IDENTIFIER ::=
  { joint-iso-itu-t(2) international-organizations(23)
    ca-browser-forum(140) }

cabf-caSigningNonce OBJECT IDENTIFIER ::= { cabf 41 }

caSigningNonce ATTRIBUTE ::= {
  WITH SYNTAX             OCTET STRING
  EQUALITY MATCHING RULE  octetStringMatch
  SINGLE VALUE            TRUE
  ID                      { cabf-caSigningNonce }
}

cabf-applicantSigningNonce OBJECT IDENTIFIER ::= { cabf 42 }

applicantSigningNonce ATTRIBUTE ::= {
  WITH SYNTAX             OCTET STRING
  EQUALITY MATCHING RULE  octetStringMatch
  SINGLE VALUE            TRUE
  ID                      { cabf-applicantSigningNonce }
}
]]></sourcecode>
        <t>The subject of the CSR need not be meaningful and CAs <bcp14>MUST NOT</bcp14> validate its contents.
          The public key presented in this CSR <bcp14>MUST</bcp14> be the public key corresponding to the ".onion"
          Special-Use Domain Name being validated. It <bcp14>MUST NOT</bcp14> be the same public key presented in the
          CSR to finalize the order.</t>
        <t>Clients respond with the following object to validate the challenge:</t>
        <dl>
          <dt>csr (required, string):</dt>
          <dd>
            The CSR in the base64url-encoded version of the DER format.
            (Note: Because this field uses base64url, and does not include headers, it is different from Privacy Enhanced Mail (PEM).)
          </dd>
        </dl>
        <sourcecode type="http"><![CDATA[
POST /acme/chall/bbc625c5
Host: acme-server.example.onion
Content-Type: application/jose+json

{
  "protected": base64url({
    "alg": "ES256",
    "kid":
        "https://acme-server.example.onion/acme/acct/evOfKhNU60wg",
    "nonce": "UQI1PoRi5OuXzxuX7V7wL0",
    "url": "https://acme-server.example.onion/acme/chall/bbc625c5"
  }),
  "payload": base64url({
    "csr": "MIIBPTCBxAIBADBFMQ...FS6aKdZeGsysoCo4H9P"
  }),
  "signature": "Q1bURgJoEslbD1c5...3pYdSMLio57mQNN4"
}
]]></sourcecode>
        <t>When presented with the CSR, the server verifies it in the following manner:</t>
        <ol>
          <li>The CSR is a well formatted PKCS#10 request.</li>
          <li>The public key in the CSR corresponds to the ".onion" Special-Use Domain Name being validated.</li>
          <li>The signature over the CSR validates with the ".onion" Special-Use Domain Name public key.</li>
          <li>The <tt>caSigningNonce</tt> attribute is present and its contents match the nonce provided to the client.</li>
          <li>The <tt>applicantSigningNonce</tt> attribute is present and contains at least 64 bits of entropy.</li>
        </ol>
        <t>If all of the above are successful then validation succeeds, otherwise it has failed.</t>
      </section>
    </section>

    <section anchor="client-auth">
      <name>Client Authentication to Hidden Services</name>
      <t>Some Hidden Services do not wish to be accessible to the entire Tor network, and so they encrypt their Hidden
        Service Descriptor with the keys of clients authorized to connect. Without a way for the CA to signal what key
        it will use to connect, these services will not be able to obtain a certificate using <tt>http-01</tt> or
        <tt>tls-alpn-01</tt>, nor enforce CAA with any validation method.</t>
      <t>To this end, an additional field in the challenge object is defined to allow the ACME server to advertise the
        Ed25519 public key it will use (as per the "Authentication during the introduction phase" section of
        <xref target="tor-spec"/>) to
        authenticate itself when retrieving the Hidden Service Descriptor.</t>
      <dl>
        <dt>authKey (optional, object):</dt>
        <dd>The ACME server's Ed25519 public key encoded as per <xref target="RFC8037"/>.</dd>
      </dl>
      <t>ACME servers <bcp14>MUST NOT</bcp14> use the same public key with multiple Hidden Services.
        ACME servers <bcp14>MAY</bcp14> reuse public keys for re-validation of the same Hidden Service.</t>
      <t>There is no method to communicate to the CA that client authentication is necessary; instead, the ACME server
        <bcp14>MUST</bcp14> attempt to calculate its CLIENT-ID as per the "Client behavior" section of
        <xref target="tor-spec"/>.
        If no <tt>auth-client</tt> line in the First Layer Hidden Service Descriptor matches the computed client-id,
        then the server <bcp14>MUST</bcp14> assume that the Hidden Service does not require client authentication and
        proceed accordingly.</t>
      <t>In the case in which the Ed25519 public key is novel to the client, it will have to resign and republish its Hidden Service
        Descriptor. It <bcp14>MUST</bcp14> wait some (indeterminate) amount of time for the new descriptor to
        propagate the Tor Hidden Service directory servers before proceeding with responding to the challenge.
        This should take no more than a few minutes. This specification does not set a fixed time as changes in the
        operation of the Tor network can affect this propagation time in the future. ACME servers
        <bcp14>MUST NOT</bcp14> expire challenges before a reasonable time to allow publication of the new descriptor. It is <bcp14>RECOMMENDED</bcp14> the server allow at least 30 minutes; however, it is entirely up to operator preference.</t>
    </section>

    <section>
      <name>ACME over Hidden Services</name>
      <t>A CA offering certificates to ".onion" Special-Use Domain Names <bcp14>SHOULD</bcp14> make their
        ACME server available as a Tor Hidden Service. ACME clients <bcp14>SHOULD</bcp14> also support connecting to
        ACME servers over Tor, regardless of their support of <tt>onion-csr-01</tt>, as their existing <tt>http-01</tt>
        and <tt>tls-alpn-01</tt> implementations could be used to obtain certificates for ".onion" Special-Use Domain Names.</t>
    </section>

    <section anchor="caa">
      <name>Certification Authority Authorization (CAA)</name>
      <t>".onion" Special-Use Domain Names are not part of the DNS; as such, a variation on CAA <xref target="RFC8659"/>
        is necessary to allow restrictions to be placed on certificate issuance.</t>
      <t>To this end, a new field is added to the Second Layer Hidden Service Descriptor, as defined in the "Second layer plaintext format" section of
        <xref target="tor-spec"/>
        with the following format (defined using the notation from the "netdoc document meta-format" section of
        <xref target="tor-spec"/>):</t>
      <sourcecode><![CDATA[
"caa" SP flags SP tag SP value NL
[Any number of times]
]]></sourcecode>
      <t>The presentation format is provided above purely for the convenience of the reader and implementors:
        the canonical version remains that defined in <xref target="RFC8659" section="4.1.1"/>,
        or future updates to the same.</t>
      <t>The contents of "flags", "tag", and "value" are as per <xref target="RFC8659" section="4.1.1"/>.
        Multiple CAA records <bcp14>MAY</bcp14> be present, as is the case in the DNS. CAA records in a Hidden Service
        Descriptor are to be treated the same by CAs as if they had been in the DNS for the ".onion" Special-Use
        Domain Name.</t>
      <t>A Hidden Service's Second Layer Descriptor using CAA could look something like the following
        (additional line breaks have been added for readability):</t>
      <sourcecode><![CDATA[
create2-formats 2
single-onion-service
caa 128 issue "acmeforonions.example;validationmethods=onion-csr-01"
caa 0 iodef "mailto:security@example.com"
introduction-point AwAGsAk5nSMpAhRqhMHbTFCTSlfhP8f5PqUhe6DatgMgk7kSL3
        KHCZUZ3C6tXDeRfM9SyNY0DlgbF8q+QSaGKCs=
...
]]></sourcecode>
      <section>
        <name>Relevant Resource Record Set</name>
        <t>In the absence of the possibility for delegation of subdomains from a ".onion" Special-Use Domain Name, as
          there is in the DNS, there is no need, nor indeed any method available, to search up the DNS tree for a
          relevant CAA record set. Similarly, it is also impossible to check CAA records on the "onion" Special-Use Top-Level Domain (TLD),
          as it does not exist in any form except as described in <xref target="RFC7686"/>; therefore, implementors
          <bcp14>MUST NOT</bcp14> look there either.</t>
        <t>Instead, all subdomains under a ".onion" Special-Use Domain Name share the same CAA record set. That is,
          all of these share a CAA record set with "a.onion":</t>
        <ul>
          <li>b.a.onion</li>
          <li>c.a.onion</li>
          <li>e.d.a.onion</li>
        </ul>
        <t>but these do not:</t>
        <ul>
          <li>b.c.onion</li>
          <li>c.d.onion</li>
          <li>e.c.d.onion</li>
          <li>a.b.onion</li>
        </ul>
      </section>
      <section>
        <name>When to Check CAA</name>
        <t>If the Hidden Service has client authentication enabled, then it will be impossible for the ACME server to
          decrypt the Second Layer Hidden Service Descriptor to read the CAA records until the ACME server's public key has been added
          to the First Layer Hidden Service Descriptor. To this end, an ACME server <bcp14>MUST</bcp14> wait until the
          client responds to an authorization before checking the CAA and treat this response as an indication that
          their public key has been added and that the ACME server will be able to decrypt the Second Layer Hidden
          Service Descriptor.</t>
      </section>
      <section>
        <name>Preventing Mis-Issuance by Unknown CAs</name>
        <t>In the case of a Hidden Service requiring client authentication, the CA will be unable to read the hidden
          service's CAA records without the Hidden Service trusting an ACME server's public key -- as the CAA records are
          in the Second Layer Hidden Service Descriptor. A method is necessary to signal that there are CAA records
          present (but not reveal their contents, which, in certain circumstances, would unwantedly disclose information
          about the Hidden Service operator).</t>
        <t>To this end, a new field is added to the First Layer Hidden Service Descriptor in the "First layer plaintext format" section of
          <xref target="tor-spec"/>
          with the following format (defined using the notation from the "netdoc document meta-format" section of
        <xref target="tor-spec"/>):</t>
        <sourcecode><![CDATA[
"caa-critical" NL
[At most once]
]]></sourcecode>
        <t>If an ACME server encounters this flag, it <bcp14>MUST NOT</bcp14> proceed with issuance until it can decrypt
          and parse the CAA records from the Second Layer Hidden Service Descriptor.</t>
      </section>
      <section>
        <name>Alternative In-Band Presentation of CAA</name>
        <t>An ACME server might be unwilling to operate the infrastructure required to fetch, decode, and verify Tor
          Hidden Service Descriptors in order to check CAA records. To this end a method to signal CAA policies in-band
          of ACME is defined.</t>
        <t>If a Hidden Service does use this method to provide CAA records to an ACME server, it <bcp14>SHOULD</bcp14>
          still publish CAA records if its CAA record set includes "iodef", "contactemail", or "contactphone" so that
          this information is still publicly accessible. Additionally, a Hidden Service operator <bcp14>MAY</bcp14>
          not wish to publish a CAA record set in its Hidden Service Descriptor to avoid revealing information about the
          service operator.</t>
        <t>If an ACME server receives a validly signed CAA record set in the finalize request, it <bcp14>MAY</bcp14>
          proceed with issuance on the basis of the client-provided CAA record set only, without checking the CAA set in
          the Hidden Service. Alternatively, an ACME server <bcp14>MAY</bcp14> ignore the client provided record set and
          fetch the record set from the Hidden Service Descriptor. In any case, the server <bcp14>MAY</bcp14> fetch the
          record set from the Hidden Service Descriptor. If an ACME server receives a validly signed CAA record set in
          the finalize request, it need not check the CAA set in the Hidden Service Descriptor and can proceed with
          issuance on the basis of the client-provided CAA record set only. An ACME server <bcp14>MAY</bcp14> ignore the
          client-provided record set and is free to always fetch the record set from the Hidden Service Descriptor.</t>
        <t>A new field is defined in the ACME finalize endpoint to contain the Hidden Service's CAA record set for each
          ".onion" Special-Use Domain Name in the order.</t>
        <dl>
          <dt>onionCAA (optional, dictionary of objects):</dt>
          <dd>
            The CAA record set for each ".onion" Special-Use Domain Name in the order. The key is the ".onion"
            Special-Use Domain Name, and the value is an object with the fields described below.
          </dd>
        </dl>
        <t>The contents of the values of the "onionCAA" object are as follows:</t>
        <dl>
          <dt>caa (required, string or null):</dt>
          <dd>
            The CAA record set as a string, encoded in the same way as if was included in the Hidden Service Descriptor.
            If the Hidden Service does not have a CAA record set, then this <bcp14>MUST</bcp14> be null.
          </dd>
          <dt>expiry (required, integer):</dt>
          <dd>
            The Unix timestamp at which this CAA record set will expire. This <bcp14>SHOULD NOT</bcp14> be more than
            8 hours in the future. ACME servers <bcp14>MUST</bcp14> process this as at least a 64-bit integer to ensure
            functionality beyond 2038.
          </dd>
          <dt>signature (required, string):</dt>
          <dd>
            The Ed25519 signature of the CAA record set using the private key corresponding to the ".onion"
            Special-Use Domain Name, encoded using base64url. The signature is defined below.
          </dd>
        </dl>
        <t>The data that the signature is calculated over is the concatenation of the following,
          encoded in UTF-8 <xref target="RFC3629"/>:</t>
        <sourcecode><![CDATA["onion-caa|" || expiry || "|" || caa]]></sourcecode>

        <t>Where "|" is the ASCII character 0x7C, and expiry is the expiry field as a decimal string with no
          leading zeros. If the caa field is null, it is represented as an empty string in the signature calculation.</t>
        <section>
          <name>ACME Servers Requiring In-Band CAA</name>
          <t>If an ACME server does not support fetching a service's CAA record set from its Hidden Service Descriptor,
            and the ACME client does not provide an "onionCAA" object in its finalize request, the ACME server
            <bcp14>MUST</bcp14> respond with an "onionCAARequired" error to indicate this.</t>
          <t>To support signaling the server's support for fetching CAA record sets over Tor,
            a new field is defined in the directory "meta" object to signal this.</t>
          <dl>
            <dt>inBandOnionCAARequired (optional, boolean):</dt>
            <dd>
              If true, the ACME server requires the client to provide the CAA record set in the finalize request.
              If false or absent, the ACME server does not require the client to provide the CAA record set is this
              manner.</dd>
          </dl>
          <t>A directory of such a CA could look like the following:</t>
          <sourcecode type="http"><![CDATA[
HTTP/1.1 200 OK
Content-Type: application/json

{
  "newNonce": "https://acme-server.example.onion/acme/new-nonce",
  "newAccount": "https://acme-server.example.onion/acme/new-account",
  "newOrder": "https://acme-server.example.onion/acme/new-order",
  "revokeCert": "https://acme-server.example.onion/acme/revoke-cert",
  "keyChange": "https://acme-server.example.onion/acme/key-change",
  "meta": {
    "termsOfService":
        "https://acme-server.example.onion/acme/terms/2023-10-13",
    "website": "https://acmeforonions.example/",
    "caaIdentities": ["acmeforonions.example"],
    "inBandOnionCAARequired": true
  }
}
]]></sourcecode>
        </section>
        <section>
          <name>Example In-Band CAA</name>
          <t>Given the following example CAA record set for 5anebu2glyc235wbbop3m2ukzlaptpkq333vdtdvcjpigyb7x2i2m2qd.onion
            (additional line breaks have been added for readability):</t>
          <sourcecode><![CDATA[
caa 128 issue "acmeforonions.example;
            validationmethods=onion-csr-01"
caa 0 iodef "mailto:example@example.com"
]]></sourcecode>
          <t>The following would be submitted to the ACME server's finalize endpoint
            (additional line breaks have been added for readability):</t>
          <sourcecode type="http"><![CDATA[
POST /acme/order/TOlocE8rfgo/finalize
Host: acme-server.example.onion
Content-Type: application/jose+json

{
  "protected": base64url({
    "alg": "ES256",
    "kid":
        "https://acme-server.example.onion/acme/acct/evOfKhNU60wg",
    "nonce": "MSF2j2nawWHPxxkE3ZJtKQ",
    "url": "https://acme-server.example.onion/acme/order/
        TOlocE8rfgo/finalize"
  }),
  "payload": base64url({
    "csr": "MIIBPTCBxAIBADBFMQ...FS6aKdZeGsysoCo4H9P",
    "onionCAA": {
      "5anebu2glyc235wbbop3m2ukzlaptpkq333vdtdvcjpi
            gyb7x2i2m2qd.onion": {
        "caa": "caa 128 issue \"acmeforonions.example;
            validationmethods=onion-csr-01\"\n
            caa 0 iodef \"mailto:example@example.com\"",
        "expiry": 1697210719,
        "signature": "u_iP6JZ4JZBrzQUKH6lSrWejjRfeQmkTuehc0_FaaTNP
            AV0RVxpUz9r44DRdy6kgy0ofnx18KIhMrP7N1wpxAA=="
      }
    }
  }),
  "signature": "uOrUfIIk5RyQ...nw62Ay1cl6AB"
}
]]></sourcecode>
        </section>
      </section>
    </section>

    <section anchor="IANA">
      <name>IANA Considerations</name>
      <section>
        <name>Validation Methods</name>
        <t>One new entry has been added to the "ACME Validation Methods" registry that was defined in
          <xref target="RFC8555" section="9.7.8"/>
          (<eref brackets="angle" target="https://www.iana.org/assignments/acme"/>).</t>
        <table>
          <name>onion-csr-01 Validation Method</name>
          <thead>
            <tr>
              <th>Label</th>
              <th>Identifier Type</th>
              <th>ACME</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>onion-csr-01</td>
              <td>dns</td>
              <td>Y</td>
              <td>RFC 9799</td>
            </tr>
          </tbody>
        </table>
      </section>
      <section>
        <name>Error Types</name>
        <t>One new entry has been added to the "ACME Error Types" registry that was defined in
          <xref target="RFC8555" section="9.7.4"/>
          (<eref brackets="angle" target="https://www.iana.org/assignments/acme"/>).</t>
        <table>
          <name>onionCAARequired Error Type</name>
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>onionCAARequired</td>
              <td>The CA only supports checking the CAA for Hidden Services in-band, but the client has not provided an
                in-band CAA</td>
              <td>RFC 9799</td>
            </tr>
          </tbody>
        </table>
      </section>
      <section>
        <name>Directory Metadata Fields</name>
        <t>One new entry has been added to the "ACME Directory Metadata Fields" registry that was defined in
          <xref target="RFC8555" section="9.7.6"/>
          (<eref brackets="angle" target="https://www.iana.org/assignments/acme"/>).</t>
        <table>
          <name>onionCAARequired Metadata Field</name>
          <thead>
            <tr>
              <th>Field name</th>
              <th>Field type</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>onionCAARequired</td>
              <td>boolean</td>
              <td>RFC 9799</td>
            </tr>
          </tbody>
        </table>
      </section>
    </section>

    <section anchor="Security">
      <name>Security Considerations</name>
      <section>
        <name>Security of the <tt>onion-csr-01</tt> Challenge</name>
        <t>The security considerations of <xref target="cabf-br"/> apply to issuance using the Certificate Request method.</t>
      </section>
      <section anchor="security-id-dns">
        <name>Use of the "dns" Identifier Type</name>
        <t>The reuse of the "dns" identifier type for a Special-Use Domain Name not actually in the DNS infrastructure
          raises questions regarding its suitability. The reasons to pursue this path in the first place are detailed in
          <xref target="use-of-id-dns"/>. It is felt that there is little security concern in reuse of the "dns"
          identifier type with regard to the mis-issuance by CAs that are not aware of ".onion"
          Special-Use Domain Names as CAs would not be able to resolve the identifier in the DNS.</t>
        <section>
          <name><tt>http-01</tt> Challenge</name>
          <t>In the absence of knowledge of this document, a CA would follow the procedure set out in
            <xref target="RFC8555" section="8.3"/>, which specifies that the CA should "Dereference the URL using an
            HTTP GET request". Given that ".onion" Special-Use Domain Names require special handling to dereference,
            this dereferencing will fail, disallowing issuance.</t>
        </section>
        <section>
          <name><tt>tls-alpn-01</tt> Challenge</name>
          <t>In the absence of knowledge of this document, a CA would follow the procedure set out in
            <xref target="RFC8737" section="3"/>, which specifies that the CA "resolves the domain name being validated
            and chooses one of the IP addresses returned for validation". Given that ".onion" Special-Use Domain Names
            are not resolvable to IP addresses, this dereferencing will fail, disallowing issuance.</t>
        </section>
        <section>
          <name><tt>dns-01</tt> Challenge</name>
          <t>In the absence of knowledge of this document, a CA would follow the procedure set out in
            <xref target="RFC8555" section="8.4"/>, which specifies that the CA should "query for TXT records for the
            validation domain name". Given that ".onion" Special-Use Domain Names are not present in the DNS
            infrastructure, this query will fail, disallowing issuance.</t>
        </section>
      </section>
      <section>
        <name>Key Authorization with <tt>onion-csr-01</tt></name>
        <t>The <tt>onion-csr-01</tt> challenge does not make use of the key authorization string defined in
          <xref target="RFC8555" section="8.1"/>. This does not weaken the integrity of authorizations.</t>
        <t>The key authorization exists to ensure that, whilst an attacker observing the validation channel can observe
          the correct validation response, they cannot compromise the integrity of authorizations as the response
          can only be used with the account key for which it was generated. As the validation channel for this challenge
          is ACME itself, and ACME already requires that the request be signed by the account, the key authorization is
          not necessary.</t>
      </section>
      <section>
        <name>Use of Tor for Domains That Are Not ".onion"</name>
        <t>An ACME server <bcp14>MUST NOT</bcp14> utilize Tor for the validation of domains that are not ".onion", due to the
          risk of exit hijacking <xref target="spoiled-onions"/>.</t>
      </section>
      <section>
        <name>Redirects with <tt>http-01</tt></name>
        <t>A site <bcp14>MAY</bcp14> redirect to another site when completing validation using the <tt>http-01</tt>
          challenge. This redirect <bcp14>MAY</bcp14> be to either another ".onion" Special-Use Domain Name or a domain
          in the public DNS. A site operator <bcp14>MUST</bcp14> consider the privacy implications of redirecting to a
          site that is not ".onion" -- namely that the ACME server operator will then be able to learn information about
          the site they were redirected to that they would not have if accessed via a ".onion" Special-Use Domain Name,
          such as its IP address. If the site redirected to is on the same or an adjacent host to the ".onion"
          Special-Use Domain Name, this reveals information that the "Tor Rendezvous Specification - Version 3" section of <xref target="tor-spec"/> was otherwise designed to protect.</t>
        <t>If an ACME server receives a redirect to a domain in the public DNS, it <bcp14>MUST NOT</bcp14> utilize Tor
          to make a connection to it due to the risk of exit hijacking.</t>
      </section>
      <section>
        <name>Security of CAA Records</name>
        <t>The Second Layer Hidden Service Descriptor is signed, encrypted, and encoded using a Message Authentication
          Code (MAC) in a way that only a party with access to the secret key of the Hidden Service could manipulate
          what is published there. For more information about this process, see the
          "Hidden service descriptors: encryption format" section of <xref target="tor-spec"/>.</t>
      </section>
      <section>
        <name>In-Band CAA</name>
        <t>Tor directory servers are inherently untrusted entities. As such, there is no difference in the security model for accepting CAA records directly from the ACME client or fetching them over Tor: the CAA records are verified using the same hidden service key in either case.</t>
      </section>
      <section>
        <name>Access of the Tor Network</name>
        <t>The ACME server <bcp14>MUST</bcp14> make its own connection to the Hidden Service via the Tor network
          and <bcp14>MUST NOT</bcp14> outsource this to a third-party service, such as Tor2Web.</t>
      </section>
      <section>
        <name>Anonymity of the ACME Client</name>
        <t>ACME clients requesting certificates for ".onion" Special-Use Domain Names not over the Tor network can
          inadvertently expose the existence of a Hidden Service on the host requesting
          certificates to unintended parties; this is true even when features such as Encrypted ClientHello (ECH) <xref target="I-D.ietf-tls-esni"/> are
          utilized, as the IP addresses of ACME servers are generally well-known, static, and not used for any other
          purpose.</t>
        <t>ACME clients <bcp14>SHOULD</bcp14> connect to ACME servers over the Tor network to alleviate this, preferring
        a Hidden Service endpoint if the CA provides such a service.</t>
        <t>If an ACME client requests a publicly trusted WebPKI certificate, it will expose the existence of the Hidden
          Service publicly due to its inclusion in Certificate Transparency logs <xref target="RFC9162"/>. Hidden Service
          operators <bcp14>MUST</bcp14> consider the privacy implications of this before requesting WebPKI
          certificates. ACME client developers <bcp14>SHOULD</bcp14> warn users about the risks of CT-logged
          certificates for Hidden Services.</t>
        <section>
          <name>Avoid Unnecessary Certificates</name>
          <t>Not all services will need a publicly trusted WebPKI certificate; for internal or non-public services,
            operators <bcp14>SHOULD</bcp14> consider using self-signed or privately trusted certificates that aren't
            logged to certificate transparency.</t>
        </section>
        <section>
          <name>Obfuscate Subscriber Information</name>
          <t>When an ACME client is registering with an ACME server, it <bcp14>SHOULD</bcp14> provide minimal or obfuscated
            subscriber details to the CA, such as a pseudonymous email address, if at all possible.</t>
        </section>
        <section>
          <name>Separate ACME Account Keys</name>
          <t>If a Hidden Service operator does not want their different Hidden Services to be correlated by a CA, they
            <bcp14>MUST</bcp14> use separate ACME account keys for each Hidden Service.</t>
        </section>
      </section>
    </section>
  </middle>

  <back>
    <displayreference target="I-D.ietf-tls-esni" to="tls-esni"/>
    <references>
      <name>References</name>
      <references>
        <name>Normative References</name>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2986.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.4648.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7686.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8037.xml"/>
	        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8555.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8659.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8737.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.3629.xml"/>

        <reference anchor="tor-spec" target="https://spec.torproject.org">
          <front>
            <title>Tor Specifications</title>
            <author>
              <organization>The Tor Project</organization>
            </author>
          </front>
        </reference>

        <reference anchor="tor-rend-spec-v2" target="https://spec.torproject.org/rend-spec-v2">
          <front>
            <title>Tor Rendezvous Specification - Version 2</title>
            <author>
              <organization>The Tor Project</organization>
            </author>
          </front>
          <refcontent>commit 2437d19c</refcontent>
        </reference>


        <reference anchor="cabf-br" target="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.6.pdf">
          <front>
            <title>Baseline Requirements for the Issuance and Management of Publicly-Trusted TLS Server Certificates</title>
            <author>
              <organization>CA/Browser Forum</organization>
            </author>
            <date day="5" month="August" year="2024"/>
          </front>
          <refcontent>Version 2.0.6</refcontent>
        </reference>

      </references>
      <references>
        <name>Informative References</name>

        <reference anchor="onion-services-setup" target="https://community.torproject.org/onion-services/setup/">
          <front>
            <title>Set Up Your Onion Service</title>
            <author>
              <organization>The Tor Project</organization>
            </author>
          </front>
        </reference>
        <reference anchor="spoiled-onions">
          <front>
            <title>Spoiled Onions: Exposing Malicious Tor Exit Relays</title>
            <author fullname="Philipp Winter"/>
            <author fullname="Richard Köwer"/>
            <author fullname="Martin Mulazzani"/>
            <author fullname="Markus Huber"/>
            <author fullname="Sebastian Schrittwieser"/>
            <author fullname="Stefan Lindskog"/>
            <author fullname="Edgar Weippl"/>
            <date year="2014"/>
          </front>
          <refcontent>Privacy Enhancing Technologies (PETS 2014), Lecture Notes in Computer Science, vol. 8555, pp. 304-331</refcontent>
          <seriesInfo name="DOI" value="10.1007/978-3-319-08506-7_16"/>
        </reference>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-tls-esni.xml"/>
        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9162.xml"/>
      </references>
    </references>

    <section anchor="use-of-id-dns">
      <name>Discussion on the Use of the "dns" Identifier Type</name>
      <t>The reasons for utilizing the "dns" identifier type in ACME and not defining a new identifier type for
        ".onion" may not seem obvious at first glance. After all, ".onion" Special-Use Domain
        Names are not part of the DNS infrastructure and, as such, why should they use the "dns" identifier type?</t>
      <t><xref target="cabf-br" section="B.2.a.ii" relative="#page=124"/> defines, and this document allows,
        using the <tt>http-01</tt> or <tt>tls-alpn-01</tt> validation methods already present in ACME (with some
        considerations). Given the situation of a web server placed behind a Tor-terminating proxy (as per the setup
        suggested by the Tor project <xref target="onion-services-setup"/>), existing ACME tooling can be blind to the
        fact that a ".onion" Special-Use Domain Name is being utilized, as they simply receive an incoming TCP
        connection as they would regardless (albeit from the Tor-terminating proxy).</t>
      <t>An example of this would be Certbot placing the ACME challenge response file in the webroot of an NGINX web
        server. Neither Certbot nor NGINX would require any modification to be aware of any special handling for
        ".onion" Special-Use Domain Names.</t>
      <t>This does raise some questions regarding security within existing implementations; however, the authors believe
        this is of little concern, as per <xref target="security-id-dns"/>.</t>
    </section>

    <section anchor="Acknowledgements" numbered="false">
      <name>Acknowledgements</name>
      <t>With thanks to the Open Technology Fund for funding the work that went into this document.</t>
      <t>The authors also wish to thank the following for their input on this document:</t>
      <ul>
        <li><t><contact fullname="Iain Learmonth"/></t></li>
        <li><t><contact fullname="Jan-Frederik Rieckers"/></t></li>
      </ul>
    </section>
  </back>
</rfc>
