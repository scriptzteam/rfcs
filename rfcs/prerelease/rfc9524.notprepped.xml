<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE rfc [
 <!ENTITY nbsp    "&#160;">
 <!ENTITY zwsp   "&#8203;">
 <!ENTITY nbhy   "&#8209;">
 <!ENTITY wj     "&#8288;">
]> 

<rfc category="std" consensus="true"
     docName="draft-ietf-spring-sr-replication-segment-19" ipr="trust200902"
     number="9524" obsoletes="" sortRefs="true" submissionType="IETF"
     symRefs="true" tocDepth="3" tocInclude="true" updates="" version="3"
     xml:lang="en">
  <front>

    <title abbrev="SR Replication Segment">Segment Routing Replication
    for Multipoint Service Delivery</title>

    <seriesInfo name="RFC" value="9524"/>

    <author fullname="Daniel Voyer" initials="D." role="editor"
            surname="Voyer">
      <organization>Bell Canada</organization>
      <address>
        <postal>
          <city>Montreal</city>
          <country>Canada</country>
        </postal>
        <email>daniel.voyer@bell.ca</email>
      </address>
    </author>

    <author fullname="Clarence Filsfils" initials="C." surname="Filsfils">
      <organization>Cisco Systems, Inc.</organization>
      <address>
        <postal>
          <city>Brussels</city>
          <country>Belgium</country>
        </postal>
        <email>cfilsfil@cisco.com</email>
      </address>
    </author>

    <author fullname="Rishabh Parekh" initials="R." surname="Parekh">
      <organization>Cisco Systems, Inc.</organization>
      <address>
        <postal>
          <city>San Jose</city>
          <region>CA</region>
          <country>United States of America</country>
        </postal>
        <email>riparekh@cisco.com</email>
      </address>
    </author>

    <author fullname="Hooman Bidgoli" initials="H." surname="Bidgoli">
      <organization>Nokia</organization>
      <address>
        <postal>
          <city>Ottawa</city>
          <country>Canada</country>
        </postal>
        <email>hooman.bidgoli@nokia.com</email>
      </address>
    </author>

    <author fullname="Zhaohui Zhang" initials="Z." surname="Zhang">
      <organization>Juniper Networks</organization>
      <address>
        <email>zzhang@juniper.net</email>
      </address>
    </author>

    <date month="February" year="2024"/>

    <area>rtg</area>
    <workgroup>spring</workgroup>

    <abstract>
      <t>This document describes the Segment Routing Replication segment for
      multipoint service delivery. A Replication segment allows a packet to be
      replicated from a replication node to downstream nodes.</t>
    </abstract>
  </front>

  <middle>
    <section numbered="true" toc="default">
      <name>Introduction</name>

      <t>The Replication segment is a new type of segment for Segment Routing
      (SR) <xref format="default" target="RFC8402"/>, which allows a node
      (henceforth called a "replication node") to replicate packets to a set
      of other nodes (called "downstream nodes") in an SR domain.
      A Replication segment can replicate packets to directly connected nodes
      or to downstream nodes (without the need for state on the transit
      routers). This document focuses on specifying the behavior of a
      Replication segment for both Segment Routing with Multiprotocol Label
      Switching (SR-MPLS) <xref format="default" target="RFC8660"/> and
      Segment Routing with IPv6 (SRv6) <xref format="default"
      target="RFC8986"/>. The examples in <xref format="default"
      target="Appendix"/> illustrate the behavior of a Replication Segment in
      an SR domain. The use of two or more Replication segments stitched
      together to form a tree using a control plane is left to be specified in
      other documents. The management of IP multicast groups, building IP
      multicast trees, and performing multicast congestion control are out of
      scope of this document.</t>

      <section numbered="true" toc="default">
        <name>Terminology</name>

        <t>This section defines terms introduced and used frequently in this
        document. Refer to the Terminology sections of <xref format="default"
        target="RFC8402"/>, <xref format="default" target="RFC8754"/>, and
        <xref format="default" target="RFC8986"/> for other terms used in
        SR.</t>

        <dl newline="false" spacing="normal">
          <dt>Replication segment:</dt>

          <dd>A segment in an SR domain that replicates packets. See <xref
          format="default" target="RepSeg"/> for details.</dd>

          <dt>Replication node:</dt>

          <dd>A node in an SR domain that replicates packets based on a
          Replication segment.</dd>

          <dt>Downstream nodes:</dt>

          <dd>A Replication segment replicates packets to a set of nodes.
          These nodes are downstream nodes.</dd>

          <dt>Replication state:</dt>

          <dd>State held for a Replication segment at a replication node. It
          is conceptually a list of Replication branches to downstream nodes.
          The list can be empty.</dd>

          <dt>Replication-SID:</dt>

          <dd>Data plane identifier of a Replication segment. This is an
          SR-MPLS label or SRv6 Segment Identifier (SID).</dd>

          <dt>SRH:</dt>

          <dd>IPv6 Segment Routing Header <xref format="default"
          target="RFC8754"/>.</dd>

          <dt>Point-to-Multipoint (P2MP) Service:</dt>

          <dd>A service that has one ingress node and one or more egress
          nodes. A packet is delivered to all the egress nodes.</dd>

          <dt>Root node:</dt>

          <dd>An ingress node of a P2MP service.</dd>

          <dt>Leaf node:</dt>

          <dd>An egress node of a P2MP service.</dd>

          <dt>Bud node:</dt>

          <dd>A node that is both a replication node and a leaf node.</dd>
        </dl>

	        <t>
    The key words "<bcp14>MUST</bcp14>", "<bcp14>MUST NOT</bcp14>",
    "<bcp14>REQUIRED</bcp14>", "<bcp14>SHALL</bcp14>", "<bcp14>SHALL NOT</bcp14>",
    "<bcp14>SHOULD</bcp14>", "<bcp14>SHOULD NOT</bcp14>",
    "<bcp14>RECOMMENDED</bcp14>", "<bcp14>NOT RECOMMENDED</bcp14>",
    "<bcp14>MAY</bcp14>", and "<bcp14>OPTIONAL</bcp14>" in this document are to be
    interpreted as described in BCP 14 <xref target="RFC2119"/> <xref
    target="RFC8174"/> when, and only when, they appear in all capitals, as
    shown here.
        </t>
      </section>

      <section numbered="true" toc="default">
        <name>Use Cases</name>

        <t>In the simplest use case, a single Replication segment includes the
        ingress node of a multipoint service and the egress nodes of the
        service as all the downstream nodes. This achieves Ingress Replication
        <xref format="default" target="RFC7988"/> that has been widely used
        for Multicast VPN (MVPN) <xref format="default" target="RFC6513"/> and
        Ethernet VPN (EVPN) <xref format="default" target="RFC7432"/> bridging
        of Broadcast, Unknown Unicast, and Multicast (BUM) traffic.  This Replication segment on ingress and
        egress nodes can either be provisioned locally or using dynamic autodiscovery procedures for MVPN and
        EVPN. Note <xref format="default" target="RFC8986">SRv6</xref> has
        End.DT2M replication behavior for EVPN BUM traffic.</t>

        <t>Replication segments can also be used to form trees by stitching
        Replication segments on a root node, intermediate replication nodes,
        and leaf nodes for efficient delivery of MVPN and EVPN BUM
        traffic.</t>
      </section>
    </section>

    <section anchor="RepSeg" numbered="true" toc="default">
      <name>Replication Segment</name>

      <t>In an SR domain, a Replication segment is a logical
      construct that connects a replication node to a set of downstream nodes.
      A Replication segment is a local segment instantiated at a Replication
      node. It can be either provisioned locally on a node or programmed by a control plane.
	  </t>

      <t>Replication segments can be stitched together to form a tree by
      either local provisioning on nodes or using a control plane. The
      procedures for doing this are out of scope of this document. One such
      control plane using a PCE with the SR P2MP policy is specified in <xref
      format="default" target="I-D.ietf-pim-sr-p2mp-policy"/>. However, if
      local provisioning is used to stitch Replication segments, then a chain
      of Replication segments <bcp14>SHOULD NOT</bcp14> form a loop. If a
      control plane is used to stitch Replication segments, the control plane
      specification <bcp14>MUST</bcp14> prevent loops or detect and mitigate
      loops in steady state.</t>

      <t>A Replication segment is identified by the tuple &lt;Replication-ID,
      Node-ID&gt;, where:</t>

      <dl newline="false" spacing="normal">
        <dt>Replication-ID:</dt>

        <dd>An identifier for a Replication segment that is unique in context
        of the replication node.</dd>

        <dt>Node-ID:</dt>

        <dd>The address of the replication node for the Replication segment.
        Note that the root of a multipoint service is also a Replication
        node.</dd>
      </dl>

      <t>Replication-ID is a variable-length field. In the simplest case, it
      can be a 32-bit number, but it can be extended or modified as required
      based on the specific use of a Replication segment. This is out of scope
      for this document. The length of the Replication-ID is specified in the
      signaling mechanism used for the Replication segment. Examples of such
      signaling and extensions are described in <xref format="default"
      target="I-D.ietf-pim-sr-p2mp-policy"/>. When the PCE signals a
      Replication segment to its node, the &lt;Replication-ID, Node-ID&gt;
      tuple identifies the segment.</t>

      <t>A Replication segment includes the following elements:</t>

      <dl newline="false" spacing="normal">
        <dt>Replication-SID:</dt>

        <dd>The Segment Identifier of a Replication segment. This is an
        SR-MPLS label or an SRv6 SID <xref format="default"
        target="RFC8402"/>.</dd>

        <dt>Downstream nodes:</dt>

        <dd>Set of nodes in an SR domain to which a packet is
        replicated by the Replication segment.</dd>

        <dt>Replication state:</dt>

        <dd>See below.</dd>
      </dl>

      <t>The downstream nodes and Replication state (RS) of a Replication segment
      can change over time, depending on the network state and leaf nodes of a
      multipoint service that the segment is part of.</t>

      <t>The Replication-SID identifies the Replication segment in the
      forwarding plane. At a replication node, the Replication-SID operates on
      the RS of the Replication segment.</t>

      <t>RS is a list of Replication branches to the downstream
      nodes. In this document, each branch is abstracted to a &lt;downstream
      node, downstream Replication-SID&gt; tuple. &lt;downstream node&gt;
      represents the reachability from the replication node to the downstream
      node. In its simplest form, this <bcp14>MAY</bcp14> be specified as an
      interface or next-hop if the downstream node is adjacent to the
      replication node. The reachability may be specified in terms of a
      Flexible Algorithm path (including the default algorithm) <xref
      format="default" target="RFC9350"/> or specified by an SR-explicit path
      represented either by a SID list (of one or more SIDs) or by a Segment
      Routing Policy <xref format="default" target="RFC9256"/>. The downstream
      Replication-SID is the Replication-SID of the Replication segment at the
      downstream node.</t>

      <t>A packet is steered into a Replication segment at a replication node
      in two ways:</t>

      <ul spacing="normal">
        <li>When the active segment <xref format="default" target="RFC8402"/>
        is a locally instantiated Replication-SID.</li>

        <li>By the root of a multipoint service based on local configuration
        that is outside the scope of this document.</li>
      </ul>

      <t>In either case, the packet is replicated to each downstream node in
      the associated RS.</t>

      <t>If a downstream node is an egress (leaf) of the multipoint service,
      no further replication is needed. The leaf node's Replication segment
      has an indicator for the leaf role, and it does not have any RS (i.e., the list of Replication branches is empty). The Replication-SID at a leaf node <bcp14>MAY</bcp14> be used to identify the multipoint
      service. Notice that the segment on the leaf node is still referred to
      as a "Replication segment" for the purpose of generalization.</t>

      <t>A node can be a bud node (i.e., it is a replication node and a leaf
      node of a multipoint service <xref format="default"
      target="I-D.ietf-pim-sr-p2mp-policy"/>). The Replication segment of a
      bud node has a list of Replication branches as well as a leaf role
      indicator.</t>

      <t>In principle, it is possible for different Replication segments to
      replicate packets to the same Replication segment on a downstream node.
      However, such usage is intentionally left out of scope of this
      document.</t>

      <section numbered="true" toc="default">
        <name>SR-MPLS Data Plane</name>

        <t>When the active segment is a Replication-SID, the processing
        results in a POP <xref format="default" target="RFC8402"/> operation
        and the lookup of the associated RS. For each
        replication in the RS, the operation is a PUSH <xref
        format="default" target="RFC8402"/> of the downstream Replication-SID
        and an optional segment list onto the packet to steer the packet to
        the downstream node.</t>

        <t>The operation performed on the incoming Replication-SID is NEXT
        <xref format="default" target="RFC8402"/> at a leaf or bud node where
        delivery of payload off the tree is per local configuration. For some
        usages, this may involve looking at the next SID, for example, to get
        the necessary context.</t>

        <t>When the root of a multipoint service steers a packet to a
        Replication segment, it results in a replication to each downstream
        node in the associated RS. The operation is a PUSH of
        the Replication-SID and an optional segment list onto the packet,
        which is forwarded to the downstream node.</t>

        <t>The following applies to a Replication-SID in MPLS
        encapsulation:</t>


        <ul spacing="normal">
          <li>SIDs <bcp14>MAY</bcp14> be inserted before the downstream
          SR-MPLS Replication-SID in order to guide a packet from a
          non-adjacent SR node to a replication node.</li>

          <li>A replication node <bcp14>MAY</bcp14> replicate a packet to a
          non-adjacent downstream node using SIDs it inserts in the copy
          preceding the downstream Replication-SID. The downstream node may be
          a leaf node of the Replication segment, another replication node, or
          both in the case of a bud node.</li>

          <li>A replication node <bcp14>MAY</bcp14> use an Anycast-SID or a
          Border Gateway Protocol (BGP) PeerSet-SID in the segment list to
          send a replicated packet to one downstream replication node in a set of
          Anycast nodes. This occurs if and only if all nodes in the set have an
          identical Replication-SID and reach the same set of receivers.</li>

          <li>For some use cases, there <bcp14>MAY</bcp14> be SIDs after the
          Replication-SID in the segment list of a packet. These SIDs are used
          only by the leaf and bud nodes to forward a packet off the tree
          independent of the Replication-SID. Coordination regarding the
          absence or presence and value of context information for leaf and bud
          nodes is outside the scope of this document.</li>
        </ul>
      </section>

      <section anchor="SRv6" numbered="true" toc="default">
        <name>SRv6 Data Plane</name>

        <t>For SRv6 <xref format="default" target="RFC8986"/>, this document
        specifies "Endpoint with replication and/or decapsulate" behavior (End.Replicate for
        short) to replicate a packet and forward the replicas according to an
        RS.</t>

        <t>When processing a packet destined to a local Replication-SID, the
        packet is replicated according to the associated RS to
        downstream nodes and/or locally delivered off the tree when this is a
        leaf or bud node. For replication, the outer header is reused, and the
        downstream Replication-SID, from RS, is written into
        the outer IPv6 header Destination Address (DA). If required, an
        optional segment list may be used on some branches using H.Encaps.Red
        <xref format="default" target="RFC8986"/> (while some other branches
        may not need that). Note that this H.Encaps.Red is independent of the
        Replication segment: it is just used to steer the replicated packet on
        a traffic-engineered path to a downstream node. The penultimate
        segment in the encapsulating IPv6 header will execute the Ultimate
        Segment Decapsulation (USD) flavor <xref format="default"
        target="RFC8986"/> of End/End.X behavior and forward the inner
        (replicated) packet to the downstream node. If H.Encaps.Red is used to
        steer a replicated packet to a downstream node, the operator must
        ensure the MTU on path to the downstream node is sufficient to account
        for additional SRv6 encapsulation. This also applies when the
        Replication segment is for the root node, whose upstream node has
        placed the Replication-SID in the header.</t>

        <t>A local application on root (e.g., MVPN <xref format="default"
        target="RFC6513"/> or EVPN <xref format="default" target="RFC7432"/>)
        may also apply H.Encaps.Red and then steer the resulting traffic into
        the Replication segment. Again, note that H.Encaps.Red is independent
        of the Replication segment: it is the action of the application (e.g.
        MVPN or EVPN service). If the service is on a root node, then the two
        H.Encaps mentioned, one for the service and the other in the previous
        paragraph for replication to the downstream node,
        <bcp14>SHOULD</bcp14> be combined for optimization (to avoid extra
        IPv6 encapsulation).</t>

        <t>When processing a packet destined to a local Replication-SID, the
        IPv6 Hop Limit <bcp14>MUST</bcp14> be decremented and
        <bcp14>MUST</bcp14> be non-zero to replicate the packet. A root node
        that encapsulates a payload can set the IPv6 Hop Limit based on a
        local policy. This local policy <bcp14>SHOULD</bcp14> set the IPv6 Hop
        Limit so that a replicated packet can reach the furthest leaf node. A
        root node can also have a local policy to set the IPv6 Hop Limit from
        the payload. In this case, the IPv6 Hop Limit may not be sufficient to
        get the replicated packet to all the leaf nodes. Non-replication nodes
        (i.e., nodes that forward replicated packets based on the IPv6 locator
        unicast prefix) can decrement the IPv6 Hop Limit to zero and originate
        ICMPv6 error packets to the root node. This can result in a storm of
        ICMPv6 packets (see <xref format="default" target="ICMP"/>) to the
        root node. To avoid this, a Replication segment has an optional IPv6
        Hop Limit Threshold. If this threshold is set, a replication node
        <bcp14>MUST</bcp14> discard an incoming packet with a local
        Replication-SID if the IPv6 Hop Limit in the packet is less than the
        threshold and log this in a rate-limited manner. The IPv6 Hop Limit
        Threshold <bcp14>SHOULD</bcp14> be set so that an incoming packet can
        be replicated to the furthest leaf node.</t>

        <t>For leaf and bud nodes, local delivery off the tree is per Replication-SID or the next SID (if present in the SRH). For some usages, this may
        involve getting the necessary context either from the next SID (e.g.,
        MVPN with a shared tree) or from the Replication-SID itself (e.g.,
        MVPN with a non-shared tree). In both cases, the context association
        is achieved with signaling and is out of scope of this document.</t>

        <t>The following applies to a Replication-SID in SRv6
        encapsulation:</t>

        <ul spacing="normal">
          <li>There <bcp14>MAY</bcp14> be SIDs preceding the SRv6 Replication-SID in order to guide a packet from a non-adjacent SR node to a
          replication node via an explicit path.</li>

          <li>A replication node <bcp14>MAY</bcp14> steer a replicated packet
          on an explicit path to a non-adjacent downstream node using SIDs it
          inserts in the copy preceding the downstream Replication-SID. The
          downstream node may be a leaf node of the Replication segment,
          another replication node, or both in the case of a bud node.</li>

          <li>For SRv6, as described in above paragraphs, the insertion of
          SIDs prior to the Replication-SID entails a new IPv6 encapsulation
          with the SRH. However, this can be optimized on the root node or for
          compressed SRv6 SIDs.</li>

          <li>The locator of the Replication-SID is sufficient to guide a
          packet on the shortest path between non-adjacent nodes for default
          or Flexible Algorithms.</li>

          <li>A replication node <bcp14>MAY</bcp14> use an Anycast-SID or a
          BGP PeerSet-SID in the segment list to send a replicated packet to
          one downstream replication node in an Anycast set. This occurs if
          and only if all nodes in the set have an identical Replication-SID
          and reach the same set of receivers.</li>

          <li>There <bcp14>MAY</bcp14> be SIDs after the Replication-SID in
          the SRH of a packet. These SIDs are used to provide additional
          context for processing a packet locally at the node where the
          Replication-SID is the active segment. Coordination regarding the
          absence or presence and value of context information for leaf and bud
          nodes is outside the scope of this document.</li>
        </ul>

        <section numbered="true" toc="default">
          <name>End.Replicate: Replicate and/or Decapsulate</name>

          <t>The "Endpoint with replication and/or decapsulate"
          (End.Replicate for short) is a variant of End behavior. The
          pseudocode in this section follows the convention introduced in
          <xref format="default" target="RFC8986"/>.</t>

          <t>An RS conceptually contains the following
          elements:</t>

		            <sourcecode name="" type="pseudocode"><![CDATA[
Replication state:
{
  Node-Role: {Head, Transit, Leaf, Bud};
  IPv6 Hop Limit Threshold; # default is zero
  # On Leaf, replication list is zero length
  Replication-List:
  {
    downstream node: <Node-Identifier>;
    downstream Replication-SID: R-SID;
    # Segment-List may be empty
    Segment-List: [SID-1, .... SID-N];
  }
}
]]></sourcecode>


          <t>Below is the Replicate function on a packet for Replication state
          (RS).</t>


          <sourcecode name="" type="pseudocode"><![CDATA[
S01. Replicate(RS, packet)
S02. {
S03.    For each Replication R in RS.Replication-List {
S04.       Make a copy of the packet
S05.       Set IPv6 DA = RS.R-SID
S06.       If RS.Segment-List is not empty {
S07.         # Head node may optimize below encapsulation and 
S08.         # the encapsulation of packet in a single encapsulation
S09.         Execute H.Encaps or H.Encaps.Red with RS.Segment-List 
             on packet copy #RFC 8986, Sections 5.1 and 5.2
S10.       }
S11.       Submit the packet to the egress IPv6 FIB lookup and           
           transmission to the new destination
S12.   }
S13. }    
]]></sourcecode>

          <t>Notes:</t>

          <ul spacing="normal">
            <li>The IPv6 DA in the copy of a packet is set
            from the local state and not from the SRH.</li>
          </ul>

          <t>When N receives a packet whose IPv6 DA is S and S is a local
          End.Replicate SID, N does:</t>

 	  
		    <sourcecode name="" type="pseudocode"><![CDATA[
S01.   Lookup FUNCT portion of S to get Replication state (RS)
S02.   If (IPv6 Hop Limit <= 1) {
S03.     Discard the packet
S04.     # ICMPv6 Time Exceeded is not permitted
           (see Section 2.2.3)
S05.   }
S06.   If RS is not found {
S07.     Discard the packet
S08.   }
S09.   If (IPv6 Hop Limit < RS.IPv6 Hop Limit Threshold) {
S10.     Discard the packet
S11.     # Rate-limited logging
S12.   }
S13.   Decrement IPv6 Hop Limit by 1
S14.   If (IPv6 NH == SRH and SRH TLVs present) {
S15.     Process SRH TLVs if allowed by local configuration
S16.   }
S17.   Call Replicate(RS, packet)
S18.   If (RS.Node-Role == Leaf OR RS.Node-Role == bud) {
S19.     If (IPv6 NH == SRH and Segments Left > 0) {
S20.       Derive packet processing context (PPC) from Segment List
S21.       If (Segments Left != 0) {
S22.         Discard the packet
S23.         # ICMPv6 Parameter Problem message with Code 0
S24.         # (Erroneous header field encountered) 
S25.         # is not permitted (Section 2.2.3)
S26.       }
S27.     } Else {
S28.       Derive packet processing context (PPC) 
           from FUNCT of Replicatio-SID
S29.     }
S30.     Process the next header
S31.   }
]]></sourcecode>

          <t>The processing of the Upper-Layer header of a packet matching the
          End.Replicate SID at a leaf or bud node is as follows:</t>


          <sourcecode name="" type="pseudocode"><![CDATA[
S01.   If (Upper-Layer header type == 4(IPv4) OR 
           Upper-Layer header type == 41(IPv6) ) {
S02.     Remove the outer IPv6 header with all its extension headers
S03.     Process the packet in context of PPC
S04.   } Else If (Upper-Layer header type == 143(Ethernet) ) {
S05.     Remove the outer IPv6 header with all its extension headers
S06.     Process the Ethernet Frame in context of PPC
S07.   } Else If (Upper-Layer header type is allowed 
                  by local configuration) {
S08.     Proceed to process the Upper-Layer header
S09.   } Else {
S10.     Discard the packet
S11.     # ICMPv6 Parameter Problem message with Code 4
S12.     # (SR Upper-Layer header Error) 
S13.     # is not permitted (Section 2.2.3)
S14.   }
]]></sourcecode>
          <t>Notes:</t>

          <ul spacing="normal">
            <li>The behavior above <bcp14>MAY</bcp14> result in a packet with
            a partially processed segment list in the SRH under some
            circumstances. For example, a head node may encode a context-SID
            in an SRH. As per the pseudocode above, a replication node that
            receives a packet with a local Replication-SID will not process
            the SRH segment list and will just forward a copy with an
            unmodified SRH to downstream nodes.</li>

            <li>The packet processing context is usually a FIB table "T".</li>
          </ul>

          <t>If configured to process TLVs, processing the Replication-SID may
          modify the "variable-length data" of TLV types that change en route.
          Therefore, TLVs that change en route are mutable. The remainder of
          the SRH (Segments Left, Flags, Tag, Segment List, and TLVs that do
          not change en route) are immutable while processing this SID.</t>

          <section numbered="true" toc="default">
            <name>Hashed Message Authentication Code (HMAC) SRH TLV</name>

            <t>If a root node encodes a context-SID in an SRH with an optional
            HMAC SRH TLV <xref format="default" target="RFC8754"/>, it
            <bcp14>MUST</bcp14> set the 'D' bit as defined in <xref
            section="2.1.2" sectionFormat="of" target="RFC8754"/> because the
            Replication-SID is not part of the segment list in the SRH.</t>

            <t>HMAC generation and verification is as specified in <xref
            format="default" target="RFC8754"/>. Verification of an HMAC TLV
            is determined by local configuration. If verification fails, an
            implementation of a Replication-SID <bcp14>MUST NOT</bcp14>
            originate an ICMPv6 Parameter Problem message with code 0. The
            failure <bcp14>SHOULD</bcp14> be logged (rate-limited) and the
            packet <bcp14>SHOULD</bcp14> be discarded.</t>
          </section>
        </section>

        <section numbered="true" toc="default">
          <name>OAM Operations</name>

          <t><xref format="default" target="RFC9259"/> specifies procedures
          for Operations, Administration, and Maintenance (OAM) like ping and
          traceroute on SRv6 SIDs.</t>

          <t>Assuming the source node knows the Replication-SID a priori, it
          is possible to ping a Replication-SID of a leaf or bud node directly by
          putting it in the IPv6 DA without an SRH or in an
          SRH as the last segment. While it is not possible to ping a
          Replication-SID of a transit node because transit nodes do not
          process Upper-Layer headers, it is still possible to ping a
          Replication-SID of a leaf or bud node of a tree via the Replication-SID
          of intermediate transit nodes. The source of the ping
          <bcp14>MUST</bcp14> compute the ICMPv6 Echo Request checksum using
          the Replication-SID of the leaf or bud node as the DA. The
          source can then send the Echo Request packet to a transit node's
          Replication-SID. The transit node replicates the packet by replacing
          the IPv6 DA until the packet reaches the leaf or bud
          node, which responds with an ICMPv6 Echo Reply. Note that a transit
          replication node may replicate Echo Request packets to other
          leaf or bud nodes. These nodes will drop the Echo Request due to an
          incorrect checksum. Procedures to prevent the misdelivery of an Echo
          Request may be addressed in a future document. <xref
          format="default" target="A.2.1"/> illustrates examples of a ping to
          a Replication-SID.</t>

          <t>Traceroute to a leaf or bud node Replication-SID is not possible due
          to restrictions prohibiting the origination of the ICMPv6 Time
          Exceeded error message for a Replication-SID as described in <xref
          format="default" target="ICMP"/>.</t>
        </section>

        <section anchor="ICMP" numbered="true" toc="default">
          <name>ICMPv6 Error Messages</name>

          <t><xref section="2.4" sectionFormat="of" target="RFC4443"/> states
          an ICMPv6 error message <bcp14>MUST NOT</bcp14> be originated as a
          result of receiving a packet destined to an IPv6 multicast address.
          This is to prevent a source node from being overwhelmed by a storm of ICMPv6 error messages resulting from
          replicated IPv6 packets. There are
          two exceptions:</t>

          <ol>
            <li>The Packet Too Big message for Path MTU discovery, and</li>

            <li>The ICMPv6 Parameter Problem message with Code 2 reporting an
            unrecognized IPv6 option.</li>
          </ol>

          <t>An implementation of a Replication segment for SRv6
          <bcp14>MUST</bcp14> enforce these same restrictions and
          exceptions.</t>
        </section>
      </section>
    </section>

    <section anchor="IANA" numbered="true" toc="default">
      <name>IANA Considerations</name>

      <t>IANA has assigned the following codepoint for End.Replicate behavior
      in the "SRv6 Endpoint Behaviors" registry in the "Segment Routing"
      registry group.</t>

      <table align="center" anchor="endpoint_cp_types">
        <name>SRv6 Endpoint Behavior</name>

        <thead>
          <tr>
            <th align="left">Value</th>

            <th align="center">Hex</th>

            <th align="center">Endpoint Behavior</th>

            <th align="center">Reference</th>

            <th align="center">Change Controller</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td align="left">75</td>

            <td align="center">0x004B</td>

            <td align="center">End.Replicate</td>

            <td align="center">RFC 9524</td>

            <td align="center">IETF</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section anchor="Security" numbered="true" toc="default">
      <name>Security Considerations</name>

      <t>The SID behaviors defined in this document are deployed within an SR
      domain <xref format="default" target="RFC8402"/>. An SR domain needs
      protection from outside attackers (as described in <xref
      format="default" target="RFC8754"/>). The following is a brief reminder
      of the same:</t>


      <ul spacing="normal">
        <li>
          <t>For SR-MPLS deployments:</t>

          <ul spacing="normal">
            <li>Disable MPLS on external interfaces of each edge node or any
            other technique to filter labeled traffic ingress on these
            interfaces.</li>
          </ul>
        </li>

        <li>
          <t>For SRv6 deployments:</t>

          <ul spacing="normal">
            <li>Allocate all the SIDs from an IPv6 prefix block S/s and
            configure each external interface of each edge node of the domain
            with an inbound Infrastructure Access Control List (IACL) that drops any
            incoming packet with a DA in S/s.</li>

            <li>
              <t>Additionally, an IACL may be applied to all nodes (k)
              provisioning SIDs as defined in this specification:</t>

              <ul spacing="normal">
                <li>Assign all interface addresses from within IPv6 prefix
                A/a. At node k, all SIDs local to k are assigned from prefix
                Sk/sk. Configure each internal interface of each SR node k in
                the SR domain with an inbound IACL that drops any incoming
                packet with a DA in Sk/sk if the source
                address is not in A/a.</li>
              </ul>
            </li>

            <li>Deny traffic with spoofed source addresses by implementing
            recommendations in BCP 84 <xref format="default"
            target="RFC3704"/>.</li>

            <li>Additionally, the block S/s from which SIDs are allocated may
            be an address that is not globally routable such as a Unique Local
            Address (ULA) or the prefix defined in <xref format="default"
            target="I-D.ietf-6man-sids"/>.</li>
          </ul>
        </li>
      </ul>

      <t>Failure to protect the SR-MPLS domain by correctly provisioning MPLS
      support per interface permits attackers from outside the domain to send
      packets that use the replication services provisioned within the
      domain.</t>

      <t>Failure to protect the SRv6 domain with IACLs on external interfaces
      combined with failure to implement the recommendations of BCP 38 <xref
      format="default" target="RFC2827"/> or apply IACLs on nodes provisioning
      SIDs permits attackers from outside the SR domain to send packets that
      use the replication services provisioned within the domain.</t>

      <t>Given the definition of the Replication segment in this document, an
      attacker subverting the ingress filters above cannot take advantage of a
      stack of Replication segments to perform amplification attacks nor link
      exhaustion attacks. Replication segment trees always terminate at a leaf
      or bud node resulting in a decapsulation. However, this does allow an
      attacker to inject traffic to the receivers within a P2MP service.</t>

      <t>This document introduces an SR segment endpoint behavior that
      replicates and decapsulates an inner payload for both the MPLS and IPv6
      data planes. Similar to any MPLS end-of-stack label, or SRv6 END.D*
      behavior, if the protections described above are not implemented, an
      attacker can perform an attack via the decapsulating segment (including
      the one described in this document).</t>

      <t>Incorrect provisioning of Replication segments can result in a chain
      of Replication segments forming a loop. This can happen if Replication
      segments are provisioned on SR nodes without using a control plane. In
      this case, replicated packets can create a storm until MPLS TTL (for
      SR-MPLS) or IPv6 Hop Limit (for SRv6) decrements to zero. A control
      plane such as PCE can be used to prevent loops. The control plane
      protocols (like Path Computation Element Communication Protocol (PCEP),
      BGP, etc.) used to instantiate Replication segments can leverage their
      own security mechanisms such as encryption, authentication filtering,
      etc.</t>

      <t>For SRv6, <xref format="default" target="ICMP"/> describes an
      exception for the ICMPv6 Parameter Problem message with Code 2. If an attacker sends a packet destined to a Replication-SID
      with the source address of a node and with an extension header using the
      unknown option type marked as mandatory, then a large number of ICMPv6
      Parameter Problem messages can cause a denial-of-service attack on the
      source node. Although this document does not specify any extension
      headers, any future extension of this document that does so is
      susceptible to this security concern.</t>


      <t>If an attacker can forge an IPv6 packet with:</t>
	  
		<ul spacing="normal">
			<li>the source address of a node,</li>
			<li>a Replication-SID as the DA, and</li>
			<li>an IPv6 Hop Limit such that nodes that forward replicated packets on an IPv6 locator
      unicast prefix, decrement the Hop Limit to zero,</li>
		</ul>
 
	  <t>then these nodes can
      cause a storm of ICMPv6 error packets to overwhelm the source node under
      attack. The IPv6 Hop Limit Threshold check described in <xref
      format="default" target="SRv6"/> can help mitigate such attacks.</t>
    </section>
  </middle>

  <back>
    <displayreference target="I-D.ietf-pim-sr-p2mp-policy" to="P2MP-POLICY"/>

    <displayreference target="I-D.filsfils-spring-srv6-net-pgm-illustration"
                      to="PGM-ILLUSTRATION"/>

    <displayreference target="I-D.ietf-6man-sids" to="SIDS-SRv6"/>

    <references>
      <name>References</name>

      <references>
        <name>Normative References</name>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml"
		    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8986.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.4443.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9259.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>
      </references>

      <references>
        <name>Informative References</name>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.6513.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7432.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.7988.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.8660.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <reference anchor="I-D.ietf-pim-sr-p2mp-policy">
          <front>
            <title>Segment Routing Point-to-Multipoint Policy</title>
            <author fullname="Daniel Voyer" initials="D." role="editor"
                    surname="Voyer">
              <organization>Bell Canada</organization>
            </author>
            <author fullname="Clarence Filsfils" initials="C."
                    surname="Filsfils">
              <organization>Cisco Systems, Inc.</organization>
            </author>
            <author fullname="Rishabh Parekh" initials="R." surname="Parekh">
              <organization>Cisco Systems, Inc.</organization>
            </author>
            <author fullname="Hooman Bidgoli" initials="H." surname="Bidgoli">
              <organization>Nokia</organization>
            </author>
            <author fullname="Zhaohui (Jeffrey) Zhang" initials="Z. J."
                    surname="Zhang">
              <organization>Juniper Networks</organization>
            </author>
            <date day="11" month="October" year="2023"/>
          </front>
          <seriesInfo name="Internet-Draft" value="draft-ietf-pim-sr-p2mp-policy-07"/>
        </reference>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9350.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.9256.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <reference anchor="I-D.filsfils-spring-srv6-net-pgm-illustration">
          <front>
            <title>Illustrations for SRv6 Network Programming</title>
            <author fullname="Clarence Filsfils" initials="C."
                    surname="Filsfils">
              <organization>Cisco Systems, Inc.</organization>
            </author>
            <author fullname="Pablo Camarillo" initials="P." role="editor"
                    surname="Camarillo">
              <organization>Cisco Systems, Inc.</organization>
            </author>
            <author fullname="Zhenbin Li" initials="Z." surname="Li">
              <organization>Huawei Technologies</organization>
            </author>
            <author fullname="Satoru Matsushima" initials="S."
                    surname="Matsushima">
              <organization>SoftBank</organization>
            </author>
            <author fullname="Bruno Decraene" initials="B." surname="Decraene">
              <organization>Orange</organization>
            </author>
            <author fullname="Dirk Steinberg" initials="D."
                    surname="Steinberg">
              <organization>Lapishills Consulting Limited</organization>
            </author>
            <author fullname="David Lebrun" initials="D." surname="Lebrun">
              <organization>Google</organization>
            </author>
            <author fullname="Robert Raszuk" initials="R." surname="Raszuk">
              <organization>Bloomberg LP</organization>
            </author>
            <author fullname="John Leddy" initials="J." surname="Leddy">
              <organization>Individual Contributor</organization>
            </author>
            <date day="30" month="March" year="2021"/>
          </front>
          <seriesInfo name="Internet-Draft"
                      value="draft-filsfils-spring-srv6-net-pgm-illustration-04"/>
        </reference>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.3704.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <xi:include href="https://bib.ietf.org/public/rfc/bibxml/reference.RFC.2827.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>


        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-6man-sids.xml"
                    xmlns:xi="http://www.w3.org/2001/XInclude"/>
      </references>
    </references>

    <section anchor="Appendix" numbered="true" toc="default">
      <name>Illustration of a Replication Segment</name>

      <t>This section illustrates an example of a single Replication segment.
      Examples showing Replication segments stitched together to form a P2MP
      tree (based on SR P2MP policy) are in <xref format="default"
      target="I-D.ietf-pim-sr-p2mp-policy"/>.</t>

      <t>Consider the following topology:</t>

      <figure>
        <name>Topology for Illustration of a Replication Segment</name>

        <artwork align="left" alt="" name="" type=""><![CDATA[
                               R3------R6
                              /         \
                      R1----R2----R5-----R7
                              \         /
                               +--R4---+
]]></artwork>
      </figure>

      <section numbered="true" toc="default">
        <name>SR-MPLS</name>

        <t>In this example, the Node-SID of a node Rn is N-SIDn and the
        Adj-SID from node Rm to node Rn is A-SIDmn. The interface
        between Rm and Rn is Lmn. The state representation uses
        "R-SID-&gt;Lmn" to represent a packet replication with outgoing
        Replication-SID R-SID sent on interface Lmn.</t>

        <t>Assume a Replication segment identified with R-ID at Replication
        node R1 and downstream nodes R2, R6, and R7. The Replication-SID at
        node n is R-SIDn. A packet replicated from R1 to R7 has to traverse
        R4.</t>

        <t>The Replication segments at nodes R1, R2, R6, and R7 are shown
        below. Note nodes R3, R4, and R5 do not have a Replication
        segment.</t>

        <t>Replication segment at R1:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R1&gt;: Replication-SID: R-SID1 Replication state: R2:
        &lt;R-SID2-&gt;L12&gt; R6: &lt;N-SID6, R-SID6&gt; R7: &lt;N-SID4,
        A-SID47, R-SID7&gt;</sourcecode>

        <t>Replication to R2 steers the packet directly to R2 on interface
        L12. Replication to R6, using N-SID6, steers the packet via the
        shortest path to that node. Replication to R7 is steered via R4, using
        N-SID4 and then adjacency SID A-SID47 to R7.</t>

        <t>Replication segment at R2:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R2&gt;: Replication-SID: R-SID2 Replication state: R2:
        &lt;Leaf&gt;</sourcecode>

        <t>Replication segment at R6:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R6&gt;: Replication-SID: R-SID6 Replication state: R6:
        &lt;Leaf&gt;</sourcecode>

        <t>Replication segment at R7:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R7&gt;: Replication-SID: R-SID7 Replication state: R7:
        &lt;Leaf&gt;</sourcecode>

        <t>When a packet is steered into the Replication segment at R1:</t>

        <ul spacing="normal">
          <li>R1 performs the PUSH operation with just the &lt;R-SID2&gt;
          label for the replicated copy and sends it to R2 on interface L12,
          since R1 is directly connected to R2. R2, as leaf, performs the NEXT
          operation, pops the R-SID2 label, and delivers the payload.</li>

          <li>R1 performs the PUSH operation with the &lt;N-SID6, R-SID6&gt;
          label stack for the replicated copy to R6 and sends it to R2, which
          is the nexthop on the shortest path to R6. R2 performs the CONTINUE
          operation on N-SID6 and forwards it to R3. R3 is the penultimate hop
          for N-SID6; it performs penultimate hop popping, which corresponds
          to the NEXT operation. The packet is then sent to R6 with
          &lt;R-SID6&gt; in the label stack. R6, as leaf, performs the NEXT
          operation, pops the R-SID6 label, and delivers the payload.</li>

          <li>R1 performs the PUSH operation with the &lt;N-SID4, A-SID47,
          R-SID7&gt; label stack for the replicated copy to R7 and sends it to
          R2, which is the nexthop on the shortest path to R4. R2 is the
          penultimate hop for N-SID4; it performs penultimate hop popping,
          which corresponds to the NEXT operation. The packet is then sent to
          R4 with &lt;A-SID47, R-SID1&gt; in the label stack. R4 performs the
          NEXT operation, pops A-SID47, and delivers the packet to R7 with
          &lt;R-SID7&gt; in the label stack. R7, as leaf, performs the NEXT
          operation, pops the R-SID7 label, and delivers the payload.</li>
        </ul>
      </section>

      <section numbered="true" toc="default">
        <name>SRv6</name>

        <t>For SRv6, we use the SID allocation scheme, reproduced below, from
        "Illustrations for SRv6 Network Programming" <xref format="default"
        target="I-D.filsfils-spring-srv6-net-pgm-illustration"/>:</t>

        <ul spacing="normal">
          <li>2001:db8::/32 is an IPv6 block allocated by a Regional Internet
          Registry (RIR) to the operator.</li>

          <li>2001:db8:0::/48 is dedicated to the internal address space.</li>

          <li>2001:db8:cccc::/48 is dedicated to the internal SRv6 SID
          space.</li>

          <li>We assume a location expressed in 64 bits and a function
          expressed in 16 bits.</li>

          <li>Node k has a classic IPv6 loopback address 2001:db8::k/128,
          which is advertised in the Interior Gateway Protocol (IGP).</li>

          <li>Node k has 2001:db8:cccc:k::/64 for its local SID space. Its
          SIDs will be explicitly assigned from that block.</li>

          <li>Node k advertises 2001:db8:cccc:k::/64 in its IGP.</li>

          <li>Function :1:: (function 1, for short) represents the End
          function with the Penultimate Segment Pop (PSP) of the SRH <xref
          format="default" target="RFC8986"/> and USD support.</li>

          <li>Function :Cn:: (function Cn, for short) represents the End.X
          function from to Node n with PSP and USD support.</li>
        </ul>

        <t>Each node k has:</t>

        <ul spacing="normal">
          <li>An explicit SID instantiation 2001:db8:cccc:k:1::/128 bound to
          an End function with additional support for PSP and USD.</li>

          <li>An explicit SID instantiation 2001:db8:cccc:k:Cj::/128 bound to
          an End.X function to neighbor J with additional support for PSP and
          USD.</li>

          <li>An explicit SID instantiation 2001:db8:cccc:k:Fk::/128 bound to
          an End.Replicate function.</li>
        </ul>

        <t>Assume a Replication segment identified with R-ID at Replication
        node R1 and downstream nodes R2, R6, and R7. The Replication-SID at
        node k, bound to an End.Replicate function, is
        2001:db8:cccc:k:Fk::/128. A packet replicated from R1 to R7 has to
        traverse R4.</t>

        <t>The Replication segments at nodes R1, R2, R6, and R7 are shown
        below. Note nodes R3, R4, and R5 do not have a Replication
        segment. The state representation uses "R-SID-&gt;Lmn" to represent a
        packet replication with outgoing Replication-SID R-SID sent on
        interface Lmn. "SL" represents an optional segment list used to steer
        a replicated packet on a specific path to a downstream node.</t>

        <t>Replication segment at R1:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R1&gt;: Replication-SID: 2001:db8:cccc:1:F1::0 Replication
        state: R2: &lt;2001:db8:cccc:2:F2::0-&gt;L12&gt; R6:
        &lt;2001:db8:cccc:6:F6::0&gt; R7: &lt;2001:db8:cccc:4:C7::0&gt;, SL:
        &lt;2001:db8:cccc:7:F7::0&gt;</sourcecode>

        <t>Replication to R2 steers the packet directly to R2 on interface
        L12. Replication to R6, using 2001:db8:cccc:6:F6::0, steers the packet
        via the shortest path to that node. Replication to R7 is steered via
        R4, using H.Encaps.Red with End.X SID 2001:db8:cccc:4:C7::0 at R4 to
        R7.</t>

        <t>Replication segment at R2:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R2&gt;: Replication-SID: 2001:db8:cccc:2:F2::0 Replication
        state: R2: &lt;Leaf&gt;</sourcecode>

        <t>Replication segment at R6:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R6&gt;: Replication-SID: 2001:db8:cccc:6:F6::0 Replication
        state: R6: &lt;Leaf&gt;</sourcecode>

        <t>Replication segment at R7:</t>

        <sourcecode name="" type="pseudocode">Replication segment
        &lt;R-ID,R7&gt;: Replication-SID: 2001:db8:cccc:7:F7::0 Replication
        state: R7: &lt;Leaf&gt;</sourcecode>

        <t>When a packet, (A,B2), is steered into the Replication segment at
        R1:</t>

        <ul spacing="normal">
          <li>R1 creates an encapsulated replicated copy (2001:db8::1,
          2001:db8:cccc:2:F2::0) (A, B2), and sends it to R2 on interface L12,
          since R1 is directly connected to R2. R2, as leaf, removes the outer
          IPv6 header and delivers the payload.</li>

          <li>R1 creates an encapsulated replicated copy (2001:db8::1,
          2001:db8:cccc:6:F6::0) (A, B2) then forwards the resulting packet on
          the shortest path to 2001:db8:cccc:6::/64. R2 and R3 forward the
          packet using 2001:db8:cccc:6::/64. R6, as leaf, removes the outer
          IPv6 header and delivers the payload.</li>

          <li>
            <t>R1 has to steer the packet to downstream node R7 via node R4.
            It can do this in one of two ways:</t>

            <ul spacing="normal">
              <li>R1 creates an encapsulated replicated copy (2001:db8::1,
              2001:db8:cccc:7:F7::0) (A, B2) and then performs H.Encaps.Red
              using the SL to create the (2001:db8::1, 2001:db8:cccc:4:C7::0)
              (2001:db8::1, 2001:db8:cccc:7:F7::0) (A, B2) packet. It sends
              this packet to R2, which is the nexthop on the shortest path to
              2001:db8:cccc:4::/64. R2 forwards the packet to R4 using
              2001:db8:cccc:4::/64. R4 executes the End.X function on
              2001:db8:cccc:4:C7::0, performs a USD action, removes the outer
              IPv6 encapsulation, and sends the resulting packet (2001:db8::1,
              2001:db8:cccc:7:F7::0) (A, B2) to R7. R7, as leaf, removes the
              outer IPv6 header and delivers the payload.</li>

              <li>R1 is the root of the Replication segment. Therefore, it can
              combine above encapsulations to create an encapsulated
              replicated copy (2001:db8::1, 2001:db8:cccc:4:C7::0)
              (2001:db8:cccc:7:F7::0; SL=1) (A, B2) and sends it to R2, which
              is the nexthop on the shortest path to 2001:db8:cccc:4::/64. R2
              forwards the packet to R4 using 2001:db8:cccc:4::/64. R4
              executes the End.X function on 2001:db8:cccc:4:C7::0, performs a
              PSP action, removes the SRH, and sends the resulting packet
              (2001:db8::1, 2001:db8:cccc:7:F7::0) (A, B2) to R7. R7, as leaf,
              removes the outer IPv6 header and delivers the payload.</li>
            </ul>
          </li>
        </ul>

        <section anchor="A.2.1" numbered="true" toc="default">
          <name>Pinging a Replication-SID</name>

          <t>This section illustrates the ping of a Replication-SID.</t>

          <t>Node R1 pings the Replication-SID of node R6 directly by sending
          the following packet:</t>

          <ol spacing="normal" type="1">
            <li>R1 to R6: (2001:db8::1, 2001:db8:cccc:6:F6::0; NH=ICMPv6)
            (ICMPv6 Echo Request).</li>

            <li>Node R6 as a leaf processes the upper-layer ICMPv6 Echo
            Request and responds with an ICMPv6 Echo Reply.</li>
          </ol>

          <t>Node R1 pings the Replication-SID of R7 via R4 by sending the
          following packet with the SRH:</t>

          <ol spacing="normal" type="1">
            <li>R1 to R4: (2001:db8::1, 2001:db8:cccc:4:C7::0)
            (2001:db8:cccc:7:F7::0; SL=1; NH=ICMPV6) (ICMPv6 Echo
            Request).</li>

            <li>R4 to R7: (2001:db8::1, 2001:db8:cccc:7:F7::0; NH=ICMPv6)
            (ICMPv6 Echo Request).</li>

            <li>Node R7 as a leaf processes the upper-layer ICMPv6 Echo
            Request and responds with an ICMPv6 Echo Reply.</li>
          </ol>

          <t>Assume node R4 is a transit replication node with Replication-SID
          2001:db8:cccc:4:F4::0 replicating to R7. Node R1 pings the
          Replication-SID of R7 via the Replication-SID of R4 as follows:</t>

          <ol spacing="normal" type="1">
            <li>R1 to R4: (2001:db8::1, 2001:db8:cccc:4:F4::0; NH=ICMPv6)
            (ICMPv6 Echo Request).</li>

            <li>R4 replicates to R7 by replacing the IPv6 DA
            with the Replication-SID of R7 from its Replication state.</li>

            <li>R4 to R7: (2001:db8::1, 2001:db8:cccc:7:F7::0; NH=ICMPv6)
            (ICMPv6 Echo Request).</li>

            <li>Node R7 as a leaf processes the upper-layer ICMPv6 Echo
            Request and responds with an ICMPv6 Echo Reply.</li>
          </ol>
        </section>
      </section>
    </section>

    <section anchor="Acknowledgements" numbered="false" toc="default">
      <name>Acknowledgements</name>

      <t>The authors would like to acknowledge <contact
      fullname="Siva Sivabalan"/>, <contact fullname="Mike Koldychev"/>,
      <contact fullname="Vishnu Pavan Beeram"/>, <contact
      fullname="Alexander Vainshtein"/>, <contact
      fullname="Bruno Decraene"/>, <contact fullname="Thierry Couture"/>,
      <contact fullname="Joel Halpern"/>, <contact
      fullname="Ketan Talaulikar"/>, <contact fullname="Darren Dukes"/>
      and <contact fullname="Jingrong Xie"/> for their valuable inputs.</t>
    </section>

    <section numbered="false" toc="default">
      <name>Contributors</name>

      <contact fullname="Clayton Hassen">
        <organization>Bell Canada</organization>

        <address>
          <postal>
            <city>Vancouver</city>

            <country>Canada</country>
          </postal>

          <email>clayton.hassen@bell.ca</email>
        </address>
      </contact>

      <contact fullname="Kurtis Gillis">
        <organization>Bell Canada</organization>

        <address>
          <postal>
            <city>Halifax</city>

            <country>Canada</country>
          </postal>

          <email>kurtis.gillis@bell.ca</email>
        </address>
      </contact>

      <contact fullname="Arvind Venkateswaran">
        <organization>Cisco Systems, Inc.</organization>

        <address>
          <postal>
            <city>San Jose</city>

            <region>CA</region>

            <country>United States of America</country>
          </postal>

          <email>arvvenka@cisco.com</email>
        </address>
      </contact>

      <contact fullname="Zafar Ali">
        <organization>Cisco Systems, Inc.</organization>

        <address>
          <postal>
            <country>United States of America</country>
          </postal>

          <email>zali@cisco.com</email>
        </address>
      </contact>

      <contact fullname="Swadesh Agrawal">
        <organization>Cisco Systems, Inc.</organization>

        <address>
          <postal>
            <city>San Jose</city>

            <region>CA</region>

            <country>United States of America</country>
          </postal>

          <email>swaagraw@cisco.com</email>
        </address>
      </contact>

      <contact fullname="Jayant Kotalwar">
        <organization>Nokia</organization>

        <address>
          <postal>
            <city>Mountain View</city>

            <region>CA</region>

            <country>United States of America</country>
          </postal>

          <email>jayant.kotalwar@nokia.com</email>
        </address>
      </contact>

      <contact fullname="Tanmoy Kundu">
        <organization>Nokia</organization>

        <address>
          <postal>
            <city>Mountain View</city>

            <region>CA</region>

            <country>United States of America</country>
          </postal>

          <email>tanmoy.kundu@nokia.com</email>
        </address>
      </contact>

      <contact fullname="Andrew Stone">
        <organization>Nokia</organization>

        <address>
          <postal>
            <city>Ottawa</city>

            <country>Canada</country>
          </postal>

          <email>andrew.stone@nokia.com</email>
        </address>
      </contact>

      <contact fullname="Tarek Saad">
        <organization>Cisco Systems, Inc.</organization>

        <address>
          <postal>
            <country>Canada</country>
          </postal>

          <email>tsaad@cisco.com</email>
        </address>
      </contact>

      <contact fullname="Kamran Raza">
        <organization>Cisco Systems, Inc.</organization>

        <address>
          <postal>
            <country>Canada</country>
          </postal>

          <email>skraza@cisco.com</email>
        </address>
      </contact>

      <contact fullname="Jingrong Xie">
        <organization>Huawei Technologies</organization>

        <address>
          <postal>
            <city>Beijing</city>

            <country>China</country>
          </postal>

          <email>xiejingrong@huawei.com</email>
        </address>
      </contact>
    </section>
  </back>
</rfc>
