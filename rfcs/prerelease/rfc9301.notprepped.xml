<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE rfc [
 <!ENTITY nbsp    "&#160;">
 <!ENTITY zwsp   "&#8203;">
 <!ENTITY nbhy   "&#8209;">
 <!ENTITY wj     "&#8288;">
]> 

<rfc xmlns:xi="http://www.w3.org/2001/XInclude" ipr="trust200902" docName="draft-ietf-lisp-rfc6833bis-31" number="9301" obsoletes="6830, 6833" updates="" submissionType="IETF" category="std" consensus="true" xml:lang="en" tocInclude="true" symRefs="true" sortRefs="true" version="3">

  <!-- xml2rfc v2v3 conversion 3.6.0 -->
<front>
    <title abbrev="LISP Control Plane">Locator/ID Separation Protocol (LISP) Control Plane</title>
    <seriesInfo name="RFC" value="9301"/>
    <author initials="D" surname="Farinacci" fullname="Dino Farinacci">
      <organization>lispers.net</organization>
      <address>
	<postal>
	  <city>San Jose</city>
	  <region>CA</region>
	  <country>United States of America</country>
	</postal>
        <email>farinacci@gmail.com</email>
      </address>
    </author>
    <author initials="F" surname="Maino" fullname="Fabio Maino">
      <organization>Cisco Systems</organization>
      <address>
	<postal>
	  <city>San Jose</city>
	  <region>CA</region>
	  <country>United States of America</country>
	</postal>
        <email>fmaino@cisco.com</email>
      </address>
    </author>
    <author initials="V" surname="Fuller" fullname="Vince Fuller">
      <organization>vaf.net Internet Consulting</organization>
      <address>
        <email>vince.fuller@gmail.com</email>
      </address>
    </author>
    <author initials="A" surname="Cabellos" fullname="Albert Cabellos" role="editor">
      <organization>Universitat Politecnica de Catalunya</organization>
      <address>
        <postal>
	  <street>c/ Jordi Girona s/n</street>
          <city>Barcelona</city>
          <country>Spain</country>
	  <code>08034</code>
        </postal>
        <email>acabello@ac.upc.edu</email>
      </address>
    </author>
    <date year="2022" month="October"/>
    <abstract>
      <t> This document describes the control plane and Mapping Service
    for the Locator/ID Separation Protocol (LISP), implemented by two
    types of LISP-speaking devices -- the LISP Map-Resolver and
    LISP Map-Server -- that provide a simplified "front end" for one
    or more Endpoint IDs (EIDs) to Routing Locator mapping databases.</t>
      <t>By using this control plane service interface and communicating
    with Map-Resolvers and Map-Servers, LISP Ingress Tunnel Routers
    (ITRs) and Egress Tunnel Routers (ETRs) are not dependent on the
    details of mapping database systems; this behavior facilitates modularity
    with different database designs.  Since these devices implement the "edge" of the
    LISP control plane infrastructure, connecting EID addressable nodes
    of a LISP site, the implementation and operational complexity of the
      overall cost and effort of deploying LISP is reduced.</t>
      <t>This document obsoletes RFCs 6830 and 6833.</t>
    </abstract>
  </front>
  <middle>
    <section numbered="true" toc="default">
      <name>Introduction</name>
      <t>The Locator/ID Separation Protocol <xref target="RFC9300" format="default"/> (see also <xref target="RFC9299" format="default"/>) specifies an architecture
    and mechanism for dynamic tunneling by logically separating the
    addresses currently used by IP in two separate namespaces:
    Endpoint IDs (EIDs), used within sites; and Routing Locators
    (RLOCs), used on the transit networks that make up the Internet
    infrastructure. To achieve this separation, LISP defines protocol
    mechanisms for mapping from EIDs to RLOCs. In addition, LISP
    assumes the existence of a database to store and propagate those
    mappings across Mapping System nodes. Several such databases have
    been proposed; among them are the Content distribution Overlay
    Network Service for LISP-NERD (a Not-so-novel EID-to-RLOC
    Database) <xref target="RFC6837" format="default"/>, LISP Alternative Logical
    Topology (LISP-ALT) <xref target="RFC6836" format="default"/>, and LISP Delegated
    Database Tree (LISP-DDT) <xref target="RFC8111" format="default"/>.</t>
      <t> The LISP Mapping Service defines two types of
    LISP-speaking devices: the Map-Resolver, which accepts
    Map-Requests from an Ingress Tunnel Router (ITR) and "resolves"
    the EID-to-RLOC mapping using a mapping database; and the
    Map-Server, which learns authoritative EID-to-RLOC mappings from
    an Egress Tunnel Router (ETR) and publishes them in a
    database.</t>
      <t> This LISP control plane and Mapping Service can be used by many
    different encapsulation-based or translation-based data planes, including
    but not limited to those defined in LISP
    <xref target="RFC9300" format="default"/>, the LISP Generic Protocol Extension (LISP-GPE) <xref target="RFC9305" format="default"/>, Virtual eXtensible Local Area Networks (VXLANs) <xref target="RFC7348" format="default"/>,
    VXLAN-GPE <xref target="NVO3-VXLAN-GPE" format="default"/>,
    GRE <xref target="RFC2890" format="default"/>, the GPRS Tunneling Protocol (GTP) <xref target="GTP-3GPP" format="default"/>,
    Identifier-Locator Addressing (ILA) <xref target="I-D.herbert-intarea-ila" format="default"/>, and Segment Routing (SRv6)
    <xref target="RFC8402" format="default"/>.</t>
      <t> Conceptually, LISP Map-Servers share some of the same basic
    configuration and maintenance properties as Domain Name System
    (DNS) servers <xref target="RFC1035" format="default"/>; likewise, Map-Resolvers
    are conceptually similar to DNS caching resolvers. With this in
    mind, this specification borrows familiar terminology (resolver
    and server) from the DNS specifications.</t>
      <t> Note that this document doesn't assume any particular database
    mapping infrastructure to illustrate certain aspects of Map-Server
    and Map-Resolver operations. The Mapping Service interface can (and
    likely will) be used by ITRs and ETRs to access other mapping
    database systems as the LISP infrastructure evolves.</t>
      <t>LISP is not intended to address problems of connectivity and
    scaling on behalf of arbitrary communicating parties.  Relevant
    situations are described in 
<xref target="RFC9300" sectionFormat="of" section="1.1"/>.</t>
      <t>This document obsoletes <xref target="RFC6830" format="default"/> and <xref target="RFC6833" format="default"/>.</t>
      <section anchor="soa" numbered="true" toc="default">
        <name>Scope of Applicability</name>
        <t>LISP was originally developed to address the Internet-wide
      route scaling problem <xref target="RFC4984" format="default"/>.  While there
      are a number of approaches of interest for that problem, as LISP
      has been developed and refined, a large number of other uses for LISP have
      been found and are being implemented.  As such, the design and
      development of LISP have changed so as to focus on these use
      cases.  The common property of these uses is a large set of
      cooperating entities seeking to communicate over the public
      Internet or other large underlay IP infrastructures while
      keeping the addressing and topology of the cooperating entities
      separate from the underlay and Internet topology, routing, and
      addressing.</t>
        <t>When communicating over the public Internet, deployers <bcp14>MUST</bcp14> consider
        the following guidelines:</t>
        <ol spacing="normal" type="1">
	  <li>LISP Security (LISP-SEC) <bcp14>MUST</bcp14> be implemented <xref target="RFC9303" format="default"/>. This means that the S-bit <bcp14>MUST</bcp14> be set in the Map-Reply (<xref target="MR-FORMAT" format="default"/>), Map-Register (<xref target="MAPREG" format="default"/>), and Encapsulated Control Messages (ECMs) (<xref target="encap-mr" format="default"/>).</li>
          <li>Implementations <bcp14>SHOULD</bcp14> use 'HMAC-SHA256-128+HKDF-SHA256'
          as the Algorithm ID (<xref target="KEYS" format="default"/>)
          in the Map-Register message (<xref target="MAPREG" format="default"/>) and <bcp14>MUST NOT</bcp14> use 'None' or 'HMAC-SHA-1-96-None' as the Algorithm ID (<xref target="KEYS" format="default"/>) in the Map-Register message (<xref target="MAPREG" format="default"/>).</li>
        </ol>
      </section>
    </section>
    <section numbered="true" toc="default">
      <name>Requirements Notation</name>
        <t>
    The key words "<bcp14>MUST</bcp14>", "<bcp14>MUST NOT</bcp14>", "<bcp14>REQUIRED</bcp14>", "<bcp14>SHALL</bcp14>", "<bcp14>SHALL
    NOT</bcp14>", "<bcp14>SHOULD</bcp14>", "<bcp14>SHOULD NOT</bcp14>", "<bcp14>RECOMMENDED</bcp14>", "<bcp14>NOT RECOMMENDED</bcp14>",
    "<bcp14>MAY</bcp14>", and "<bcp14>OPTIONAL</bcp14>" in this document are to be interpreted as
    described in BCP&nbsp;14 <xref target="RFC2119"/> <xref target="RFC8174"/> 
    when, and only when, they appear in all capitals, as shown here.
        </t>
    </section>
    <section numbered="true" toc="default">
      <name>Definitions of Terms</name>
      <dl newline="false" spacing="normal">
        <dt>Map-Server: </dt>
        <dd>A network infrastructure component
      that learns of EID-Prefix mapping entries from an ETR, via the
      registration mechanism described below, or some other
      authoritative source if one exists. A Map-Server publishes these
      EID-Prefixes in a mapping database.</dd>
        <dt>Map-Request: </dt>
        <dd>A control plane message that queries the Mapping System to resolve an
      EID.  A LISP Map-Request can also be sent to an RLOC to test for
      reachability and to exchange security keys between an
      encapsulator and a decapsulator. This type of Map-Request is
      also known as an RLOC-Probe Request.</dd>
        <dt>Map-Reply: </dt>
        <dd>A control plane
      message returned in response to a Map-Request sent to the Mapping
      System when resolving an EID. A LISP Map-Reply can also be returned by
      a decapsulator in response to a Map-Request sent by an encapsulator
      to test for reachability. This type of Map-Reply is known as an RLOC-Probe
      Reply.</dd>
        <dt>Encapsulated Map-Request: </dt>
        <dd>A LISP Map-Request
      carried within an ECM. This Map-Request has an
      additional LISP header prepended. Sent to UDP destination port
      4342. The "outer" addresses are routable IP addresses,
      also known as RLOCs.  Used by an ITR when sending to a
      Map-Resolver and by a Map-Server when forwarding a Map-Request
      to an ETR.</dd>
        <dt>Map-Resolver: </dt>
        <dd>A network infrastructure component
      that accepts LISP Encapsulated (ECM) Map-Requests, typically from an
      ITR, and determines whether or not the destination IP address is
      part of the EID namespace; if it is not, a Negative Map-Reply is
      returned.  Otherwise, the Map-Resolver finds the appropriate
      EID-to-RLOC mapping by consulting a mapping database system.</dd>
        <dt>Negative Map-Reply: </dt>
        <dd>A LISP Map-Reply that
      contains an empty Locator-Set.  Returned in response to a
      Map-Request if the destination EID is not registered in the
      Mapping System, is policy-denied, or fails authentication.</dd>
        <dt>Map-Register message: </dt>
        <dd>A LISP message sent by an
      ETR to a Map-Server to register its associated EID-Prefixes. In
      addition to the set of EID-Prefixes to register, the message
      includes one or more RLOCs to reach ETR(s). The Map-Server uses
      these RLOCs when forwarding Map-Requests (reformatted as
      Encapsulated Map-Requests).  An ETR <bcp14>MAY</bcp14> request that the
      Map-Server answer Map-Requests on its behalf by setting the
      "proxy Map-Reply" flag (P-bit) in the message.</dd>
        <dt>Map-Notify message: </dt>
        <dd>A LISP message sent by a
      Map-Server to an ETR to confirm that a Map-Register has been
      received and processed. An ETR requests that a Map-Notify be
      returned by setting the "want-map-notify" flag (M-bit) in the
      Map-Register message. Unlike a Map-Reply, a Map-Notify uses UDP
      port 4342 for both source and destination. Map-Notify messages
      are also sent to ITRs by Map-Servers when there are RLOC-Set
      changes.</dd>
      </dl>
      <t>For definitions of other terms, notably Ingress Tunnel
    Router (ITR), Egress Tunnel Router (ETR), and Re-encapsulating
    Tunnel Router (RTR), refer to the LISP data plane specification
    <xref target="RFC9300" format="default"/>.</t>
    </section>
    <section anchor="OVERVIEW" numbered="true" toc="default">
      <name>Basic Overview</name>
      <t> A Map-Server is a device that publishes EID-Prefixes in a LISP
    mapping database on behalf of a set of ETRs. When it receives a
    Map-Request (typically originating from an ITR), it consults the mapping
    database to find an ETR that can answer with the set of RLOCs for
    an EID-Prefix. To publish its EID-Prefixes, an ETR periodically
    sends Map-Register messages to the Map-Server. A Map-Register
    message contains a list of EID-Prefixes plus a set of RLOCs that
    can be used to reach the ETRs.</t>
      <t> When LISP-ALT <xref target="RFC6836" format="default"/> is used as the mapping
    database, a Map-Server connects to the ALT network and acts as a
    "last-hop" ALT-Router.  Intermediate ALT-Routers forward
    Map-Requests to the Map-Server that advertises a particular
    EID-Prefix, and the Map-Server forwards them to the owning ETR,
    which responds with Map-Reply messages.</t>
      <t> When LISP-DDT <xref target="RFC8111" format="default"/> is used as
    the mapping database, a Map-Server sends the final Map-Referral
    messages from the Delegated Database Tree.</t>
      <t> A Map-Resolver receives Encapsulated Map-Requests from its
    client ITRs and uses a mapping database system to find the
    appropriate ETR to answer those requests. On a LISP-ALT network, a
    Map-Resolver acts as a "first-hop" ALT-Router.  It has Generic
    Routing Encapsulation (GRE) tunnels configured to other
    ALT-Routers and uses BGP to learn paths to ETRs for different
    prefixes in the LISP-ALT database. The Map-Resolver uses this path
    information to forward Map-Requests over the ALT to the correct
    ETRs.  On a LISP-DDT network <xref target="RFC8111" format="default"/>, a
    Map-Resolver maintains a referral cache and acts as a "first-hop"
    DDT node. The Map-Resolver uses the referral information to
    forward Map-Requests.</t>
      <t> Note that while it is conceivable that a Map-Resolver could
    cache responses to improve performance, issues surrounding cache
    management would need to be resolved so that doing so would be
    reliable and practical. In this specification, Map-Resolvers will
    operate only in a non-caching mode, decapsulating and forwarding
    Encapsulated Map-Requests received from ITRs.  Any specification
    of caching functionality is out of scope for this document.</t>
      <t> Note that a single device can implement the functions of both
    a Map-Server and a Map-Resolver, and in many cases, the functions
    will be co-located in that way. Also, there can be ALT-only nodes
    and DDT-only nodes, when LISP-ALT and LISP-DDT are used,
    respectively, connecting Map-Resolvers and Map-Servers together to
    make up the Mapping System.</t>
    </section>
    <section anchor="lispcp" numbered="true" toc="default">
      <name>LISP IPv4 and IPv6 Control Plane Packet Formats</name>
      <t>The following UDP packet formats are used by the LISP
      control plane.</t>
      <figure>
        <name>IPv4 UDP LISP Control Message</name>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Version|  IHL  |Type of Service|          Total Length         |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         Identification        |Flags|      Fragment Offset    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |  Time to Live | Protocol = 17 |         Header Checksum       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                    Source Routing Locator                     |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                 Destination Routing Locator                   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  / |           Source Port         |         Dest Port             |
UDP +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  \ |           UDP Length          |        UDP Checksum           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    |                         LISP Message                          |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
      </figure>
      <figure>
        <name>IPv6 UDP LISP Control Message</name>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Version| Traffic Class |           Flow Label                  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         Payload Length        | Next Header=17|   Hop Limit   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    +                                                               +
    |                                                               |
    +                     Source Routing Locator                    +
    |                                                               |
    +                                                               +
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    +                                                               +
    |                                                               |
    +                  Destination Routing Locator                  +
    |                                                               |
    +                                                               +
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  / |           Source Port         |         Dest Port             |
UDP +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  \ |           UDP Length          |        UDP Checksum           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    |                         LISP Message                          |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
      </figure>
      <t>When a UDP Map-Request, Map-Register, or 
      Map-Notify (when used
    as a notification message) is sent, the UDP source port is chosen
    by the sender and the destination UDP port number is set to
    4342. When a UDP Map-Reply, Map-Notify (when used as an
    acknowledgment to a Map-Register), or Map-Notify-Ack is sent,
    the source UDP port number is set to 4342 and the destination UDP
    port number is copied from the source port of either the
    Map-Request or the invoking data packet. Implementations <bcp14>MUST</bcp14> be
    prepared to accept packets when either the source port or
    destination UDP port is set to 4342 due to NATs changing port
    number values.</t>
      <t>The 'UDP Length' field will reflect the length of the UDP
	header and the LISP Message payload. LISP is expected to be deployed
	by cooperating entities communicating over underlays. Deployers are
	expected to set the MTU according to the specific deployment guidelines
	to prevent fragmentation of either the inner packet or the outer
  encapsulated packet. For deployments not aware of the underlay
	restrictions on the path MTU, the message size <bcp14>MUST</bcp14> be limited to 576 bytes
	for IPv4 or 1280 bytes for IPv6 -- considering the entire IP packet -- as outlined in <xref target="RFC8085" format="default"/>.</t>
      <t>The UDP checksum is computed and set to non-zero for all
    messages sent to or from port 4342.  It <bcp14>MUST</bcp14> be checked on
    receipt, and if the checksum fails, the control message <bcp14>MUST</bcp14> be
    dropped <xref target="RFC1071" format="default"/>.</t>
      <t>The format of control messages includes the UDP header so the
    checksum and length fields can be used to protect and delimit
    message boundaries.</t>
      <section numbered="true" toc="default">
        <name>LISP Control Packet Type Allocations</name>
        <t>This section defines the LISP control message formats and
      summarizes for IANA the LISP Type codes assigned by this
      document. For completeness, the summary below includes the LISP
      Shared Extension Message assigned by <xref target="RFC9304" format="default"/>.  Message type definitions
      are:</t>
<table align="center">
  <thead>
    <tr>
      <th>Message</th>
      <th>Code</th>
      <th>Codepoint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Reserved</td>
      <td>0</td>
      <td>b'0000'</td>
    </tr>
    <tr> 
      <td>LISP Map-Request</td>
      <td>1</td>
      <td>b'0001'</td>
    </tr>
    <tr>
      <td>LISP Map-Reply</td>
      <td>2</td>
      <td>b'0010'</td>
    </tr>
    <tr>
      <td>LISP Map-Register</td>
      <td>3</td>
      <td>b'0011'</td>
    </tr>
    <tr>
      <td>LISP Map-Notify</td>
      <td>4</td>
      <td>b'0100'</td>
    </tr>
    <tr>
      <td>LISP Map-Notify-Ack</td>
      <td>5</td>
      <td>b'0101'</td>
    </tr>
    <tr>
      <td>LISP DDT Map-Referral</td>
      <td>6</td>
      <td>b'0110'</td>
    </tr>
    <tr>
      <td>Unassigned</td>
      <td>7</td>
      <td>b'0111'</td>
    </tr>
    <tr>
      <td>LISP Encapsulated Control Message</td> 
      <td>8</td>
      <td>b'1000'</td>
    </tr>
    <tr>
      <td>Unassigned</td>
      <td>9-14</td>
      <td>b'1001'- b'1110'</td>
    </tr>
    <tr>
      <td>LISP Shared Extension Message</td>
      <td>15</td>
      <td>b'1111'</td>
    </tr>
  </tbody>
</table>
        <t>Protocol designers experimenting with new message formats are
      recommended to use the LISP Shared Extension Message Type described
      in <xref target="RFC9304" format="default"/>.</t>
        <t>All LISP control plane messages use Address Family
      Identifiers (AFIs) <xref target="AFN" format="default"/> or LISP Canonical Address
      Format (LCAF) entries <xref target="RFC8060" format="default"/> to encode either
      fixed-length or variable-length addresses. This includes explicit
      fields in each control message or part of EID-Records or
      RLOC-Records in commonly formatted messages. LISP control plane
      messages that include an unrecognized AFI <bcp14>MUST</bcp14> be
      dropped, and the event <bcp14>MUST</bcp14> be logged.</t>
        <t>The LISP control plane describes how other data planes can
      encode messages to support the soliciting of Map-Requests as well as
      RLOC-Probing procedures.</t>
      </section>
      <section anchor="NONCE" numbered="true" toc="default">
        <name>Map-Request Message Format</name>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Type=1 |A|M|P|S|p|s|R|R|  Rsvd   |L|D|   IRC   | Record Count  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         Nonce . . .                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         . . . Nonce                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         Source-EID-AFI        |   Source EID Address  ...     |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         ITR-RLOC-AFI 1        |    ITR-RLOC Address 1  ...    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                              ...                              |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         ITR-RLOC-AFI n        |    ITR-RLOC Address n  ...    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  / |   Reserved    | EID mask-len  |        EID-Prefix-AFI         |
Rec +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  \ |                       EID-Prefix  ...                         |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                   Map-Reply Record  ...                       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <t>Packet field descriptions:</t>
        <dl newline="false" spacing="normal">
          <dt>Type: </dt>
          <dd>1 (Map-Request)</dd>
          <dt>A:</dt>
          <dd>This is an authoritative bit. It is set to 1
        when an ITR wants the destination site to return the Map-Reply
        rather than the mapping database system returning a Map-Reply and
        is set to 0 otherwise.</dd>
          <dt>M:</dt>
          <dd>This is the map-data-present bit.  When set,
        it indicates that a Map-Reply Record segment is included in
        the Map-Request.</dd>
          <dt>P:</dt>
          <dd>This is the probe-bit, which indicates that a
        Map-Request <bcp14>MUST</bcp14> be treated as a Locator reachability
        probe. The receiver <bcp14>MUST</bcp14> respond with a Map-Reply with the
        probe-bit set, indicating that the Map-Reply is a Locator
        reachability probe reply, with the nonce copied from the
        Map-Request. See
        "<xref target="rloc-probe" format="title"/>" (<xref target="rloc-probe" format="default"/>) for
        more details. This RLOC-Probe Map-Request <bcp14>MUST NOT</bcp14> be sent to
        the Mapping System. If a Map-Resolver or Map-Server receives a
        Map-Request with the probe-bit set, it <bcp14>MUST</bcp14> drop the message.</dd>
          <dt>S:</dt>
          <dd> This is the Solicit-Map-Request (SMR)
        bit. See "<xref target="SMR" format="title"/>" (<xref target="SMR" format="default"/>) for
        details.</dd>
          <dt>p:</dt>
          <dd> This is the Proxy Ingress Tunnel Router (PITR) bit. This bit is set to 1
        when a PITR sends a Map-Request. The use of this bit is deployment specific.</dd>
          <dt>s:</dt>
          <dd> This is the SMR-invoked bit. This bit is set
        to 1 when an xTR is sending a Map-Request in response to a
        received SMR-based Map-Request.</dd>
          <dt>R:</dt>
          <dd>This reserved and unassigned bit <bcp14>MUST</bcp14> be set to 0 on
        transmit and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
          <dt>Rsvd:</dt>
          <dd>This field <bcp14>MUST</bcp14> be set to 0 on transmit
        and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
          <dt>L:</dt>
          <dd> This is the local-xtr bit. It is used by an
        xTR in a LISP site to tell other xTRs in the same site that it
        is part of the RLOC-Set for the LISP site. The L-bit is set to
        1 when the RLOC is the sender's IP address.</dd>
          <dt>D:</dt>
          <dd> This is the dont-map-reply bit. It is used
        in the SMR procedure described in <xref target="SMR" format="default"/>. When
        an xTR sends an SMR message, it doesn't need a
        Map-Reply returned. When this bit is set, the receiver of the
        Map-Request does not return a Map-Reply.</dd>
          <dt>IRC:</dt>
          <dd> This 5-bit field is the ITR-RLOC Count,
        which encodes the additional number of ('ITR-RLOC-AFI',
        'ITR-RLOC Address') fields present in this message.  At least
        one (ITR-RLOC-AFI, ITR-RLOC Address) pair <bcp14>MUST</bcp14> be encoded.
        Multiple 'ITR-RLOC Address' fields are used, so a Map-Replier
        can select which destination address to use for a
        Map-Reply. The IRC value ranges from 0 to 31. For a value of
        0, there is 1 ITR-RLOC address encoded; for a value of 1,
        there are 2 ITR-RLOC addresses encoded, and so on up to 31,
        which encodes a total of 32 ITR-RLOC addresses.</dd>
          <dt>Record Count:</dt>
          <dd> This is the number of records in
        this Map-Request message.  A record is comprised of the
        portion of the packet that is labeled 'Rec' above and occurs
        the number of times equal to Record Count. For this version of
        the protocol, a receiver <bcp14>MUST</bcp14> accept and process Map-Requests
        that contain one or more records, but a sender <bcp14>MUST</bcp14> only send
        Map-Requests containing one record.</dd>
          <dt>Nonce:</dt>
          <dd> This is an 8-octet random value created
        by the sender of the Map-Request.  This nonce will be returned
        in the Map-Reply. The nonce is used as an index to identify
        the corresponding Map-Request when a Map-Reply message is received.
        The nonce <bcp14>MUST</bcp14> be generated by a
        properly seeded pseudo-random source; for example, see
        <xref target="RFC4086" format="default"/>.</dd>
          <dt>Source-EID-AFI:</dt>
          <dd> This is the address family of
        the 'Source EID Address' field.</dd>
          <dt>Source EID Address:</dt>
          <dd> This is the EID of the
        source host that originated the packet that caused the
        Map-Request. When Map-Requests are used for refreshing a
        Map-Cache entry or for RLOC-Probing, an AFI value of 0 is used,
        and this field is of zero length.</dd>
          <dt>ITR-RLOC-AFI:</dt>
          <dd> This is the address family of the
        'ITR-RLOC Address' field that follows this field.</dd>
          <dt>ITR-RLOC Address:</dt>
          <dd> This is used to give the ETR
        the option of selecting the destination address from any
        address family for the Map-Reply message. This address <bcp14>MUST</bcp14> be
        a routable RLOC address of the sender of the Map-Request
        message.</dd>
          <dt>EID mask-len:</dt>
          <dd> This is the mask length for the
        EID-Prefix.</dd>
          <dt>EID-Prefix-AFI:</dt>
          <dd> This is the address family of
        the EID-Prefix according to <xref target="AFN" format="default"/> and <xref target="RFC8060" format="default"/>.</dd>
          <dt>EID-Prefix:</dt>
          <dd> This prefix address length is 4
        octets for an IPv4 address family and 16 octets for an IPv6
        address family when the EID-Prefix-AFI is 1 or 2,
        respectively. For other AFIs <xref target="AFN" format="default"/>, the address
        length varies, and for the LCAF AFI, the format is defined in
        <xref target="RFC8060" format="default"/>.  When a Map-Request is sent by an
        ITR because a data packet is received for a destination where
        there is no mapping entry, the EID-Prefix is set to the
        destination IP address of the data packet, and the 'EID
        mask-len' field is set to 32 or 128 for IPv4 or IPv6,
        respectively. When an xTR wants to query a site about the
        status of a mapping it already has cached, the EID-Prefix used
        in the Map-Request has the same mask length as the EID-Prefix
        returned from the site when it sent a Map-Reply message.</dd>
          <dt>Map-Reply Record:</dt>
          <dd> When the M-bit is set, this
        field is the size of a single "Record" in the Map-Reply
        format. This Map-Reply record contains the EID-to-RLOC mapping
        entry associated with the source EID. This allows the ETR that
        will receive this Map-Request to cache the data if it chooses
        to do so. It is important to note that this mapping has not been validated by the Mapping System.</dd>
        </dl>
      </section>
      <section anchor="MAPREQ" numbered="true" toc="default">
        <name>EID-to-RLOC UDP Map-Request Message</name>
        <t>A Map-Request is sent from an ITR when it needs a mapping for
      an EID, wants to test an RLOC for reachability, or wants to
      refresh a mapping before Time to Live (TTL) expiration. For the initial case,
      the destination IP address used for the Map-Request is the data
      packet's destination address (i.e., the destination EID) that
      had a mapping cache lookup failure. For the latter two cases,
      the destination IP address used for the Map-Request is one of
      the RLOC addresses from the Locator-Set of the Map-Cache
      entry. The source address is either an IPv4 or IPv6 RLOC
      address, depending on whether the Map-Request is using an IPv4
      or IPv6 header, respectively. In all cases, the UDP source port
      number for the Map-Request message is a 16-bit value selected by
      the ITR/PITR, and the UDP destination port number is set to the
      well-known destination port number 4342.  A successful
      Map-Reply, which is one that has a nonce that matches an
      outstanding Map-Request nonce, will update the cached set of
      RLOCs associated with the EID-Prefix range.</t>
        <t>One or more Map-Request ('ITR-RLOC-AFI', 'ITR-RLOC Address')
      fields <bcp14>MUST</bcp14> be filled in by the ITR. The number of fields (minus
      1) encoded <bcp14>MUST</bcp14> be placed in the 'IRC' field. The ITR <bcp14>MAY</bcp14>
      include all locally configured Locators in this list or just
      provide one Routing Locator Address from each address family it
      supports. If the ITR erroneously provides no ITR-RLOC addresses,
      the Map-Replier <bcp14>MUST</bcp14> drop the Map-Request.</t>
        <t>Map-Requests can also be LISP encapsulated using UDP
      destination port&nbsp;4342 with a LISP Type value set to
      "Encapsulated Control Message", when sent from an ITR to a
      Map-Resolver.  Likewise, Map-Requests are LISP encapsulated the
      same way from a Map-Server to an ETR.  Details on Encapsulated
      Map-Requests and Map-Resolvers can be found in <xref target="encap-mr" format="default"/>.</t>
        <t>Map-Requests <bcp14>MUST</bcp14> be rate limited to 1 per second per EID-Prefix.
      After 10 retransmits without receiving the corresponding Map-Reply, the sender <bcp14>MUST</bcp14> wait 30 seconds.</t>
        <t>An ITR that is configured with mapping database information
      (i.e., it is also an ETR) <bcp14>MAY</bcp14> optionally include those mappings
      in a Map-Request.  When an ETR configured to accept and verify
      such "piggybacked" mapping data receives such a Map-Request and
      it does not have this mapping in the Map-Cache, it <bcp14>MUST</bcp14> originate
      a "verifying Map-Request" through the mapping database to validate
      the "piggybacked" mapping data.</t>
      </section>
      <section anchor="MR-FORMAT" numbered="true" toc="default">
        <name>Map-Reply Message Format</name>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Type=2 |P|E|S|          Reserved               | Record Count  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         Nonce . . .                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         . . . Nonce                           |
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   |                          Record TTL                           |
|   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
R   | Locator Count | EID mask-len  | ACT |A|      Reserved         |
e   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
c   | Rsvd  |  Map-Version Number   |       EID-Prefix-AFI          |
o   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
r   |                          EID-Prefix                           |
d   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  /|    Priority   |    Weight     |  M Priority   |   M Weight    |
| L +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| o |        Unused Flags     |L|p|R|           Loc-AFI             |
| c +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  \|                             Locator                           |
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <t>Packet field descriptions:</t>
        <dl newline="false" spacing="normal">
          <dt>Type: </dt>
          <dd>2 (Map-Reply)</dd>
          <dt>P:</dt>
          <dd> This is the probe-bit, which indicates that
        the Map-Reply is in response to a Locator reachability probe
        Map-Request. The 'Nonce' field must contain a copy of the
        nonce value from the original Map-Request. See 
        "<xref target="rloc-probe" format="title"/>" (<xref target="rloc-probe" format="default"/>) for more details. When the
        probe-bit is set to 1 in a Map-Reply message, the A-bit in
        each EID-Record included in the message <bcp14>MUST</bcp14> be set to 1;
        otherwise, it <bcp14>MUST</bcp14> be silently discarded.</dd>
          <dt>E:</dt>
          <dd> This bit indicates that the ETR that sends
        this Map-Reply message is advertising that the site is enabled
        for the Echo-Nonce Locator reachability algorithm. See
Section&nbsp;<xref target="RFC9300" section="10.1"
sectionFormat="bare">"Echo-Nonce Algorithm"</xref> of <xref target="RFC9300"/> for more
        details.</dd>
          <dt>S:</dt>
          <dd> This is the Security bit. When set to 1, the
        following authentication information will be appended to the
        end of the Map-Reply. Details can be found in <xref target="RFC9303" format="default"/>.</dd>
        </dl>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    AD Type    |       Authentication Data Content . . .       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <dl newline="false" spacing="normal">
          <dt>Reserved:</dt>
          <dd> This unassigned field <bcp14>MUST</bcp14> be set to 0 on
        transmit and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
          <dt>Record Count:</dt>
          <dd> This is the number of records in
        this reply message.  A record is comprised of that portion of
        the packet labeled 'Record' above and occurs the number of
        times equal to Record Count. Note that the reply count can
        be larger than the requested count, for instance, when more-specific prefixes are present.</dd>

          <dt>Nonce:</dt>
          <dd> This 64-bit value from the Map-Request
        is echoed in this 'Nonce' field of the Map-Reply.</dd>
          <dt>Record TTL:</dt>
          <dd> This is the time in minutes the
        recipient of the Map-Reply can store the mapping.  If the TTL
        is 0, the entry <bcp14>MUST</bcp14> be removed from the cache immediately.
        If the value is 0xffffffff, the recipient can decide locally
        how long to store the mapping.</dd>
          <dt>Locator Count:</dt>
          <dd> This is the number of Locator
        entries in the given Record. A Locator entry comprises what is labeled above as
        'Loc'. The Locator count can be 0, indicating that
        there are no Locators for the EID-Prefix.</dd>
          <dt>EID mask-len:</dt>
          <dd> This is the mask length for the
        EID-Prefix.</dd>
          <dt>ACT:</dt>
          <dd> <t>This 3-bit field describes Negative
        Map-Reply actions. In any other message type, these bits are
        set to 0 and ignored on receipt. These bits are used only when
        the 'Locator Count' field is set to 0. The action bits are
        encoded only in Map-Reply messages. They are used to tell an
        ITR or PITR why an empty Locator-Set was returned from the
        Mapping System and how it stores the Map-Cache entry.
        See <xref target="act-iana" format="default"/> for additional information.</t>
            <dl newline="false" spacing="normal" indent="4">
              <dt>(0) No-Action:</dt>
              <dd>The Map-Cache is kept alive,
          and no packet encapsulation occurs.</dd>
              <dt>(1) Natively-Forward:</dt>
              <dd>The packet is not
          encapsulated or dropped but natively forwarded.</dd>
              <dt>(2) Send-Map-Request:</dt>
              <dd>The Map-Cache entry is
          created and flagged so that any packet matching this entry
          invokes sending a Map-Request.</dd>
              <dt>(3) Drop/No-Reason:</dt>
              <dd>A packet that matches this
          Map-Cache entry is dropped. An ICMP Destination Unreachable
          message <bcp14>SHOULD</bcp14> be sent.</dd>
              <dt>(4) Drop/Policy-Denied:</dt>
              <dd>A packet that matches
	      this Map-Cache entry is dropped. The reason for the Drop
	      action is that a Map-Request for the target EID is being
	      policy-denied by either an xTR or the Mapping System.</dd>
              <dt>(5) Drop/Auth-Failure:</dt>
              <dd>A packet that
	      matches this Map-Cache entry is dropped.  The reason for the
	      Drop action is that a Map-Request for the target EID fails
	      an authentication verification check by either an xTR or the
	      Mapping System.</dd>
            </dl>
          </dd>
          <dt>A:</dt>
          <dd> The Authoritative bit <bcp14>MAY</bcp14> only be set to 1 by an ETR.
        A Map-Server generating Map-Reply messages as a proxy <bcp14>MUST NOT</bcp14> set the A-bit to 1. This bit
        indicates to the requesting ITRs if the Map-Reply was
        originated by a LISP node managed at the site that owns the
        EID-Prefix.</dd>
          <dt>Map-Version Number:</dt>
          <dd> When this 12-bit value in an EID-Record of a
          Map-Reply message is non-zero, see <xref target="RFC9302"
	  format="default"/> for details.</dd>
          <dt>EID-Prefix-AFI:</dt>
          <dd>This is the address family of the
        EID-Prefix according to <xref target="AFN" format="default"/> and <xref target="RFC8060" format="default"/>.</dd>
          <dt>EID-Prefix:</dt>
          <dd> This prefix is 4 octets for an IPv4
        address family and 16 octets for an IPv6 address family.</dd>
          <dt>Priority:</dt>
          <dd> Each RLOC is assigned a unicast
        Priority.  Lower values are preferable. When multiple
        RLOCs have the same Priority, they may be used in a load-split
        fashion.  A value of 255 means the RLOC <bcp14>MUST NOT</bcp14> be used for
        unicast forwarding.</dd>
          <dt>Weight:</dt>
          <dd> When priorities are the same for
        multiple RLOCs, the Weight indicates how to balance unicast
        traffic between them. Weight is encoded as a relative weight
        of total unicast packets that match the mapping entry. For
        example, if there are 4 Locators in a Locator-Set, where the
        Weights assigned are 30, 20, 20, and 10, the first Locator
        will get 37.5% of the traffic, the second and third Locators will
        each get 25% of the traffic, and the fourth Locator will get 12.5% of
        the traffic. If all Weights for a Locator-Set are equal, the
        receiver of the Map-Reply will decide how to load-split the
        traffic. See Section&nbsp;<xref target="RFC9300" section="12"
        sectionFormat="bare">"Routing Locator Hashing"</xref> of <xref target="RFC9300"/> for a suggested hash
        algorithm to distribute the load across Locators with the same
        Priority and equal Weight values.</dd>
          <dt>M Priority:</dt>
          <dd> Each RLOC is assigned a multicast
        Priority used by an ETR in a receiver multicast site to select
        an ITR in a source multicast site for building multicast
        distribution trees. A value of 255 means the RLOC <bcp14>MUST NOT</bcp14> be
        used for joining a multicast distribution tree.  For more
        details, see <xref target="RFC6831" format="default"/>.</dd>
          <dt>M Weight:</dt>
          <dd>When priorities are the same for
        multiple RLOCs, the Weight indicates how to balance building
        multicast distribution trees across multiple ITRs. The Weight
        is encoded as a relative weight (similar to the unicast
        Weights) of the total number of trees built to the source site
        identified by the EID-Prefix. If all Weights for a Locator-Set
        are equal, the receiver of the Map-Reply will decide how to
        distribute multicast state across ITRs. For more details, see
        <xref target="RFC6831" format="default"/>.</dd>
          <dt>Unused Flags:</dt>
          <dd>These are set to 0 when sending
        and ignored on receipt.</dd>
          <dt>L:</dt>
          <dd>When this bit is set, the Locator is flagged
        as a local Locator to the ETR that is sending the Map-Reply.
        When a Map-Server is doing proxy Map-Replying for a LISP site,
        the L-bit is set to 0 for all Locators in this
        Locator-Set.</dd>
          <dt>p:</dt>
          <dd>When this bit is set, an ETR informs the
        RLOC-Probing ITR that the Routing Locator Address for which this bit
        is set is the one being RLOC-Probed and may be different from
        the source address of the Map-Reply. An ITR that RLOC-Probes a
        particular Locator <bcp14>MUST</bcp14> use this Locator for retrieving the
        data structure used to store the fact that the Locator is
        reachable. The p-bit is set for a single Locator in the same
        Locator-Set.  If an implementation sets more than one p-bit
        erroneously, the receiver of the Map-Reply <bcp14>MUST</bcp14> select the
        first set p-bit Locator. The p-bit <bcp14>MUST NOT</bcp14> be set for Locator-Set
        records sent in Map-Request and Map-Register messages.</dd>
          <dt>R:</dt>
          <dd>This is set when the sender of a Map-Reply
        has a route to the Locator in the Locator data record.  This
        receiver may find this useful to know if the Locator is up but
        not necessarily reachable from the receiver's point of
        view.</dd>
          <dt>Locator:</dt>
          <dd>This is an IPv4 or IPv6 address (as
        encoded by the 'Loc-AFI' field) assigned to an ETR and used by
        an ITR as a destination RLOC address in the outer header of a
        LISP encapsulated packet. Note that the destination RLOC
        address of a LISP encapsulated packet <bcp14>MAY</bcp14> be an anycast
        address. A source RLOC of a LISP encapsulated packet can be an
        anycast address as well.  The source or destination RLOC <bcp14>MUST
        NOT</bcp14> be the broadcast address (255.255.255.255 or any subnet
        broadcast address known to the router) and <bcp14>MUST NOT</bcp14> be a
        link-local multicast address.  The source RLOC <bcp14>MUST NOT</bcp14> be a
        multicast address. The destination RLOC <bcp14>SHOULD</bcp14> be a multicast
        address if it is being mapped from a multicast destination
        EID.</dd>
        </dl>
        <t>Map-Replies <bcp14>MUST</bcp14> be rate limited. It is <bcp14>RECOMMENDED</bcp14> that a Map-Reply
      for the same destination RLOC be sent to no more than one packet every 3 seconds.</t>
        <t>The Record format, as defined here, is used both in the Map-Reply
    and Map-Register messages; this includes all the field definitions. </t>
      </section>
      <section anchor="MR" numbered="true" toc="default">
        <name>EID-to-RLOC UDP Map-Reply Message</name>
        <t>A Map-Reply returns an EID-Prefix with a mask length that
      is less than or equal to the EID being requested. The EID being
      requested is either from the destination field of an IP header
      of a Data-Probe or the EID of a record of a Map-Request.  The RLOCs
      in the Map-Reply are routable IP addresses of all ETRs for the
      LISP site. Each RLOC conveys status reachability but does not
      convey path reachability from a requester's
      perspective. Separate testing of path reachability is
      required. See "<xref target="rloc-probe" format="title"/>" (<xref target="rloc-probe" format="default"/>) for
      details.</t>
        <t>Note that a Map-Reply <bcp14>MAY</bcp14> contain different EID-Prefix
      granularity (prefix + mask length) than the Map-Request that triggers
      it. This might occur if a Map-Request were for a prefix that had
      been returned by an earlier Map-Reply. In such a case, the
      requester updates its cache with the new prefix information and
      granularity. For example, a requester with two cached
      EID-Prefixes that are covered by a Map-Reply containing one
      less-specific prefix replaces the entry with the less-specific
      EID-Prefix. Note that the reverse, replacement of one
      less-specific prefix with multiple more-specific prefixes, can
      also occur, not by removing the less-specific prefix but rather
      by adding the more-specific prefixes that, during a lookup, will
      override the less-specific prefix.</t>
        <t>When an EID moves out of a LISP site <xref target="EID-MOBILITY" format="default"/>, the database Mapping System
      may have overlapping EID-Prefixes. Or when a LISP site is
      configured with multiple sets of ETRs that support different
      EID-Prefix mask lengths, the database Mapping System may have
      overlapping EID-Prefixes. When overlapping EID-Prefixes exist, a
      Map-Request with an EID that best matches any EID-Prefix <bcp14>MUST</bcp14> be
      returned in a single Map-Reply message. For instance, if an ETR
      had database mapping entries for EID-Prefixes:</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
  2001:db8::/32
  2001:db8:1::/48
  2001:db8:1:1::/64
  2001:db8:1:2::/64
]]></artwork>
        <t>A Map-Request for EID 2001:db8:1:1::1 would cause a Map-Reply
      with a record count of 1 to be returned with a mapping record
      EID-Prefix of 2001:db8:1:1::/64.</t>
        <t>A Map-Request for EID 2001:db8:1:5::5 would cause a Map-Reply
      with a record count of 3 to be returned with mapping records for
      EID-Prefixes 2001:db8:1::/48, 2001:db8:1:1::/64, and
      2001:db8:1:2::/64, filling out the /48 with more-specific prefixes
      that exist in the Mapping System.</t>
        <t>Note that not all overlapping EID-Prefixes need to be
      returned but only the more-specific entries (note in the
      second example above that 2001:db8::/32 was not returned for requesting
      EID 2001:db8:1:5::5) for the matching EID-Prefix of the requesting
      EID. When more than one EID-Prefix is returned, all <bcp14>SHOULD</bcp14> use
      the same TTL value so they can all time out at the same
      time. When a more-specific EID-Prefix is received later, its
      TTL value in the Map-Reply record can be stored even
      when other less-specific entries exist. When a less-specific
      EID-Prefix is received later, its Map-Cache expiration time
      <bcp14>SHOULD</bcp14> be set to the minimum expiration time of any
      more-specific EID-Prefix in the Map-Cache. This is done so the
      integrity of the EID-Prefix set is wholly maintained and so no
      more-specific entries are removed from the Map-Cache while
      keeping less-specific entries.</t>
        <t>For scalability, it is expected that aggregation of EID addresses
      into EID-Prefixes will allow one Map-Reply to satisfy a mapping
      for the EID addresses in the prefix range, thereby reducing the
      number of Map-Request messages.</t>
        <t>Map-Reply records can have an empty Locator-Set.  A Negative
      Map-Reply is a Map-Reply with an empty Locator-Set.  Negative
      Map-Replies convey special actions by the Map-Reply sender to the ITR or
      PITR that have solicited the Map-Reply.  There are two primary
      applications for Negative Map-Replies. The first is for a
      Map-Resolver to instruct an ITR or PITR when a destination is
      for a LISP site versus a non-LISP site, and the other is to
      source quench Map-Requests that are sent for non-allocated
      EIDs.</t>
        <t>For each Map-Reply record, the list of Locators in a
      Locator-Set <bcp14>MUST</bcp14> be sorted
      in order of ascending IP address where an IPv4 Routing Locator
      Address is considered numerically "less than" an IPv6 Routing
	Locator Address.</t>
        <t>When sending a Map-Reply message, the destination address is
      copied from one of the 'ITR-RLOC' fields from the
      Map-Request. The ETR can choose a Routing Locator Address from one of
      the address families it supports. For Data-Probes, the
      destination address of the Map-Reply is copied from the source
      address of the Data-Probe message that is invoking the
      reply. The source address of the Map-Reply is one of the chosen local
      IP addresses; this allows Unicast Reverse Path Forwarding
      (uRPF) checks to succeed in the upstream service provider. The
      destination port of a Map-Reply message is copied from the
      source port of the Map-Request or Data-Probe, and the source
      port of the Map-Reply message is set to the well-known UDP port
      4342.</t>
      </section>
      <section anchor="MAPREG" numbered="true" toc="default">
        <name>Map-Register Message Format</name>
        <t>This section specifies the encoding format for the
      Map-Register message. The message is sent in UDP with a
      destination UDP port of 4342 and a randomly selected UDP source
      port number.</t>
        <t>The fields below are used in multiple control messages. They
      are defined for Map-Register, Map-Notify, and Map-Notify-Ack message
      types.</t>
        <t>The Map-Register message format is:</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Type=3 |P|S|I|        Reserved       |E|T|a|R|M| Record Count  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         Nonce . . .                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         . . . Nonce                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |    Key ID     | Algorithm ID  |  Authentication Data Length   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    ~                     Authentication Data                       ~
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   |                          Record TTL                           |
|   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
R   | Locator Count | EID mask-len  | ACT |A|      Reserved         |
e   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
c   | Rsvd  |  Map-Version Number   |        EID-Prefix-AFI         |
o   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
r   |                          EID-Prefix                           |
d   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  /|    Priority   |    Weight     |  M Priority   |   M Weight    |
| L +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| o |        Unused Flags     |L|p|R|           Loc-AFI             |
| c +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  \|                             Locator                           |
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <t>Packet field descriptions:</t>
        <dl newline="false" spacing="normal">
          <dt>Type: </dt>
          <dd>3 (Map-Register)</dd>
          <dt>P:</dt>
          <dd>This is the proxy Map-Reply bit. When set to
        1, the ETR sending the Map-Register message is requesting the
        Map-Server to proxy a Map-Reply. The Map-Server will send
        non-authoritative Map-Replies on behalf of the ETR.</dd>
          <dt>S:</dt>
          <dd>This is the security-capable bit. When set,
        the procedures from <xref target="RFC9303" format="default"/> are
        supported.</dd>
          <dt>I:</dt>
          <dd>This is the ID-present bit. This bit is set to 1 to indicate that a
	  128-bit 'xTR-ID' field and a 64-bit 'Site-ID' field are present at the end
        of the Map-Register message.  If an xTR is configured with an
        xTR-ID and Site-ID, it <bcp14>MUST</bcp14> set the I-bit to 1 and include its
        xTR-ID and Site-ID in the Map-Register messages it generates.
        The combination of Site-ID plus xTR-ID uniquely identifies an
        xTR in a LISP domain and serves to track its last seen
        nonce.</dd>
          <dt>Reserved:</dt>
          <dd>This unassigned field <bcp14>MUST</bcp14> be set to 0 on
        transmit and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
          <dt>E:</dt>
          <dd>This is the Map-Register EID-notify bit. This
        is used by a First-Hop Router  that discovers a
        dynamic EID. This EID-notify-based Map-Register is sent by the
        First-Hop Router to a same site xTR that propagates the Map-Register to
        the Mapping System. The site xTR keeps state to later
        Map-Notify the First-Hop Router after the EID has moved away. See <xref target="EID-MOBILITY" format="default"/> for a detailed
        use case.</dd>
          <dt>T:</dt>
          <dd>This is the use TTL for timeout bit. When set
        to 1, the xTR wants the Map-Server to time out registrations
        based on the value in the 'Record TTL' field of this
        message. Otherwise, the default timeout described in <xref target="reg" format="default"/> is used.</dd>
          <dt>a:</dt>
          <dd>This is the merge-request bit. When set to 1,
        the xTR requests to merge RLOC-Records from different xTRs
        registering the same EID-Record. See Signal-Free Multicast
        <xref target="RFC8378" format="default"/> for one
        use-case example.</dd>
          <dt>R:</dt>
          <dd>This reserved and unassigned bit <bcp14>MUST</bcp14> be set to 0 on
        transmit and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
          <dt>M:</dt>
          <dd>This is the want-map-notify bit. When set to
        1, an ETR is requesting a Map-Notify message to be returned in
        response to sending a Map-Register message. The Map-Notify
        message sent by a Map-Server is used to acknowledge receipt of
        a Map-Register message.</dd>
          <dt>Record Count:</dt>
          <dd> This is the number of records in
        this Map-Register message.  A record is comprised of that
        portion of the packet labeled 'Record' above and occurs the
        number of times equal to Record Count.</dd>
          <dt>Nonce:</dt>
          <dd> This 8-octet 'Nonce' field is
        incremented each time a Map-Register message is sent. When a
        Map-Register acknowledgment is requested, the nonce is
        returned by Map-Servers in Map-Notify messages.  Since the
        entire Map-Register message is authenticated, the 'Nonce'
        field serves to protect against Map-Register replay
        attacks. An ETR that registers to the Mapping System <bcp14>SHOULD</bcp14>
        store the last nonce sent in persistent storage, so when it
        restarts, it can continue using an incrementing nonce. If
        the ETR cannot support saving the nonce, then when it restarts,
        it <bcp14>MUST</bcp14> use a new authentication key to register to the
        Mapping System. A Map-Server <bcp14>MUST</bcp14> track and save in persistent
        storage the last nonce received for each ETR xTR-ID and key pair.
		If a Map-Register is received with a nonce
        value that is not greater than the saved nonce, it <bcp14>MUST</bcp14> drop the
        Map-Register message and <bcp14>SHOULD</bcp14> log the fact that a replay attack could
        have occurred.</dd>
          <dt>Key ID:</dt>
          <dd>This is a key-id value that identifies a
		pre-shared secret between an ETR and a Map-Server. Per-message
		keys are derived from the pre-shared secret to authenticate
		the origin and protect the integrity of the Map-Register.
		The Key ID allows rotating between multiple pre-shared
		secrets in a nondisruptive way. The pre-shared secret <bcp14>MUST</bcp14>
		be unique per each LISP Site-ID.</dd>
          <dt>Algorithm ID:</dt>
          <dd> This field identifies the Key
		Derivation Function (KDF) and Message Authentication Code (MAC)
		algorithms used to derive the key and to compute the Authentication
		Data of a Map-Register.  This 8-bit field identifies the KDF and
		MAC algorithm pair.  See <xref target="KEYS" format="default"/> for codepoint assignments.</dd>
          <dt>Authentication Data Length:</dt>
          <dd> This is the length
        in octets of the 'Authentication Data' field that follows this
        field.  The length of the 'Authentication Data' field is
        dependent on the MAC algorithm used. The length field allows a
        device that doesn't know the MAC algorithm to correctly parse
        the packet.</dd>
          <dt>Authentication Data:</dt>
          <dd><t>This is the output of the
		MAC algorithm placed in this field after the MAC computation.
		The MAC output is computed as follows:</t>
            <ol spacing="normal" type="1">
              <li>The KDF algorithm is identified by the
		  'Algorithm ID' field according to the table in <xref target="KEYS" format="default"/>. Implementations of this specification <bcp14>MUST</bcp14> implement HMAC-SHA-256-128 <xref target="RFC4868" format="default"/> and <bcp14>SHOULD</bcp14> implement HMAC-SHA-256-128+HKDF-SHA256 <xref target="RFC5869" format="default"/>.</li>
              <li>The MAC algorithm is identified by the 'Algorithm ID' field
		  according to the table in <xref target="KEYS" format="default"/>.</li>
              <li>The pre-shared secret used to derive the per-message key is represented by PSK[Key ID], that is, the pre-shared secret identified by the Key ID.</li>
              <li>The derived per-message key is computed as: per-msg-key=KDF(nonce+PSK[Key ID],s). Where the nonce is the value in the 'Nonce' field of the Map-Register, "+" denotes concatenation and "s" (the salt)
      is a string that
      corresponds to the message type being authenticated.  For
      Map-Register messages, it is equal to "Map-Register
      Authentication".  Similarly, for Map-Notify and Map-Notify-Ack
      messages, it is "Map-Notify Authentication" and
        "Map-Notify-Ack Authentication", respectively. For those Algorithm IDs defined in <xref target="KEYS" format="default"/> that specify a 'none' KDF, the per-message key is computed as: per-msg-key = PSK[Key ID]. This means that the same key is used across multiple protocol messages.</li>
              <li>The MAC output is computed using the MAC algorithm and
		  the per-msg-key over the entire Map-Register payload
		  (from and including the LISP message type field through the
		  end of the last RLOC-Record) with the authenticated data field preset to 0.</li>
            </ol>
          </dd>
        </dl>
        <t>The definition of the rest of the Map-Register can be found
      in the EID-Record description in <xref target="MR-FORMAT" format="default"/>. When
      the I-bit is set, the following fields are added to the end of
      the Map-Register message:</t>
        <dl newline="false" spacing="normal">
          <dt>xTR-ID:</dt>
          <dd>'xTR-ID' is a 128-bit field at the end of
        the Map-Register message, starting after the final Record in
        the message. The xTR-ID is used to uniquely identify an xTR.
        The same xTR-ID value <bcp14>MUST NOT</bcp14> be used in two different xTRs in the scope of the Site-ID.</dd>
          <dt>Site-ID:</dt>
          <dd>'Site-ID' is a 64-bit field at the end of
        the Map-Register message, following the xTR-ID.  The Site-ID is
        used to uniquely identify to which site the xTR that sent the
        message belongs. This document does not specify a strict meaning for the 'Site-ID' field.
        Informally, it provides an indication that a group of xTRs have some relationship, either administratively, topologically, or otherwise.</dd>
        </dl>
      </section>
      <section anchor="MAP-NOTIF-MAP-NOTIF-ACK" numbered="true" toc="default">
        <name>Map-Notify and Map-Notify-Ack Message Formats</name>
        <t>This section specifies the encoding format for the Map-Notify
      and Map-Notify-Ack messages. The messages are sent inside a UDP
      packet with source and destination UDP ports equal to 4342.</t>
        <t>The Map-Notify and Map-Notify-Ack message formats are:</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Type=4/5|             Reserved                 | Record Count  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         Nonce . . .                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         . . . Nonce                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |    Key ID     | Algorithm ID  |  Authentication Data Length   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    ~                     Authentication Data                       ~
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   |                          Record TTL                           |
|   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
R   | Locator Count | EID mask-len  | ACT |A|      Reserved         |
e   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
c   | Rsvd  |  Map-Version Number   |         EID-Prefix-AFI        |
o   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
r   |                          EID-Prefix                           |
d   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  /|    Priority   |    Weight     |  M Priority   |   M Weight    |
| L +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| o |        Unused Flags     |L|p|R|           Loc-AFI             |
| c +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  \|                             Locator                           |
+-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <t>Packet field descriptions:</t>
        <dl newline="false" spacing="normal">
          <dt>Type: </dt>
          <dd>4/5 (Map-Notify/Map-Notify-Ack)</dd>
        </dl>
        <t>The Map-Notify message has the same contents as a
      Map-Register message. See "<xref target="MAPREG" format="title"/>" (<xref target="MAPREG" format="default"/>) for field descriptions and
"<xref target="MR-FORMAT" format="title"/>" (<xref target="MR-FORMAT" format="default"/>) for EID-Record and RLOC-Record descriptions.</t>
        <t>The fields of the Map-Notify are copied from the
      corresponding Map-Register to acknowledge its correct
      processing. In the Map-Notify, the 'Authentication Data'
      field is recomputed using the corresponding per-message key and according to the procedure defined
      in the previous section. The Map-Notify message can also be used in an unsolicited manner.  This topic is out of scope for this document. See <xref target="I-D.ietf-lisp-pubsub" format="default"/> for details.</t>
        <t>After sending a Map-Register, if a Map-Notify is not
	  received after 1 second, the transmitter <bcp14>MUST</bcp14> retransmit
	  the original Map-Register with an exponential backoff (base of 2, that is, the next backoff timeout interval is doubled);
	  the maximum backoff is 1 minute. Map-Notify messages are only transmitted upon the reception of a Map-Register with the M-bit set; Map-Notify messages are not retransmitted. The only exception to this is for unsolicited Map-Notify messages; see below.</t>
        <t>A Map-Server sends an unsolicited Map-Notify message (one
      that is not used as an acknowledgment to a Map-Register message)
      only in conformance with Section&nbsp;<xref target="RFC8085" section="3.1"
sectionFormat="bare">"Congestion Control Guidelines"</xref> of <xref target="RFC8085"/> and Section&nbsp;<xref target="RFC8085" section="3.3"
sectionFormat="bare">"Reliability Guidelines"</xref> of <xref target="RFC8085"/>. A Map-Notify is
      retransmitted until a Map-Notify-Ack is received by the
      Map-Server with the same nonce used in the Map-Notify message.
      An implementation <bcp14>SHOULD</bcp14> retransmit up to
      3 times at 3-second retransmission intervals, after which time
      the retransmission interval is exponentially backed off (base of 2, that is, the next backoff timeout interval is doubled) for
      another 3 retransmission attempts. Map-Notify-Ack messages are only transmitted upon the reception of an unsolicited Map-Notify; Map-Notify-Ack messages are not retransmitted.</t>
        <t>The Map-Notify-Ack message has the same contents as a
      Map-Notify message.  It is used to acknowledge the receipt of an unsolicited
 Map-Notify and, once the Authentication Data is validated, allows 
 the sender to stop retransmitting a Map-Notify with the same nonce
 and (validated) Authentication Data. The fields of
      the Map-Notify-Ack are copied from the corresponding Map-Notify
      message to acknowledge its correct processing. The 'Authentication Data'
      field is recomputed using the corresponding per-message key and according to the procedure defined
      in the previous section.</t>
        <t>Upon reception of a Map-Register, Map-Notify, or Map-Notify-Ack, the receiver verifies
        the Authentication Data. If the Authentication Data fails to validate, the
message is dropped without further processing.</t>
      </section>
      <section anchor="encap-mr" numbered="true" toc="default">
        <name>Encapsulated Control Message Format</name>
        <t>An Encapsulated Control Message (ECM) is used to encapsulate
      control packets sent between xTRs and the mapping database system or internal to the mapping
      database system.</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   / |                       IPv4 or IPv6 Header                     |
 OH  |                      (uses RLOC addresses)                    |
   \ |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   / |       Source Port = xxxx      |       Dest Port = 4342        |
 UDP +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   \ |           UDP Length          |        UDP Checksum           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
LISP |Type=8 |S|D|R|R|            Reserved                           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   / |                       IPv4 or IPv6 Header                     |
 IH  |                  (uses RLOC or EID addresses)                 |
   \ |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   / |       Source Port = xxxx      |       Dest Port = yyyy        |
 UDP +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   \ |           UDP Length          |        UDP Checksum           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 LCM |                      LISP Control Message                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <t>Packet header descriptions:</t>
        <dl newline="false" spacing="normal" indent="6">
          <dt>OH:</dt>
          <dd>This is the outer IPv4 or IPv6 header, which uses
        RLOC addresses in the source and destination header address
        fields.</dd>
          <dt>UDP:</dt>
          <dd>This is the outer UDP header with destination port
        4342. The source port is randomly allocated. The checksum
        field <bcp14>MUST</bcp14> be non-zero.</dd>
          <dt>LISP:</dt>
          <dd>Type 8 is defined to be a "LISP Encapsulated
        Control Message", and what follows is either an IPv4 or IPv6
        header, as encoded by the first 4 bits after the 'Reserved'
        field, or the 'Authentication Data' field <xref target="RFC9303" format="default"/> if the S-bit (see below) is set.</dd>
          <dt>Type: </dt>
          <dd>8 (Encapsulated Control Message (ECM))</dd>
          <dt>S:</dt>
          <dd>This is the Security bit.  When set to 1, the
        field following the 'Reserved' field will have the following
        Authentication Data format and follow the procedures from <xref target="RFC9303" format="default"/>.</dd>
        </dl>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    AD Type    |       Authentication Data Content . . .       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <dl newline="false" spacing="normal" indent="6">
          <dt>D:</dt>
          <dd>This is the DDT-bit. When set to 1, the
        sender is requesting a Map-Referral message to be
        returned. Details regarding this procedure are described in <xref target="RFC8111" format="default"/>.</dd>
          <dt>R:</dt>
          <dd>This reserved and unassigned bit <bcp14>MUST</bcp14> be set to 0 on
        transmit and <bcp14>MUST</bcp14> be ignored on receipt.</dd>
        </dl>
        <dl newline="false" spacing="normal" indent="6">
          <dt>IH:</dt>
          <dd>This is the inner IPv4 or IPv6 header, which can use
        either RLOC or EID addresses in the header address
        fields. When a Map-Request is encapsulated in this packet
        format, the destination address in this header is an EID.</dd>
          <dt>UDP:</dt>
          <dd>This is the inner UDP header, where the port
        assignments depend on the control packet being
        encapsulated. When the control packet is a Map-Request or
        Map-Register, the source port is selected by the ITR/PITR and
        the destination port is 4342.  When the control packet is a
        Map-Reply, the source port is 4342 and the destination port is
        assigned from the source port of the invoking
        Map-Request. Port number 4341 <bcp14>MUST NOT</bcp14> be assigned to either
        port. The checksum field <bcp14>MUST</bcp14> be non-zero.</dd>
          <dt>LCM:</dt>
          <dd>The format is one of the control message
        formats described in <xref target="lispcp" format="default"/>. Map-Request messages are
        allowed to be control plane (ECM) encapsulated. When
        Map-Requests are sent for RLOC-Probing purposes (i.e., the
        probe-bit is set), they <bcp14>MUST NOT</bcp14> be sent inside Encapsulated
        Control Messages. PIM Join/Prune messages <xref target="RFC6831" format="default"/> are also allowed to be control plane (ECM)
        encapsulated.</dd>
        </dl>
      </section>
    </section>
    <section numbered="true" toc="default">
      <name>Changing the Contents of EID-to-RLOC Mappings</name>
      <t>In the LISP architecture, ITRs/PITRs use a local Map-Cache to
    store EID-to-RLOC mappings for forwarding. When an ETR updates a
    mapping, a mechanism is required to inform ITRs/PITRs that are
    using such mappings.</t>
      <t>The LISP data plane defines several mechanisms to update
    mappings <xref target="RFC9300" format="default"/>. This document
    specifies the Solicit-Map-Request (SMR), a control plane
    push-based mechanism.  An additional control plane mechanism based
    on the Publish/Subscribe paradigm is specified in
    <xref target="I-D.ietf-lisp-pubsub" format="default"/>.</t>
      <section anchor="SMR" numbered="true" toc="default">
        <name>Solicit-Map-Request (SMR)</name>
        <t>Soliciting a Map-Request is a selective way for ETRs, at
          the site where mappings change, to control the rate they
          receive requests for Map-Reply messages. SMRs are also used
          to tell remote ITRs to update the mappings they have cached.</t>
        <t>Since ETRs are not required to keep track of remote ITRs
          that have cached their mappings, they do not know which ITRs
          need to have their mappings updated. As a result, an ETR will solicit
	  Map-Requests to
	  those sites to which it has been sending LISP encapsulated data
	  packets for the last minute, and when an ETR is also acting as an
	  ITR, it will send an SMR to an ITR to which it has recently sent
	encapsulated data.</t>
        <t>An SMR message is simply a bit set in a Map-Request message.
          An ITR or PITR will send a Map-Request (SMR-invoked Map-Request) when it receives an SMR
          message. While the SMR message is sent through the data plane, the SMR-invoked Map-Request
          <bcp14>MUST</bcp14> be sent through the Mapping System (not directly).</t>
        <t>Both the SMR sender and the SMR responder
           <bcp14>MUST</bcp14> rate limit these messages. It is <bcp14>RECOMMENDED</bcp14> that
		  the SMR sender rate limit a Map-Request for the same destination RLOC to
		  no more than one packet every 3 seconds. It is <bcp14>RECOMMENDED</bcp14> that the
      SMR responder rate limit a Map-Request for the same EID-Prefix to no more than once
      every 3 seconds.</t>
        <t>When an ITR receives an SMR message for
         which it does not have a cached mapping for the EID in
         the SMR message, it <bcp14>SHOULD NOT</bcp14> send an SMR-invoked
         Map-Request. This scenario can occur when an ETR sends
         SMR messages to all Locators in the Locator-Set it has
         stored in its Map-Cache but the remote ITRs that receive the
         SMR may not be sending packets to the site. There is no
         point in updating the ITRs until they need to send, in
         which case they will send Map-Requests to obtain a
         Map-Cache entry.</t>
      </section>
    </section>
    <section numbered="true" toc="default">
      <name>Routing Locator Reachability</name>
      <t>This document defines several control plane mechanisms
   for determining RLOC reachability. Please note that additional data plane
   reachability mechanisms are defined in <xref target="RFC9300" format="default"/>.</t>
      <ol spacing="normal" type="1">
	<li>An ITR may receive an ICMP Network Unreachable or Host
            Unreachable message for an RLOC it is using. This
            indicates that the RLOC is likely down. Note that trusting
            ICMP messages may not be desirable, but neither is ignoring
            them completely. Implementations are encouraged to follow
            current best practices in treating these conditions
            <xref target="I-D.ietf-opsec-icmp-filtering" format="default"/>.</li>
        <li>When an ITR participates in the routing protocol that
            operates in the underlay routing system, it can determine that
            an RLOC is down when no Routing Information Base (RIB)
            entry exists that matches the RLOC IP address.</li>
        <li>An ITR may receive an ICMP Port Unreachable message
            from a destination host. This occurs if an ITR
            attempts to use interworking <xref target="RFC6832" format="default"/> and
            LISP-encapsulated data is sent to a non-LISP-capable site.</li>
        <li>An ITR may receive a Map-Reply from an ETR in
            response to a previously sent Map-Request. The RLOC
            source of the Map-Reply is likely up, since the
            ETR was able to send the Map-Reply to the ITR.
            Please note that in some scenarios the RLOC -- from the
            outer header -- can be a spoofable field.</li>
        <li>An ITR/ETR pair can use the 'RLOC-Probing' mechanism
            described below.</li>
      </ol>
      <t>When ITRs receive ICMP Network Unreachable or Host Unreachable
        messages as a method to determine unreachability,
        they will refrain from
        using Locators that are described in Locator lists of Map-Replies.
        However, using this approach is unreliable because many network
        operators turn off generation of ICMP Destination Unreachable
        messages.</t>
      <t>If an ITR does receive an ICMP Network Unreachable or Host
        Unreachable message, it <bcp14>MAY</bcp14> originate its own ICMP Destination
        Unreachable message destined for the host that originated
        the data packet the ITR encapsulated.</t>
      <t>This assumption does create a dependency: Locator
        unreachability is detected by the receipt of ICMP Host
        Unreachable messages.  When a Locator has been determined
        to be unreachable, it is not used for active traffic; this
        is the same as if it were listed in a Map-Reply with
        Priority 255.</t>
      <t>The ITR can test the reachability of the unreachable
        Locator by sending periodic Map-Requests. Both Map-Requests and
        Map-Replies <bcp14>MUST</bcp14> be rate limited; see Sections&nbsp;<xref target="MAPREQ" format="counter"/> and <xref target="MR-FORMAT" format="counter"/> for information about rate limiting. Locator reachability testing
        is never done with data packets, since that increases the
        risk of packet loss for end-to-end sessions.</t>
      <section anchor="rloc-probe" numbered="true" toc="default">
        <name>RLOC-Probing Algorithm</name>
        <t>RLOC-Probing is a method that an ITR or PITR can use to
        determine the reachability status of one or more
        Locators that it has cached in a Map-Cache entry. The
        probe-bit of the Map-Request and Map-Reply messages is
        used for RLOC-Probing.</t>
        <t>RLOC-Probing is done in the control plane on a
        timer basis, where an ITR or PITR will originate a Map-Request
        destined to a Routing Locator Address from one of its
        own Routing Locator Addresses. A Map-Request used as an RLOC-Probe
        is NOT encapsulated and NOT sent to a Map-Server or to the
        mapping database system as one would when requesting mapping data.
        The EID-Record encoded in the Map-Request is the EID-Prefix of
        the Map-Cache entry cached by the ITR or PITR. The ITR
        <bcp14>MAY</bcp14> include a mapping data record for its own database mapping
        information that contains the local EID-Prefixes and RLOCs for
        its site. RLOC-Probes are sent periodically using a jittered
        timer interval. </t>

        <t>When an ETR receives a Map-Request message with the
        probe-bit set, it returns a Map-Reply with the probe-bit
        set. The source address of the Map-Reply is set to the IP
        address of the outgoing interface the Map-Reply destination
        address routes to. The Map-Reply <bcp14>SHOULD</bcp14> contain mapping data
        for the EID-Prefix contained in the Map-Request. This provides
        the opportunity for the ITR or PITR that sent the RLOC-Probe
        to get mapping updates if there were changes to the ETR's
        database mapping entries.</t>
        <t>There are advantages and disadvantages of RLOC-Probing.
        The main benefit of RLOC-Probing is that it can handle many
        failure scenarios, allowing the ITR to determine when the path
        to a specific Locator is reachable or has become unreachable,
        thus providing a robust mechanism for switching to using
        another Locator from the cached Locator.  RLOC-Probing can
        also provide rough Round-Trip Time (RTT) estimates between a
        pair of Locators, which can be useful for network management
        purposes as well as for selecting low-delay paths. The major
        disadvantage of RLOC-Probing is in the number of control
        messages required and the amount of bandwidth used to obtain
        those benefits, especially if the requirement for failure
        detection times is very small.</t>
      </section>
    </section>
    <section numbered="true" toc="default">
      <name>Interactions with Other LISP Components</name>
      <section numbered="true" toc="default">
        <name>ITR EID-to-RLOC Mapping Resolution</name>
        <t>An ITR is configured with one or more Map-Resolver addresses.
      These addresses are "Locators" (or RLOCs) and <bcp14>MUST</bcp14> be routable
      on the underlying core network; they <bcp14>MUST NOT</bcp14> need to be
      resolved through LISP EID-to-RLOC mapping, as that would
      introduce a circular dependency. When using a Map-Resolver, an
      ITR does not need to connect to any other database Mapping
      System.</t>
        <t> An ITR sends an Encapsulated Map-Request to a configured
      Map-Resolver when it needs an EID-to-RLOC mapping that is not
      found in its local Map-Cache. Using the Map-Resolver greatly
      reduces both the complexity of the ITR implementation and the
      costs associated with its operation.</t>
        <t> In response to an Encapsulated Map-Request, the ITR can
      expect one of the following:</t>
        <ul spacing="normal">
          <li> An immediate Negative Map-Reply (with action code
        "Natively-Forward" and a 15-minute TTL) from the
        Map-Resolver if the Map-Resolver can determine that the
        requested EID does not exist. The ITR saves the EID-Prefix
        returned in the Map-Reply in its cache, marks it as
        non-LISP-capable, and knows not to attempt LISP encapsulation
        for destinations matching it.</li>
          <li> A Negative Map-Reply (with action code
        "Natively-Forward") from a Map-Server that is authoritative (within the LISP deployment (<xref target="soa" format="default"/>))
        for an EID-Prefix that matches the requested EID but that does
        not have an actively registered, more-specific EID-Prefix. In
        this case, the requested EID is said to match a "hole" in the
        authoritative EID-Prefix. If the requested EID matches a
        more-specific EID-Prefix that has been delegated by the
        Map-Server but for which no ETRs are currently registered, a
        1-minute TTL is returned. If the requested EID matches a
        non-delegated part of the authoritative EID-Prefix, then it is
        not a LISP EID and a 15-minute TTL is returned.  See <xref target="reg" format="default"/> for a discussion of aggregate EID-Prefixes and
        details regarding Map-Server EID-Prefix matching.</li>
          <li> A LISP Map-Reply from the ETR that owns the EID-to-RLOC
        mapping or possibly from a Map-Server answering on behalf of
        the ETR. See <xref target="mr-processing" format="default"/> for more details
        on Map-Resolver message processing.</li>
        </ul>
        <t> Note that an ITR may be configured to both use a
      Map-Resolver and participate in a LISP-ALT logical
      network. In such a situation, the ITR <bcp14>SHOULD</bcp14> send Map-Requests
      through the ALT network for any EID-Prefix learned via ALT BGP.
      Such a configuration is expected to be very rare, since there is
      little benefit to using a Map-Resolver if an ITR is already
      using LISP-ALT. There would be, for example, no need for such an
      ITR to send a Map-Request to a possibly non-existent EID (and
      rely on Negative Map-Replies) if it can consult the ALT database
      to verify that an EID-Prefix is present before sending that
      Map-Request.</t>
      </section>
      <section anchor="reg" numbered="true" toc="default">
        <name>EID-Prefix Configuration and ETR Registration</name>
        <t> An ETR publishes its EID-Prefixes on a Map-Server by sending
      LISP Map-Register messages. A Map-Register message includes
      Authentication Data, so prior to sending a Map-Register message,
      the ETR and Map-Server <bcp14>MUST</bcp14> be configured with a pre-shared secret
      used to derive Map-Register authentication keys. A Map-Server's
      configuration <bcp14>SHOULD</bcp14> also include a list of the EID-Prefixes for
      which each ETR is authoritative.  Upon receipt of a Map-Register
      from an ETR, a Map-Server accepts only EID-Prefixes that are
      configured for that ETR.  Failure to implement such a check
      would leave the Mapping System vulnerable to trivial EID-Prefix
      hijacking attacks.</t>
        <t> In addition to the set of EID-Prefixes defined for each ETR
      that may register, a Map-Server is typically also configured
      with one or more aggregate prefixes that define the part of the
      EID numbering space assigned to it. When LISP-ALT is the
      database in use, aggregate EID-Prefixes are implemented as
      discard routes and advertised into ALT BGP.  The existence of
      aggregate EID-Prefixes in a Map-Server's database means that it
      may receive Map-Requests for EID-Prefixes that match an
      aggregate but do not match a registered prefix; <xref target="ms-processing" format="default"/> describes how this is handled.</t>
        <t> Map-Register messages are sent periodically from an ETR to a
      Map-Server with a suggested interval between messages of one
      minute. A Map-Server <bcp14>SHOULD</bcp14> time out and remove an ETR's
      registration if it has not received a valid Map-Register message
      within the past three&nbsp;minutes. When first contacting a
      Map-Server after restart or changes to its EID-to-RLOC database
      mappings, an ETR <bcp14>MAY</bcp14> initially send Map-Register messages at an
      increased frequency, up to one every 20 seconds.  This "quick
      registration" period is limited to five&nbsp;minutes in
      duration.</t>
        <t> An ETR <bcp14>MAY</bcp14> request that a Map-Server explicitly acknowledge
      receipt and processing of a Map-Register message by setting the
      "want-map-notify" (M-bit) flag. A Map-Server that receives a
      Map-Register with this flag set will respond with a Map-Notify
      message. Typical use of this flag by an ETR would be to set it
      for Map-Register messages sent during the initial "quick
      registration" with a Map-Server but then set it only
      occasionally during steady-state maintenance of its association
      with that Map-Server. Note that the Map-Notify message is sent
      to UDP destination port 4342, not to the source port specified
      in the original Map-Register message.</t>
        <t> Note that a one-minute minimum registration interval during
      maintenance of an ETR-Map-Server association places a lower
      bound on how quickly and how frequently a mapping database entry
      can be updated. This may have implications for what sorts of
      mobility can be supported directly by the Mapping System;
      shorter registration intervals or other mechanisms might be
      needed to support faster mobility in some cases. For a
      discussion on one way that faster mobility may be implemented
      for individual devices, please see <xref target="I-D.ietf-lisp-mn" format="default"/>.</t>
        <t> An ETR <bcp14>MAY</bcp14> also request, by setting the "proxy Map-Reply"
      flag (P-bit) in the Map-Register message, that a Map-Server
      answer Map-Requests instead of forwarding them to the ETR.  See
      <xref target="rloc-probe" format="default"/> for details on how
      the Map-Server sets certain flags (such as those indicating
      whether the message is authoritative and how returned Locators
      <bcp14>SHOULD</bcp14> be treated) when sending a Map-Reply on behalf of an ETR.
      When an ETR requests proxy reply service, it <bcp14>SHOULD</bcp14> include all
      RLOCs for all ETRs for the EID-Prefix being registered, along
      with the routable flag ("R-bit") setting for each RLOC.  The
      Map-Server includes all of this information in Map-Reply
      messages that it sends on behalf of the ETR. This differs from a
      non-proxy registration, since the latter need only provide one
      or more RLOCs for a Map-Server to use for forwarding
      Map-Requests; the registration information is not used in
      Map-Replies, so it being incomplete is not incorrect.</t>
        <t> An ETR that uses a Map-Server to publish its EID-to-RLOC
      mappings does not need to participate further in the mapping
      database protocol(s). When using a LISP-ALT mapping database,
      for example, this means that the ETR does not need to implement
      GRE or BGP, which greatly simplifies its configuration and
      reduces its cost of operation.</t>
        <t> Note that use of a Map-Server does not preclude an ETR from
      also connecting to the mapping database (i.e., it could also
      connect to the LISP-ALT network), but doing so doesn't seem
      particularly useful, as the whole purpose of using a Map-Server
      is to avoid the complexity of the mapping database
      protocols.</t>
      </section>
      <section anchor="ms-processing" numbered="true" toc="default">
        <name>Map-Server Processing</name>
        <t> Once a Map-Server has EID-Prefixes registered by its client
      ETRs, it can accept and process Map-Requests for them.</t>
        <t> In response to a Map-Request, the Map-Server first checks to see if the
      destination EID matches a configured EID-Prefix. If there is no
      match, the Map-Server returns a Negative Map-Reply with action
      code "Natively-Forward" and a 15-minute TTL. This can occur if a
      Map-Request is received for a configured aggregate EID-Prefix
      for which no more-specific EID-Prefix exists; it indicates the
      presence of a non-LISP "hole" in the aggregate EID-Prefix.</t>
        <t>Next, the Map-Server checks to see if any ETRs have
      registered the matching EID-Prefix. If none are found, then the
      Map-Server returns a Negative Map-Reply with action code
      "Natively-Forward" and a 1-minute TTL.</t>
        <t>If the EID-Prefix is either registered or not registered to
      the Mapping System and there is a policy in the Map-Server to
      have the requester drop packets for the matching EID-Prefix,
      then a Drop/Policy-Denied action is returned. If the EID-Prefix
      is registered or not registered and there is an authentication
      failure, then a Drop/Auth-Failure action is
      returned. If either of these actions results as a temporary state
      in policy or authentication, then a Send-Map-Request action with a
      1-minute TTL <bcp14>MAY</bcp14> be returned to allow the requester to retry the
      Map-Request.</t>
        <t> If any of the registered ETRs for the EID-Prefix have
      requested proxy reply service, then the Map-Server answers the
      request instead of forwarding it. It returns a Map-Reply with
      the EID-Prefix, RLOCs, and other information learned through the
      registration process.</t>
        <t> If none of the ETRs have requested proxy reply service, then
      the Map-Server re-encapsulates and forwards the resulting
      Encapsulated Map-Request to one of the registered ETRs. It does
      not otherwise alter the Map-Request, so any Map-Reply sent by
      the ETR is returned to the RLOC in the Map-Request, not to the
      Map-Server. Unless also acting as a Map-Resolver, a Map-Server
      should never receive Map-Replies; any such messages <bcp14>SHOULD</bcp14> be
      discarded without response, perhaps accompanied by the logging
      of a diagnostic message if the rate of Map-Replies is suggestive
      of malicious traffic.</t>
      </section>
      <section anchor="mr-processing" numbered="true" toc="default">
        <name>Map-Resolver Processing</name>
        <t> Upon receipt of an Encapsulated Map-Request, a Map-Resolver
      decapsulates the enclosed message and then searches for the
      requested EID in its local database of mapping entries
      (statically configured or learned from associated ETRs if the
      Map-Resolver is also a Map-Server offering proxy reply
      service). If it finds a matching entry, it returns a LISP
      Map-Reply with the known mapping.</t>
        <t> If the Map-Resolver does not have the mapping entry and if
      it can determine that the EID is not in the mapping database
      (for example, if LISP-ALT is used, the Map-Resolver will have an
      ALT forwarding table that covers the full EID space), it
      immediately returns a Negative Map-Reply with action code
      "Natively-Forward" and a 15&nbhy;minute TTL.  To minimize the
      number of negative cache entries needed by an ITR, the
      Map-Resolver <bcp14>SHOULD</bcp14> return the least-specific prefix that both
      matches the original query and does not match any EID-Prefix
      known to exist in the LISP-capable infrastructure.</t>
        <t> If the Map-Resolver does not have sufficient information to
      know whether the EID exists, it needs to forward the Map-Request
      to another device that has more information about the EID being
      requested. To do this, it forwards the unencapsulated
      Map-Request, with the original ITR RLOC as the source, to the
      mapping database system.  Using LISP-ALT, the Map-Resolver is
      connected to the ALT network and sends the Map-Request to the
      next ALT hop learned from its ALT BGP neighbors. The
      Map-Resolver does not send any response to the ITR; since the
      source RLOC is that of the ITR, the ETR or Map-Server that
      receives the Map-Request over the ALT and responds will do so
      directly to the ITR.</t>
        <section numbered="true" toc="default">
          <name>Anycast Operation</name>
          <t> A Map-Resolver can be set up to use "anycast", where the
        same address is assigned to multiple Map-Resolvers and is
        propagated through IGP routing, to facilitate the use of a
        topologically close Map-Resolver by each ITR.</t>
          <t> ETRs <bcp14>MAY</bcp14> have anycast RLOC addresses that are registered
        as part of their RLOC-Set to the Mapping System.  However,
        registrations <bcp14>MUST</bcp14> use their unique RLOC addresses, distinct
        authentication keys, or different xTR-IDs to identify security associations with the
        Map-Servers.</t>
        </section>
      </section>
    </section>
    <section numbered="true" toc="default">
      <name>Security Considerations</name>
      <t>A LISP threat analysis can be found in <xref target="RFC7835" format="default"/>. Here, we highlight security
    considerations that apply when LISP is deployed in environments
    such as those specified in <xref target="soa" format="default"/>, where the
    following assumptions hold:</t>
      <ol spacing="normal" type="1">
	<li>The Mapping System is secure and trusted, and for the purpose
      of these security considerations, the Mapping System is considered
      as one trusted element.</li>
        <li>The ETRs have a preconfigured trust relationship with the Mapping
     System, including some form of shared secret.  The Mapping
     System is aware of which EIDs an ETR can advertise. How
      those keys and mappings are established is out of scope for
      this document.</li>
        <li>LISP-SEC <xref target="RFC9303" format="default"/> <bcp14>MUST</bcp14> be
      implemented. Network operators should carefully weigh how the
      LISP-SEC threat model applies to their particular use case or
      deployment.  If they decide to ignore a particular
      recommendation, they should make sure the risk associated with
      the corresponding threats is well understood.</li>
      </ol>
      <t>The Map-Request/Map-Reply message exchange can be exploited by
    an attacker to mount DoS and/or amplification attacks. Attackers
    can send Map-Requests at high rates to overload LISP nodes and
    increase the state maintained by such nodes or consume CPU
    cycles. Such threats can be mitigated by systematically applying
    filters and rate limiters.</t>
      <t>The Map-Request/Map-Reply message exchange can also be exploited to inject
    forged mappings directly into the ITR EID-to-RLOC Map-Cache. This
    can lead to traffic being redirected to the attacker; see further
    details in <xref target="RFC7835" format="default"/>. In addition, valid ETRs in
    the system can perform overclaiming attacks. In this case,
    attackers can claim to own an EID-Prefix that is larger than the
    prefix owned by the ETR. Such attacks can be addressed by using
    LISP-SEC <xref target="RFC9303" format="default"/>. The LISP-SEC protocol
    defines a mechanism for providing origin authentication,
    integrity protection, and prevention of
    'man-in-the-middle' and 'prefix overclaiming'
    attacks on the Map-Request/Map-Reply exchange. In addition, and
    while beyond the scope of securing an individual Map-Server or
    Map-Resolver, it should be noted that LISP-SEC can be complemented
    by additional security mechanisms defined by the Mapping System
    infrastructure. For instance, BGP-based LISP-ALT <xref target="RFC6836" format="default"/> can take advantage of standards work on adding
    security to BGP, while LISP-DDT <xref target="RFC8111" format="default"/> defines
    its own additional security mechanisms.</t>
      <t>To publish an authoritative EID-to-RLOC mapping with a
    Map-Server using the Map-Register message, an ETR includes
    Authentication Data that is a MAC of the entire message using a
    key derived from the pre-shared secret. An implementation <bcp14>SHOULD</bcp14> support
	HMAC-SHA256-128+HKDF-SHA256 <xref target="RFC5869" format="default"/>. The Map-Register
	message includes protection against replay
    attacks by a man in the middle. However, there is a potential attack where a compromised ETR could overclaim
    the prefix it owns and successfully register it on its
    corresponding Map-Server. To mitigate this, as noted in <xref target="reg" format="default"/>, a Map-Server <bcp14>MUST</bcp14> verify that all EID-Prefixes
    registered by an ETR match the configuration stored on the
    Map-Server.</t>
      <t>Deployments concerned about manipulations of Map-Request and
    Map-Reply messages and malicious ETR EID-Prefix overclaiming <bcp14>MUST</bcp14>
    drop LISP control plane messages that do not contain LISP-SEC
    material (S-bit, EID-AD, OTK-AD, PKT-AD). See <xref target="RFC9303" sectionFormat="of" section="3"/> for definitions of "EID-AD", "OTK-AD", and "PKT-AD".</t>
      <t>Mechanisms to encrypt, support privacy, and prevent
      eavesdropping and packet tampering for messages
      exchanged between xTRs, between xTRs and the Mapping System, and between nodes that
      make up the Mapping System <bcp14>SHOULD</bcp14> be deployed. Examples of this are DTLS <xref target="RFC9147" format="default"/> or
    "lisp-crypto" <xref target="RFC8061" format="default"/>.</t>
    </section>
    <section numbered="true" toc="default">
      <name>Privacy Considerations</name>
      <t>As noted by <xref target="RFC6973" format="default"/>, privacy is a complex issue
    that greatly depends on the specific protocol use case and
    deployment. As noted in <xref target="RFC9300" sectionFormat="of" section="1.1"/>, LISP focuses on use cases
    where entities communicate over the public Internet while keeping
    separate addressing and topology. Here, we detail the
    privacy threats introduced by the LISP control plane; the analysis
    is based on the guidelines detailed in <xref target="RFC6973" format="default"/>.</t>
      <t>LISP can use long-lived identifiers (EIDs) that survive
    mobility events. Such identifiers bind to the RLOCs of the nodes.
    The RLOCs represent the topological location with respect to the
    specific LISP deployments. In addition, EID-to-RLOC mappings are
    typically considered public information within the LISP
    deployment when control plane messages are not encrypted and can
    be eavesdropped while Map-Request messages are sent to the
    corresponding Map-Resolvers or Map-Register messages to
    Map-Servers.</t>
      <t>In this context, attackers can correlate the EID with the RLOC
    and track the corresponding user topological location and/or
    mobility. This can be achieved by off-path attackers, if they are
    authenticated, by querying the Mapping System. Deployments
    concerned about this threat can use access control lists or stronger
    authentication mechanisms <xref target="I-D.ietf-lisp-ecdsa-auth" format="default"/> in
    the Mapping System to make sure that only authorized users can
    access this information (data minimization). Use of ephemeral EIDs
    <xref target="I-D.ietf-lisp-eid-anonymity" format="default"/> to achieve anonymity is
    another mechanism to lessen persistency and identity tracking.</t>
    </section>

    <section numbered="true" toc="default">
      <name>Changes Related to RFCs 6830 and 6833</name>
      <t>For implementation considerations, the following major changes have
    been made to this document since <xref target="RFC6830" format="default"/> and <xref target="RFC6833" format="default"/> were published:</t>

      <ul spacing="normal">
        <li>The 16-bit 'Key ID' field of the Map-Register and Map-Notify messages as defined in <xref target="RFC6830" format="default"/> has been
      split into an 8-bit 'Key ID' field and an 8-bit 'Algorithm ID' field.  Note that this change also applies to the Map-Notify-Ack message defined by this document. See Sections&nbsp;<xref target="MAPREG" format="counter"/> and <xref target="MAP-NOTIF-MAP-NOTIF-ACK" format="counter"/>.</li>
        <li>This document defines a Map-Notify-Ack message to provide
      reliability for Map-Notify messages.  Any receiver of a
      Map-Notify message must respond with a Map-Notify-Ack
      message. Map-Servers who are senders of Map-Notify messages
      must queue the Map-Notify contents until they receive a
      Map-Notify-Ack with the nonce used in the Map-Notify
      message. Note that implementations for Map-Notify-Ack support
      already exist and predate this document.</li>
        <li>This document has incorporated the codepoint for the
      Map-Referral message from the LISP-DDT specification <xref target="RFC8111" format="default"/> to indicate that a Map-Server must send the
      final Map-Referral message when it participates in the LISP-DDT
      Mapping System procedures.</li>
        <li>Bits L and D have been added to the
      Map-Request message. See <xref target="MAPREQ" format="default"/> for details.</li>
        <li>Bits S, I, E, T, a, R, and M have been added to the
      Map-Register message. See <xref target="MAPREG" format="default"/> for details.</li>
        <li>The nonce and the Authentication Data in the Map-Register message
    each behave differently; see  <xref target="MAPREG" format="default"/> for details.</li>
        <li>This document adds two new action values that are in an
      EID-Record that appears in Map-Reply, Map-Register, Map-Notify,
      and Map-Notify-Ack messages. These new action values are Drop/Policy-Denied and
      Drop/Auth-Failure. See <xref target="MR-FORMAT" format="default"/> for details.</li>
      </ul>
    </section>
    <section numbered="true" toc="default">
      <name>IANA Considerations</name>
      <t>This section provides guidance to IANA regarding registration of values related to this
    LISP control plane specification, in accordance with <xref target="RFC8126" format="default">BCP 26</xref>.</t>

      <ul spacing="normal">
        <li>LISP IANA registry allocations should not be made for
      purposes unrelated to LISP routing or transport protocols.</li>
        <li>The following policies are used here with the meanings
      defined in <xref target="RFC8126" format="default">BCP 26</xref>: "Specification Required", "IETF Review",
      "Experimental Use", and "First Come First Served".</li>
      </ul>

      <t>There are three namespaces (listed in the sub-sections below) in
    LISP that have been registered (see <xref target="RFC9299" format="default"/>.</t>
      <section numbered="true" toc="default">
        <name>LISP UDP Port Numbers</name>

        <t>IANA allocated UDP port number 4342 for the
	  LISP control plane. IANA has updated the description for UDP
	  port 4342 to reflect the following:</t>
<table align="center">
  <thead>
    <tr>
      <th>Service Name</th>
      <th>Port Number</th>    
      <th>Transport Protocol</th>   
      <th>Description</th>
      <th>Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>lisp-control</td>      
      <td>4342</td>    
      <td>udp</td>              
      <td>LISP Control Packets</td>
      <td>RFC 9301</td>
    </tr>
  </tbody>
</table>
      </section>
      <section numbered="true" toc="default">
        <name>LISP Packet Type Codes</name>
        <t>IANA is now authoritative for LISP
      Packet Type definitions, so they have replaced the registry 
      references to <xref target="RFC6830" format="default"/> with references to this document.</t>
        <t>Based on deployment experience related to <xref target="RFC6830" format="default"/>,
      the Map-Notify-Ack message (message type 5) is defined in this
      document. IANA has registered it in the "LISP
      Packet Types" registry.</t>
<table align="center">
  <thead>
    <tr>
      <th>Message</th>                 
      <th>Code</th>          
      <th>Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LISP Map-Notify-Ack</td>  
      <td>5</td>               
      <td>RFC 9301</td>
    </tr>
  </tbody>
</table>
      </section>
      <section anchor="act-iana" numbered="true" toc="default">
        <name>LISP Map-Reply EID-Record Action Codes</name>
        <t>New ACT values can be allocated through IETF Review or IESG
      Approval. Four values have already been allocated by <xref target="RFC6830" format="default"/>. IANA has replaced the reference pointing to <xref target="RFC6830" format="default"/> to point to this document.  This specification changes the Action name
      of value 3 from "Drop" to "Drop/No-Reason".  It also adds the following 
      new ACT values.</t>
        <table align="center">
          <name>LISP Map-Reply Action Values</name>
          <thead>
            <tr>
              <th align="left">Value</th>
              <th align="left">Action</th>
              <th align="left">Description</th>
              <th align="left">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">4</td>
              <td align="left">Drop/Policy-Denied</td>
              <td align="left">A packet matching this Map-Cache entry is dropped because
        the target EID is policy-denied by the xTR or the Mapping
        System.</td>
              <td align="left">RFC 9301</td>
            </tr>
            <tr>
              <td align="left">5</td>
              <td align="left">Drop/Auth-Failure</td>
              <td align="left">A packet matching this Map-Cache entry is dropped because the
        Map-Request for the target EID fails an authentication check
        by the xTR or the Mapping System.</td>
              <td align="left">RFC 9301</td>
            </tr>
          </tbody>
        </table>
        <t>In addition, LISP has a number of flag fields and reserved
      fields, such as the flags of the LISP header fields <xref target="RFC9300" format="default"/>. New bits for flags in
      these fields can be implemented after IETF Review or IESG
      Approval, but these need not be managed by IANA.</t>
      </section>
      <section anchor="IANA" numbered="true" toc="default">
        <name>LISP Address Type Codes</name>
      <t>LISP Canonical Address Format (LCAF) <xref target="RFC8060" format="default"/>
      has an 8-bit Type field that defines LISP-specific encodings for AFI
      value 16387. LCAF encodings are used for specific use cases
      where different address types for EID-Records and RLOC-Records
      are required.</t>
        <t>The "LISP Canonical Address Format (LCAF)
      Types" registry is used for LCAF types. The registry for LCAF types uses
      the Specification Required policy <xref target="RFC8126" format="default"/>. Initial values for the registry as well as
      further information can be found in <xref target="RFC8060" format="default"/>.</t>
        <t>Therefore, there is no longer a need for the "LISP Address Type
      Codes" registry requested by <xref target="RFC6830" format="default"/>. Per this document, 
      the registry has been closed.</t>
      </section>
      <section anchor="KEYS" numbered="true" toc="default">
        <name>LISP Algorithm ID Numbers</name>
        <t>In <xref target="RFC6830" format="default"/>, a request for a "LISP Key ID
      Numbers" registry was submitted. Per this document, IANA has renamed the
      registry to "LISP Algorithm ID Numbers" and listed this document as the registry reference.</t>
        <t>The following Algorithm ID values are defined by this
      specification, as used in any packet type that references an
      'Algorithm ID' field:</t>
<table align="center">
  <thead>
    <tr>
      <th>Name</th>                        
      <th>Number</th>    
      <th>MAC</th>        
      <th>KDF</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>None</td>
      <td>0</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <td>HMAC-SHA-1-96-None</td>
      <td>1</td>
      <td><xref target="RFC2404"/></td>
      <td>None</td>
    </tr>
    <tr>
      <td>HMAC-SHA-256-128-None</td>
      <td>2</td>	
      <td><xref target="RFC4868"/></td>
      <td>None</td>
    </tr>
    <tr> 
      <td>HMAC-SHA256-128+HKDF-SHA256</td>
      <td>3</td>
      <td><xref target="RFC4868"/></td>
      <td><xref target="RFC4868"/></td>
    </tr>
  </tbody>
</table>
        <t>Number values are in the range of 0 to 255. 
      Values are assigned on a First Come First Served basis.</t>
      </section>
      <section anchor="BITS" numbered="true" toc="default">
        <name>LISP Bit Flags</name>
        <t>This document asks IANA to create a registry for allocation
      of bits in several headers of the LISP control plane, namely in
      Map-Request messages, Map-Reply messages, Map-Register messages, and Encapsulated Control Messages. Bit allocations are also requested for
      EID-Records and RLOC-Records.  The registry created should
      be named "LISP Control Plane Header Bits".  A subregistry
      needs to be created per each message and EID-Record. The name of each
      subregistry is indicated below, along with its format
      and allocation of bits defined in this document.  Any additional
      bit allocations require a specification, in accordance with policies defined in <xref target="RFC8126" format="default"/>.</t>
        <t>Subregistry: Map-Request Header Bits (<xref target="NONCE" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Type=1 |A|M|P|S|p|s|R|R|  Rsvd   |L|D|   IRC   | Record Count  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP Map-Request Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">A</td>
              <td align="left">Map-Request-A</td>
              <td align="left">4</td>
              <td align="left">Authoritative Bit</td>
            </tr>
            <tr>
              <td align="left">M</td>
              <td align="left">Map-Request-M</td>
              <td align="left">5</td>
              <td align="left">Map Data Present Bit</td>
            </tr>
            <tr>
              <td align="left">P</td>
              <td align="left">Map-Request-P</td>
              <td align="left">6</td>
              <td align="left">RLOC-Probe Request Bit</td>
            </tr>
            <tr>
              <td align="left">S</td>
              <td align="left">Map-Request-S</td>
              <td align="left">7</td>
              <td align="left">Solicit Map-Request (SMR)
        Bit</td>
            </tr>
            <tr>
              <td align="left">p</td>
              <td align="left">Map-Request-p</td>
              <td align="left">8</td>
              <td align="left">Proxy-ITR Bit</td>
            </tr>
            <tr>
              <td align="left">s</td>
              <td align="left">Map-Request-s</td>
              <td align="left">9</td>
              <td align="left">Solicit Map-Request Invoked
        Bit</td>
            </tr>
            <tr>
              <td align="left">L</td>
              <td align="left">Map-Request-L</td>
              <td align="left">17</td>
              <td align="left">Local xTR Bit</td>
            </tr>
            <tr>
              <td align="left">D</td>
              <td align="left">Map-Request-D</td>
              <td align="left">18</td>
              <td align="left">Don't Map-Reply Bit</td>
            </tr>
          </tbody>
        </table>
        <t>Subregistry: Map-Reply Header Bits (<xref target="MR-FORMAT" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Type=2 |P|E|S|          Reserved               | Record Count  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP Map-Reply Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">P</td>
              <td align="left">Map-Reply-P</td>
              <td align="left">4</td>
              <td align="left">RLOC-Probe Bit</td>
            </tr>
            <tr>
              <td align="left">E</td>
              <td align="left">Map-Reply-E</td>
              <td align="left">5</td>
              <td align="left">Echo-Nonce Capable Bit</td>
            </tr>
            <tr>
              <td align="left">S</td>
              <td align="left">Map-Reply-S</td>
              <td align="left">6</td>
              <td align="left">Security Bit</td>
            </tr>
          </tbody>
        </table>
        <t>Subregistry: Map-Register Header Bits (<xref target="MAPREG" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Type=3 |P|S|I|        Reserved       |E|T|a|R|M| Record Count  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP Map-Register Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">P</td>
              <td align="left">Map-Register-P</td>
              <td align="left">4</td>
              <td align="left">Proxy Map-Reply Bit</td>
            </tr>
            <tr>
              <td align="left">S</td>
              <td align="left">Map-Register-S</td>
              <td align="left">5</td>
              <td align="left">LISP-SEC Capable Bit</td>
            </tr>
            <tr>
              <td align="left">I</td>
              <td align="left">Map-Register-I</td>
              <td align="left">6</td>
              <td align="left">xTR-ID Present Bit</td>
            </tr>
          </tbody>
        </table>
        <t>Subregistry: Encapsulated Control Message (ECM) Header Bits
      (<xref target="encap-mr" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Type=8 |S|D|E|M|            Reserved                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP Encapsulated Control Message (ECM) Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">S</td>
              <td align="left">ECM-S</td>
              <td align="left">4</td>
              <td align="left">Security Bit</td>
            </tr>
            <tr>
              <td align="left">D</td>
              <td align="left">ECM-D</td>
              <td align="left">5</td>
              <td align="left">LISP-DDT Bit</td>
            </tr>
            <tr>
              <td align="left">E</td>
              <td align="left">ECM-E</td>
              <td align="left">6</td>
              <td align="left">Forward to ETR Bit</td>
            </tr>
            <tr>
              <td align="left">M</td>
              <td align="left">ECM-M</td>
              <td align="left">7</td>
              <td align="left">Destined to Map-Server Bit</td>
            </tr>
          </tbody>
        </table>
        <t>Subregistry: EID-Record Header Bits (<xref target="MR-FORMAT" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Locator Count | EID mask-len  | ACT |A|      Reserved         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP EID-Record Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">A</td>
              <td align="left">EID-Record-A</td>
              <td align="left">19</td>
              <td align="left">Authoritative Bit</td>
            </tr>
          </tbody>
        </table>
        <t>Subregistry: RLOC-Record Header Bits (<xref target="MR-FORMAT" format="default"/>):</t>
<artwork name="" type="" align="left" alt=""><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Unused Flags     |L|p|R|           Loc-AFI             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        <table align="center">
          <name>LISP RLOC-Record Header Bits</name>
          <thead>
            <tr>
              <th align="left">Spec Name</th>
              <th align="left">IANA Name</th>
              <th align="left">Bit Position</th>
              <th align="left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">L</td>
              <td align="left">RLOC-Record-L</td>
              <td align="left">13</td>
              <td align="left">Local RLOC Bit</td>
            </tr>
            <tr>
              <td align="left">p</td>
              <td align="left">RLOC-Record-p</td>
              <td align="left">14</td>
              <td align="left">RLOC-Probe Reply Bit</td>
            </tr>
            <tr>
              <td align="left">R</td>
              <td align="left">RLOC-Record-R</td>
              <td align="left">15</td>
              <td align="left">RLOC Reachable Bit</td>
            </tr>
          </tbody>
        </table>
      </section>
    </section>
  </middle>
  <back>

<displayreference target="I-D.ietf-lisp-eid-anonymity" to="EID-ANONYMITY"/>
<displayreference target="I-D.ietf-lisp-ecdsa-auth" to="ECDSA-AUTH"/>
<displayreference target="I-D.ietf-lisp-mn" to="LISP-MN"/>
<displayreference target="I-D.ietf-lisp-pubsub" to="LISP-PUBSUB"/>
<displayreference target="I-D.ietf-opsec-icmp-filtering" to="OPSEC-ICMP-FILTER"/>
<displayreference target="I-D.herbert-intarea-ila" to="INTAREA-ILA"/>

    <references>
      <name>References</name>
      <references>
        <name>Normative References</name>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6833.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8126.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8085.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4086.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2404.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4868.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.5869.xml"/>

<reference anchor='RFC9300' target="https://www.rfc-editor.org/info/rfc9300">
<front>
<title>The Locator/ID Separation Protocol (LISP)</title>
<author initials='D' surname='Farinacci' fullname='Dino Farinacci'>
    <organization />
</author>
<author initials='V' surname='Fuller' fullname='Vince Fuller'>
    <organization />
</author>
<author initials='D' surname='Meyer' fullname='David Meyer'>
    <organization />
</author>
<author initials='D' surname='Lewis' fullname='Darrel Lewis'>
    <organization />
</author>
<author initials='A' surname='Cabellos' fullname='Albert Cabellos' role='editor'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9300"/>
<seriesInfo name="DOI" value="10.17487/RFC9300"/>
</reference>

<reference anchor='RFC9302' target="https://www.rfc-editor.org/info/rfc9302">
<front>
<title>Locator/ID Separation Protocol (LISP) Map-Versioning</title>
<author initials='L' surname='Iannone' fullname='Luigi Iannone'>
    <organization />
</author>
<author initials='D' surname='Saucez' fullname='Damien Saucez'>
    <organization />
</author>
<author initials='O' surname='Bonaventure' fullname='Olivier Bonaventure'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9302"/>
<seriesInfo name="DOI" value="10.17487/RFC9302"/>
</reference>

<reference anchor='RFC9303' target="https://www.rfc-editor.org/info/rfc9303">
<front>
<title>Locator/ID Separation Protocol Security (LISP-SEC)</title>
<author initials='F' surname='Maino' fullname='Fabio Maino'>
    <organization />
</author>
<author initials='V' surname='Ermagan' fullname='Vina Ermagan'>
    <organization />
</author>
<author initials='A' surname='Cabellos' fullname='Albert Cabellos'>
    <organization />
</author>
<author initials='D' surname='Saucez' fullname='Damien Saucez'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9303"/>
<seriesInfo name="DOI" value="10.17487/RFC9303"/>
</reference>

<reference anchor='RFC9304' target="https://www.rfc-editor.org/info/rfc9304">
<front>
<title>Locator/ID Separation Protocol (LISP): Shared Extension Message and IANA Registry for Packet Type Allocations</title>
<author initials='M' surname='Boucadair' fullname='Mohamed Boucadair'>
    <organization />
</author>
<author initials='C' surname='Jacquenet' fullname='Christian Jacquenet'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9304"/>
<seriesInfo name="DOI" value="10.17487/RFC9304"/>
</reference>

      </references>
      <references>
        <name>Informative References</name>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4984.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6973.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8111.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.9147.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6836.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8378.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8060.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8061.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6837.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6831.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6830.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.1071.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.1035.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6832.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7348.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7835.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2890.xml"/>
        <xi:include href="https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml"/>
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-lisp-eid-anonymity.xml"/>
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-lisp-ecdsa-auth.xml"/>
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-lisp-mn.xml"/>

<reference anchor="EID-MOBILITY">
   <front>
      <title>LISP L2/L3 EID Mobility Using a Unified Control Plane</title>
      <author initials="M" surname="Portoles" fullname="Marc Portoles Comeras">
	 <organization>Cisco Systems</organization>
      </author>
      <author initials="V" surname="Ashtaputre" fullname="Vrushali Ashtaputre">
	 <organization>Cisco Systems</organization>
      </author>
      <author initials="F" surname="Maino" fullname="Fabio Maino">
	 <organization>Cisco Systems</organization>
      </author>
      <author initials="V" surname="Moreno" fullname="Victor Moreno">
	 <organization>Google LLC</organization>
      </author>
      <author initials="D" surname="Farinacci" fullname="Dino Farinacci">
	 <organization>lispers.net</organization>
      </author>
      <date month="July" day="10" year="2022" />
   </front>
   <seriesInfo name="Internet-Draft" value="draft-ietf-lisp-eid-mobility-10" />
</reference>


<reference anchor='RFC9305' target="https://www.rfc-editor.org/info/rfc9305">
<front>
<title>Locator/ID Separation Protocol (LISP) Generic Protocol Extension</title>
<author initials='F' surname='Maino' fullname='Fabio Maino' role='editor'>
    <organization />
</author>
<author initials='J' surname='Lemon' fullname='Jennifer Lemon'>
    <organization />
</author>
<author initials='P' surname='Agarwal' fullname='Puneet Agarwal'>
    <organization />
</author>
<author initials='D' surname='Lewis' fullname='Darrel Lewis'>
    <organization />
</author>
<author initials='M' surname='Smith' fullname='Michael Smith'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9305"/>
<seriesInfo name="DOI" value="10.17487/RFC9305"/>
</reference>

<reference anchor="NVO3-VXLAN-GPE">
   <front>
      <title>Generic Protocol Extension for VXLAN (VXLAN-GPE)</title>
<author initials='F' surname='Maino' fullname='Fabio Maino' role="editor">
<organization />
</author>
<author initials='L' surname='Kreeger' fullname='Larry Kreeger' role="editor">
<organization />
</author>
<author initials='U' surname='Elzur' fullname='Uri Elzur' role="editor">
<organization />
</author>
      <date month="September" day="22" year="2021" />
   </front>
   <seriesInfo name="Internet-Draft" value="draft-ietf-nvo3-vxlan-gpe-12" />
</reference>

<reference anchor='RFC9299' target="https://www.rfc-editor.org/info/rfc9299">
<front>
<title>An Architectural Introduction to the Locator/ID Separation Protocol (LISP)</title>
<author initials='A' surname='Cabellos' fullname='Albert Cabellos'>
    <organization />
</author>
<author initials='D' surname='Saucez' fullname='Damien Saucez' role='editor'>
    <organization />
</author>
<date month='October' year='2022' />
</front>
<seriesInfo name="RFC" value="9299"/>
<seriesInfo name="DOI" value="10.17487/RFC9299"/>
</reference>

        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-lisp-pubsub.xml"/>
        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.ietf-opsec-icmp-filtering.xml"/>

        <xi:include href="https://datatracker.ietf.org/doc/bibxml3/reference.I-D.herbert-intarea-ila.xml"/>

        <reference anchor="AFN" target="http://www.iana.org/assignments/address-family-numbers/">
          <front>
            <title>Address Family Numbers</title>
            <author>
              <organization>IANA</organization>
            </author>
          </front>
        </reference>
        <reference anchor="GTP-3GPP" target="https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=1699">
          <front>
            <title>General Packet Radio System (GPRS) Tunnelling Protocol
        User Plane (GTPv1-U)</title>
            <author>
              <organization>3GPP</organization>
            </author>
            <date month="June" year="2022"/>
          </front>
          <refcontent>TS.29.281</refcontent> 
        </reference>
      </references>
    </references>
    <section numbered="false" toc="default">
      <name>Acknowledgments</name>
      <t>The original authors would like to thank <contact fullname="Greg Schudel"/>, <contact fullname="Darrel Lewis"/>,
    <contact fullname="John Zwiebel"/>, <contact fullname="Andrew Partan"/>, <contact fullname="Dave Meyer"/>, <contact fullname="Isidor Kouvelas"/>, <contact fullname="Jesper
    Skriver"/>,  and members of the lisp@ietf.org mailing
    list for their feedback and helpful suggestions.</t>
      <t> Special thanks are due to <contact fullname="Noel Chiappa"/> for his extensive work
    and thought about caching in Map-Resolvers.</t>
      <t>The current authors would like to give a sincere thank you to
    the people who help put LISP on the Standards Track in the IETF.  They
    include <contact fullname="Joel Halpern"/>, <contact fullname="Luigi Iannone"/>, <contact fullname="Deborah Brungard"/>, <contact fullname="Fabio
    Maino"/>, <contact fullname="Scott Bradner"/>, <contact fullname="Kyle Rose"/>, <contact fullname="Takeshi Takahashi"/>, <contact fullname="Sarah Banks"/>,
    <contact fullname="Pete Resnick"/>, <contact fullname="Colin Perkins"/>, <contact fullname="Mirja Kühlewind"/>, <contact fullname="Francis Dupont"/>,
    <contact fullname="Benjamin Kaduk"/>, <contact fullname="Eric Rescorla"/>, <contact fullname="Alvaro Retana"/>, <contact fullname="Alexey Melnikov"/>,
    <contact fullname="Alissa Cooper"/>, <contact fullname="Suresh Krishnan"/>, <contact fullname="Alberto Rodriguez-Natal"/>, <contact fullname="Vina
    Ermagan"/>, <contact fullname="Mohamed Boucadair"/>, <contact fullname="Brian Trammell"/>, <contact fullname="Sabrina Tanamal"/>, and
    <contact fullname="John Drake"/>. The contributions they offered greatly added to the
    security, scale, and robustness of the LISP architecture and
    protocols.</t>
    </section>
  </back>
</rfc>
